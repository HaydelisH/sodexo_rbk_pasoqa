/*! Rubrika.LogicJS - v1.0.0 - 18/04/2019
* Copyright (c) 2019 Ingenieria Solem */

window.logic=function(){"use strict";return{current:{process:"",step:0,language:"",sessionId:null},roles:[],loadStep:function(e,n,t,o){var i={text:text[t][e]["step"+n],data:o};if(console.log("Loading: "+e+"/step"+n,i),$("#body-content").html(Handlebars.templates[e+"/step"+n](i)),logic.current.process=e,logic.current.step=n,logic.current.language=t,1==n){$("#dot-container").empty();for(var a=1;a<=logic[e].steps;a++)$("#dot-container").append('<span id="dot-'+a+'" class="dot">&#9679;</span>')}$(".dot").attr("selected",!1),$("#dot-"+n).attr("selected",!0),logic[e][n].begin(o)},nextStep:function(e){logic.loadStep(logic.current.process,logic.current.step+1,logic.current.language,e)},validateCurrent:function(){return logic[logic.current.process][logic.current.step].validate()},getText:function(){return text[logic.current.language][logic.current.process]["step"+logic.current.step]},handleError:function(e){var n=text[logic.current.language].errors,t="";t=e.responseJSON?401===e.status||403===e.status?n.AUTH:n.PROCESS:n.COMM,$("#error-message").text(t),$("#error-container").removeClass("d-none"),$("#loading").addClass("d-none")},getRoles:function(){var e={code:"PERSON",type:"GET",subtype:"ROLE",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:1549887978384,client:{operationId:config.operationId,companyId:config.companyId,machineId:"",username:"",password:""},data:{digitalIdentity:{identityDocuments:[config.operator.identityDocument]}}},n=config.baseUrl+"/api/v1/role/get";$.ajax({method:"POST",contentType:"application/json",dataType:"json",crossDomain:!0,url:n,headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId},data:JSON.stringify(e),async:!1}).done(function(e){console.log("Success:",e),logic.roles=e.data.digitalIdentity.roles}).fail(function(e,n,t){console.log("Error getRoles"),console.log(e);var o=text[window.config.language].errors,i="";if(e.responseJSON){if(401===e.status||403===e.status)return void logic.loadStep("login",1,window.config.language,{});i=404==e.status?o.OPERATOR_NO_DATA:o.PROCESS}else i=o.COMM;var a={action:config.action,data:null,operator:{sessionId:window.config.operator.sessionId},numError:e.status,msError:i};window.opener.callback(a)}).always(function(){})},validateRole:function(e){for(var n=0;n<logic.roles.length;n++)if(logic.roles[n].code==e)return!0;return!1},validateIdentityDocument:function(e){var n=!0;return e&&(e.type||0!=e.type.length)&&(e.countryCode||0!=e.countryCode.length)&&(e.personalNumber||0!=e.personalNumber.length)&&Validator.PersonId[e.countryCode][e.type].validate(e.personalNumber)||(n=!1),n},init:function(){if($('[data-toggle="tooltip"]').tooltip(),window.opener&&window.opener.getParams&&(window.config=window.opener.getParams(),window.config)){window.config.language||(window.config.language="ES");var e=!0,n=0,t="";if(window.config.digitalIdentity&&window.config.digitalIdentity.identityDocuments&&0<window.config.digitalIdentity.identityDocuments.length?logic.validateIdentityDocument(window.config.digitalIdentity.identityDocuments[0])?window.config.operator.identityDocument?logic.validateIdentityDocument(window.config.operator.identityDocument)||(n=1101,t=text[window.config.language].errors.INVALID_OPERATOR_DATA,e=!1):(n=1102,t=text[window.config.language].errors.INVALID_OPERATOR_DATA,e=!1):(n=1001,t=text[window.config.language].errors.INVALID_PERSON_DATA,e=!1):(n=1002,t=text[window.config.language].errors.INVALID_PERSON_DATA,e=!1),!e){var o={action:config.action,data:null,operator:{sessionId:window.config.operator.sessionId},numError:n,msError:t};return void window.opener.callback(o)}if(window.config.retry?(window.config.retry.pin||(window.config.retry.pin=3),window.config.retry.fingerprint||(window.config.retry.fingerprint=3)):window.config.retry={pin:3,fingerprint:3},moment.locale(window.config.language),window.setInterval(function(){$("#datetime").text(moment().format("LLLL"))},1e3),$("#datetime").text(moment().format("LLLL")),$(".secure-tx-text").text(text[window.config.language].general.secureTx),$("#wait-text").text(text[window.config.language].general.wait),$("#btnNextStep").text(text[window.config.language].general.next),$("#btnClose").text(text[window.config.language].general.close).click(function(e){e.preventDefault();var n={action:config.action,data:null,numError:100,msError:text[window.config.language].errors.CLOSED};window.opener.callback(n)}),window.logic.websocket.connect(),!window.config.operator.sessionId)return void(window.config.operator.identityDocument.personalNumber==window.config.digitalIdentity.identityDocuments[0].personalNumber?(logic.current.sessionId=window.config.sessionId,console.log("logic mismo usuario"),"CREATE"==window.config.action?logic.loadStep("register",1,window.config.language,{}):"VERIFY"==window.config.action&&(console.log("logic mismo usuario verify"),logic.loadStep("verify",1,window.config.language,{}))):logic.loadStep("login",1,window.config.language,{}));if(logic.current.sessionId=window.config.operator.sessionId,"CREATE"==window.config.action)return void logic.loadStep("register",1,window.config.language,{});if("VERIFY"==window.config.action)return void logic.loadStep("verify",1,window.config.language,{})}}}}(),$(document).ready(window.logic.init),window.logic||(window.logic={}),window.logic.login={personData:{},loadedParams:!1,countRetry:0,steps:7,1:{begin:function(e){if(logic.current.sessionId=window.config.sessionId,$("#loading").removeClass("d-none"),e.from)return logic.login.personData=e.personData,void logic.nextStep(logic.login.personData);logic.login.loadedParams||logic.login[1].loadDataFromParams(),logic.login[1].getPerson(),$("#btnNextStep").addClass("d-none")},validate:function(){return!0},loadDataFromParams:function(){if(logic.login.loadedParams=!0,config.digitalIdentity.personalData){var e=config.digitalIdentity.personalData;e.dob&&(logic.login.personData.birthdate=e.dob),e.gender&&(logic.login.personData.gender=e.gender),e.surnames&&(logic.login.personData.surnames=e.surnames),e.givenNames&&(logic.login.personData.givennames=e.givenNames)}if(config.digitalIdentity.emailAddresses){var n=config.digitalIdentity.emailAddresses;0<n.length&&(n[0].address&&(logic.login.personData.email=n[0].address),1<n.length&&n[1].address&&(logic.login.personData.email2=n[1].address))}if(config.digitalIdentity.contactPhones){var t=config.digitalIdentity.contactPhones;0<t.length&&t[0].number&&(logic.login.personData.cellphone=t[0].number)}if(logic.login.personData.docType="ID",logic.login.personData.docCountry="CL",config.digitalIdentity.identityDocuments){var o=config.digitalIdentity.identityDocuments;0<o.length&&(o[0].personalNumber&&(logic.login.personData.personId=o[0].personalNumber),o[0].number&&(logic.login.personData.documentId=o[0].number),o[0].type&&(logic.login.personData.docType=o[0].type),o[0].countryCode&&(logic.login.personData.docCountry=o[0].countryCode))}},getPerson:function(){var e={code:"PERSON",type:"GET",subtype:"PERSON",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:1549887978384,client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[config.operator.identityDocument]}}};$.ajax({method:"POST",contentType:"application/json",dataType:"json",crossDomain:!0,url:config.baseUrl+"/api/v1/person/get",headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":config.sessionId},data:JSON.stringify(e)}).done(function(e){logic.login.personData.internalId=e.data.digitalIdentity.personId,logic.login.personData.gender=e.data.digitalIdentity.personalData.gender,logic.login.personData.surnames=e.data.digitalIdentity.personalData.surnames,logic.login.personData.givennames=e.data.digitalIdentity.personalData.givenNames,logic.login.personData.docType=e.data.digitalIdentity.identityDocuments[0].type,logic.login.personData.docCountry=e.data.digitalIdentity.identityDocuments[0].countryCode,logic.login.personData.personId=e.data.digitalIdentity.identityDocuments[0].personalNumber,logic.login.personData.documentId=e.data.digitalIdentity.identityDocuments[0].number,logic.login.personData.personIdFormatted=Formatter.PersonId[logic.login.personData.docCountry][logic.login.personData.docType].format(logic.login.personData.personId);var n=e.data.digitalIdentity.contactPhones,t=e.data.digitalIdentity.emailAddresses;n&&0<n.length&&$.each(n,function(e,n){n.primary&&(logic.login.personData.cellphone=n.number)}),t&&0<t.length&&$.each(t,function(e,n){n.primary?logic.login.personData.email=n.address:logic.login.personData.email2=n.address}),logic.nextStep(logic.login.personData)}).fail(function(e){var n=text[logic.current.language].errors,t="",o=0;e.responseJSON?(o=e.status,t=401===e.status||403===e.status?n.AUTH:404==e.status?n.OPERATOR_NO_DATA:n.PROCESS):(t=n.COMM,o=1e3);var i={action:config.action,data:logic.login.result,numError:o,msError:t};window.opener.callback(i)}).always(function(){})}},2:{begin:function(e){if($("#loading").removeClass("d-none"),config.method)"PIN"==config.method?logic.nextStep(logic.login.personData):"FINGERPRINT"==config.method&&($("#loading").removeClass("d-none"),logic.loadStep("login",5,window.config.language,logic.login.personData));else{if($("#verify-opt-pin").click(function(){logic.nextStep(logic.login.personData)}),$("#verify-opt-finger").click(function(){$("#loading").removeClass("d-none"),logic.loadStep("login",5,window.config.language,logic.login.personData)}).removeClass("d-none"),$("#verify-opt-clave_unica").click(function(){}),$("#verify-opt-facial").click(function(){}),!window.logic.websocket.isConnecting&&window.logic.websocket.isConnect)return void window.setTimeout(window.logic.login[5].begin,1e3,e);$("#loading").addClass("d-none")}},validate:function(){return!0}},3:{begin:function(e){$("footer").removeClass("d-none"),$("main").removeClass("nopadding"),$("#btnNextStep").removeClass("d-none").unbind("click").click(function(e){e.preventDefault(),logic.validateCurrent()&&logic.login[3].validatePin()}),$(".pin").keyup(function(e){var n=null;if(8==e.keyCode)(n=$(".pin")[$(".pin").index(this)-1])&&n.focus();else if(/^[0-9]$/.test(e.key)){if(""!=$(this).val()){var t=$(this).data("nextfocus");t&&$("#"+t).focus()}}else $(this).val("")}),$("#btnForgot").click(function(e){e.preventDefault(),$("#loading").removeClass("d-none"),logic.nextStep(logic.login.personData)}),$("#loading").addClass("d-none")},validate:function(){return!0},validatePin:function(){$("#loading").removeClass("d-none");var t="";$(".pin").each(function(e,n){t+=$(n).val()});var e={code:"PERSON",type:"VERIFY",subtype:"PIN",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:123456,appFlow:{code:"",step:""},client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[config.operator.identityDocument]},authenticationFactors:[{type:"PIN",subtype:"PIN",value:t}]}};$.ajax({url:config.baseUrl+"/api/v1/verify/pin",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(e),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":config.sessionId}}).done(function(e){if(e.data.authenticationResult.authenticated)logic.login.result=e.data.authenticationResult,logic.loadStep("login",6,window.config.language,{personData:logic.login.personData,authentication:logic.login.result});else{if(logic.login.countRetry++,logic.login.countRetry>=window.config.retry.pin)return void logic.loadStep("login",7,window.config.language,{personData:logic.login.personData,success:!1});var n,t=window.config.retry.fingerprint-logic.login.countRetry,o="";o=1==t?window.text[logic.current.language].login.step3.attempsB:t+" "+window.text[logic.current.language].login.step3.attempsA,$("#attemps").removeClass("d-none"),$("#attemps").text(o),$(".pin").val(""),$("#input-pin-1").focus(),n=text[logic.current.language].errors.OPERATOR_NO_AUTH,$("#error-message").text(n),$("#error-container").removeClass("d-none"),$("#loading").addClass("d-none")}}).fail(logic.handleError).always(function(){})}},4:{begin:function(e){var n={code:"PERSON",type:"GET",subtype:"KBA",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:1549887978384,client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[config.operator.identityDocument]},authenticationFactors:[{type:"KBA",subtype:"KBA",questionType:"STATIC"}]}};$.ajax({url:config.baseUrl+"/api/v1/kba/get",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(n),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":config.sessionId}}).done(function(e){var n;e.data.authenticationFactors&&0<e.data.authenticationFactors.length?(logic.login.lastQuestion=atob(e.data.authenticationFactors[0].value),$("#lbl-question").text(atob(e.data.authenticationFactors[0].value))):(n=text[logic.current.language].errors.OPERATOR_NO_DATA,$("#error-message").text(n),$("#error-container").removeClass("d-none"))}).fail(function(e){var n=text[logic.current.language].errors,t="";t=e.responseJSON?401===e.status||403===e.status?n.AUTH:404==e.status?n.OPERATOR_NO_DATA:n.PROCESS:n.COMM,$("#error-message").text(t),$("#error-container").removeClass("d-none")}).always(function(){$("#loading").addClass("d-none")}),$("#btnNextStep").removeClass("d-none").unbind("click").click(function(e){e.preventDefault(),logic.validateCurrent()&&logic.login[4].validateQuestion()})},validateQuestion:function(){var e={code:"PERSON",type:"VERIFY",subtype:"KBA",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:1549887978384,client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[config.operator.identityDocument]},authenticationFactors:[{type:"KBA",subtype:"KBA",questionType:"STATIC",questions:{}}]}};e.data.authenticationFactors[0].questions[logic.login.lastQuestion]={answers:{RESP:$("#input-answer").val()}},$.ajax({url:config.baseUrl+"/api/v1/verify/kba",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(e),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":config.sessionId}}).done(function(e){if(e.data.authenticationResult.authenticated){logic.login.personData=logic.login.personData;var n=Object.assign({backTo:{process:"login",step:3}},logic.login.personData);config.useFingerprint=!1,config.usePin=!0,logic.loadStep("register",2,window.config.language,n)}else $("#error-message").text(text[logic.current.language].errors.QUESTION_MATCH),$("#error-container").removeClass("d-none")}).fail(function(e){var n=text[logic.current.language].errors,t="";t=e.responseJSON?401===e.status||403===e.status?n.AUTH:404==e.status?n.OPERATOR_NO_DATA:n.PROCESS:n.COMM,$("#error-message").text(t),$("#error-container").removeClass("d-none")}).always(function(){$("#loading").addClass("d-none")})},validate:function(){return!0}},5:{begin:function(e){if($("#loading").removeClass("d-none"),window.logic.websocket.isConnect||window.logic.websocket.isConnecting){if(window.logic.websocket.isConnecting)window.setTimeout(window.logic.login[5].begin,1e3,e);else if(!window.logic.websocket.isConnecting&&window.logic.websocket.isConnect){$(".finger-layer").addClass("d-none"),$("#btnNextStep").unbind("click").click(function(e){e.preventDefault(),logic.validateCurrent()&&logic.nextStep({})}),$("#loading").removeClass("d-none"),$("#inFinger").val("2"),$("#btnCapture").click(function(){$(".feedback").removeClass("d-none"),logic.login[5].captureOk=!1,window.logic.websocket.verify(logic.login[5].data,logic.login[5].matching),$("#error-container").addClass("d-none"),$("#btnCapture").addClass("disabled")}),$("#inFinger").on("change",function(){var e="assets/finger/"+$(this).val().toString()+".png";$("#image-swap").attr("src",e)});var n={code:"PERSON",type:"GET",subtype:"FINGERPRINT",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:123456,client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[config.operator.identityDocument]},authenticationFactors:[{type:"FINGERPRINT",subtype:"FINGERPRINT",id:0,minutiaesFormat:"0"}]}};$.ajax({url:config.baseUrl+"/api/v1/fingerprint/get",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(n),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":config.sessionId}}).done(function(e){var n;0==(logic.login[5].data=e).data.authenticationFactors.length?(n=text[logic.current.language].errors.OPERATOR_NO_DATA,$("#error-message").text(n),$("#error-container").removeClass("d-none")):($.each(e.data.authenticationFactors,function(e,n){$("#finger-layer-"+n.id).removeClass("d-none")}),$("#btnCapture").click())}).fail(function(e){var n=text[logic.current.language].errors,t="";t=e.responseJSON?401===e.status||403===e.status?n.AUTH:404==e.status?n.OPERATOR_NO_DATA:n.PROCESS:n.COMM,$("#error-message").text(t),$("#error-container").removeClass("d-none")}).always(function(){$("#loading").addClass("d-none")})}}else{var t={action:config.action,method:"FINGERPRINT",data:logic.login.result,numError:5e3,msError:text[logic.current.language].errors.WS_CONNECTION};window.opener.callback(t)}},validate:function(){return!0},matching:function(e){if($(".feedback").addClass("d-none"),0==e.status.code){$("#loading").removeClass("d-none"),logic.login.result=e.data.authenticationResult;var n={code:"PERSON",type:"VERIFY",subtype:"FINGERPRINT",createdAt:e.createdAt,id:e.id,client:{operationId:config.operationId,companyId:config.companyId,username:"",machineId:e.client.machineId},data:{digitalIdentity:{identityDocuments:[config.operator.identityDocument]},authenticationFactors:[],authenticationResult:e.data.authenticationResult}};$.ajax({url:config.baseUrl+"/api/v1/verify/fingerprint",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(n),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":config.sessionId}}).done(function(e){if(e.data.authenticationResult.authenticated)logic.login.result=e.data.authenticationResult,logic.loadStep("login",6,window.config.language,{personData:logic.login.personData,authentication:logic.login.result});else{if(logic.login.countRetry++,logic.login.countRetry>=window.config.retry.fingerprint)return void logic.loadStep("login",7,window.config.language,{personData:logic.login.personData,success:!1});var n,t=window.config.retry.fingerprint-logic.login.countRetry,o="";o=1==t?window.text[logic.current.language].login.step3.attempsB:t+" "+window.text[logic.current.language].login.step3.attempsA,$("#attemps").removeClass("d-none"),$("#attemps").text(o),n=text[logic.current.language].errors.OPERATOR_NO_AUTH,$("#error-message").text(n),$("#error-container").removeClass("d-none"),$("#loading").addClass("d-none"),$("#btnCapture").removeClass("disabled"),$("#btnCapture").removeClass("d-none")}}).fail(function(e){var n=text[logic.current.language].errors,t="";e.responseJSON?401===e.status||403===e.status?t=n.AUTH:404==e.status?logic.loadStep("register",1,window.config.language,{backTo:{process:"login",step:5}}):t=n.PROCESS:t=n.COMM,$("#error-message").text(t),$("#error-container").removeClass("d-none"),$("#loading").addClass("d-none")}).always(function(){})}else{var t=text[logic.current.language].errors,o="";401===e.status.code||403===e.status.code?o=t.AUTH:404==e.status.code?logic.loadStep("register",1,window.config.language,{backTo:{process:"login",step:5}}):o=t.PROCESS,$("#error-message").text(o),$("#error-container").removeClass("d-none"),$("#btnCapture").removeClass("disabled")}}},6:{begin:function(e){$("#loading").removeClass("d-none"),window.logic.login[6].createSessionId()},validate:function(){return!0},createSessionId:function(){var e={code:"USER",type:"START",subtype:"SESSION",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:1549887978384,client:{operationId:config.operationId,companyId:config.companyId,username:"",password:""},data:{digitalIdentity:{identityDocuments:[config.operator.identityDocument]},authenticationResult:logic.login.result}},n=config.baseUrl+"/api/v1/session/operator";$.ajax({method:"POST",contentType:"application/json",dataType:"json",crossDomain:!0,url:n,headers:{"X-Auth-Token":config.apiKey},data:JSON.stringify(e)}).done(function(e){200==e.status.status.code&&(window.config.operator.sessionId=e.client.token,logic.current.sessionId=e.client.token,logic.nextStep({personData:logic.login.personData,success:!0}))}).fail(function(e,n,t){logic.nextStep({personData:logic.login.personData,success:!1})}).always(function(){})}},7:{begin:function(n){$("#btnFinish").click(function(){if(n.success){if("CREATE"==window.config.action)return void logic.loadStep("register",1,window.config.language,{});if("VERIFY"==window.config.action)return void logic.loadStep("verify",1,window.config.language,{})}else{var e={action:config.action,data:logic.login.result,operator:{sessionId:""},numError:0,msError:""};window.opener.callback(e)}}),$("main").addClass("nopadding"),$("footer").addClass("d-none"),$("#loading").addClass("d-none")},validate:function(){return!0}}},window.logic||(window.logic={}),window.logic.register={personData:{},loadedParams:!1,steps:5,backTo:null,1:{begin:function(e){var n,t;(logic.getRoles(),e.backTo&&(logic.register.backTo=e.backTo),logic.validateRole("CREATE_PERSON")||logic.validateRole("UPDATE_AUTH")||logic.validateRole("UPDATE_PERSON")||logic.validateRole("CREATE_PIN"))?logic.register[1].getPerson():(console.log("no tiene rol"),n=text[logic.current.language].errors.INVALID_ROLE,t={action:config.action,data:null,operator:{sessionId:window.config.operator.sessionId},numError:1e3,msError:n},window.opener.callback(t))},validate:function(){$(".label-error").html("&nbsp");var t=!0;$(".person-data-input").removeClass("error"),$(".person-data-input").each(function(){var e=$(this).val(),n=$(this).data("required");(n=0!=n)&&""==e&&(t=!1,$(this).next("p.label-error").text(text[logic.current.language].errors.REQUIRED),$(this).addClass("error")),logic.register.personData[$(this).data("name")]=e}),logic.register.personData.docType=$("#inputDocType").val(),logic.register.personData.docCountry=$("#inputDocCountry").val(),logic.register.personData.docType||(t=!1),logic.register.personData.docCountry||(t=!1);var e=/^\+?([0-9]{2})\)?[-. ]?([0-9]{1})[-. ]?([0-9]{4})[-. ]?([0-9]{4})$/;$(".phone-input").each(function(){e.test($(this).val())||(t=!1,$(this).next("p.label-error").text(text[logic.current.language].errors.INVALID_FORMAT),$(this).addClass("error"))});var n=/^(([^<>()\[\]\\.,;:\s@']+(\.[^<>()\[\]\\.,;:\s@']+)*)|('.+'))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return $(".email-input").each(function(){var e=$(this).data("required");(e=0!=e)||""!=$(this).val()&&(e=!0),e&&!n.test($(this).val())&&(t=!1,$(this).next("p.label-error").text(text[logic.current.language].errors.INVALID_FORMAT),$(this).addClass("error"))}),Validator.PersonId[logic.register.personData.docCountry][logic.register.personData.docType].validate(logic.register.personData.personId)?(logic.register.personData.personIdFormatted=Formatter.PersonId[logic.register.personData.docCountry][logic.register.personData.docType].format(logic.register.personData.personId),logic.register.personData.personId=Formatter.PersonId[logic.register.personData.docCountry][logic.register.personData.docType].plain(logic.register.personData.personId)):(t=!1,$("#inputPersonId").addClass("error").next("p.label-error").text(text[logic.current.language].errors.INVALID_FORMAT)),moment($("#inputBirthdate").val(),"YYYY-MM-DD").isSameOrAfter(moment())&&(t=!1,$("#inputBirthdate").addClass("error")),t},loadDataFromConfig:function(){if(config.digitalIdentity){if(logic.register.personData.internalId=0,config.digitalIdentity.personalData&&(logic.register.personData=config.digitalIdentity.personalData),logic.register.personData.email="",logic.register.personData.email2="",config.digitalIdentity.emailAddresses){var e=config.digitalIdentity.emailAddresses;0<e.length&&(e[0].address&&(logic.register.personData.email=e[0].address),1<e.length&&e[1].address&&(logic.register.personData.email2=e[1].address))}if(logic.register.personData.cellphone="",config.digitalIdentity.contactPhones){var n=config.digitalIdentity.contactPhones;0<n.length&&n[0].number&&(logic.register.personData.cellphone=n[0].number)}if(config.digitalIdentity.identityDocuments){var t=config.digitalIdentity.identityDocuments;0<t.length&&(t[0].number&&(logic.register.personData.documentId=t[0].number),t[0].type&&(logic.register.personData.docType=t[0].type),t[0].countryCode&&(logic.register.personData.docCountry=t[0].countryCode),t[0].personalNumber&&(logic.register.personData.personId=t[0].personalNumber))}}},loadDataFromParams:function(){if(logic.register.loadedParams=!0,logic.register){if($("#inputDocType").val("ID"),$("#inputDocCountry").val("CL"),logic.register.personData){var e=logic.register.personData;if(console.log(e),e.dob){var n=moment(e.dob,"YYYYMMDD");n.isValid()&&$("#inputBirthdate").val(n.format("YYYY-MM-DD"))}e.gender&&$("#inputGender").val(e.gender),e.surnames&&$("#inputSurnames").val(e.surnames),e.givennames&&$("#inputGivennames").val(e.givennames),e.email&&$("#inputEmail").val(e.email),e.email2&&$("#inputEmail2").val(e.email2),e.cellphone&&$("#inputCellphone").val(e.cellphone),e.documentId&&$("#inputDocumentId").val(e.documentId),e.docType&&$("#inputDocType").val(e.docType),e.docCountry&&$("#inputDocCountry").val(e.docCountry),e.personId&&(e.personId=Formatter.PersonId[logic.register.personData.docCountry][logic.register.personData.docType].plain(e.personId),logic.register.personData.personIdFormatted=Formatter.PersonId[logic.register.personData.docCountry][logic.register.personData.docType].format(e.personId),$("#inputPersonId").val(logic.register.personData.personIdFormatted))}$("#inputPersonId").change()}},initPerson:function(){logic.register[1].loadDataFromParams(),$("footer").removeClass("d-none"),$("#btnNextStep").removeClass("d-none").unbind("click").click(function(e){e.preventDefault(),logic.validateCurrent()&&(null==logic.register.personData.internalId?logic.register[1].createPerson():0!=logic.register.personData.internalId?logic.register[1].updatePerson():logic.register[1].createPerson())}),$("#inputBirthdate").attr("max",moment().format("YYYY-MM-DD")).val(moment().subtract(18,"years").format("YYYY-MM-DD")),$(".person-data-input").change(function(){var e=$(this).val(),n=$(this).data("required");(n=0!=n)&&""==e?($(this).next("p.label-error").text(text[logic.current.language].errors.REQUIRED),$(this).addClass("error")):($(this).removeClass("error"),$(this).next("p.label-error").html("&nbsp"))}),$("#inputPersonId").change(function(){$(this).removeClass("error");var e=$(this).val();console.log("inputPersonId change",e),Validator.PersonId[logic.register.personData.docCountry][logic.register.personData.docType].validate(e)?(console.log("inputPersonId ok"),$(this).next("p.label-error").html("&nbsp")):(console.log("inputPersonId error"),$(this).addClass("error"),$(this).next("p.label-error").text(text[logic.current.language].errors.INVALID_FORMAT)),e=Formatter.PersonId[logic.register.personData.docCountry][logic.register.personData.docType].format(e),console.log("inputPersonId out",e),$(this).val(e)}),$("#helpSerial").click(function(e){e.preventDefault(),$("#modalSerial").modal()});var e=/^\+?([0-9]{2})\)?[-. ]?([0-9]{1})[-. ]?([0-9]{4})[-. ]?([0-9]{4})$/;$(".phone-input").change(function(){$(this).removeClass("error"),e.test($(this).val())?$(this).next("p.label-error").html("&nbsp"):($(this).next("p.label-error").text(text[logic.current.language].errors.INVALID_FORMAT),$(this).addClass("error"))});var n=/^(([^<>()\[\]\\.,;:\s@']+(\.[^<>()\[\]\\.,;:\s@']+)*)|('.+'))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;$(".email-input").change(function(){$(this).removeClass("error");var e=$(this).data("required");(e=0!=e)||""!=$(this).val()&&(e=!0),e&&!n.test($(this).val())?($(this).next("p.label-error").text(text[logic.current.language].errors.INVALID_FORMAT),$(this).addClass("error")):$(this).next("p.label-error").html("&nbsp")}),$("#loading").addClass("d-none")},getPerson:function(){var e={code:"PERSON",type:"GET",subtype:"PERSON",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:1549887978384,client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[config.digitalIdentity.identityDocuments[0]]}}};$.ajax({method:"POST",contentType:"application/json",dataType:"json",crossDomain:!0,url:config.baseUrl+"/api/v1/person/get",headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId},data:JSON.stringify(e)}).done(function(e){var n=text[logic.current.language].errors,t="",o={},i=!0,a=0;if(logic.validateRole("UPDATE_AUTH")||logic.validateRole("UPDATE_PERSON")||logic.validateRole("CREATE_PIN")){logic.validateRole("UPDATE_AUTH")||(console.log("false useFingerPrint y usePin"),config.useFingerprint=!1,config.usePin=!1),logic.register.personData.internalId=e.data.digitalIdentity.personId,logic.register.personData.gender=e.data.digitalIdentity.personalData.gender,logic.register.personData.surnames=e.data.digitalIdentity.personalData.surnames,logic.register.personData.givennames=e.data.digitalIdentity.personalData.givenNames,logic.register.personData.dob=e.data.digitalIdentity.personalData.dob,logic.register.personData.docType=e.data.digitalIdentity.identityDocuments[0].type,logic.register.personData.docCountry=e.data.digitalIdentity.identityDocuments[0].countryCode,logic.register.personData.personId=e.data.digitalIdentity.identityDocuments[0].personalNumber,logic.register.personData.documentId=e.data.digitalIdentity.identityDocuments[0].number;var r=e.data.digitalIdentity.contactPhones,s=e.data.digitalIdentity.emailAddresses;r&&0<r.length&&$.each(r,function(e,n){n.primary&&(logic.register.personData.cellphone=n.number)}),s&&0<s.length&&$.each(s,function(e,n){n.primary?logic.register.personData.email=n.address:logic.register.personData.email2=n.address}),logic.validateRole("UPDATE_PERSON")?logic.register[1].initPerson():logic.validateRole("UPDATE_AUTH")?logic.loadStep("register",2,window.config.language,logic.register.personData):window.config.operator.identityDocument.personalNumber==window.config.digitalIdentity.identityDocuments[0].personalNumber?logic.validateRole("CREATE_PIN")?(config.useFingerprint=!1,config.usePin=!0,logic.loadStep("register",2,window.config.language,logic.register.personData)):(i=!1,a=1e3):(i=!1,a=1001)}else i=!1,a=1002;i||(t=n.INVALID_ROLE,o={action:config.action,data:null,operator:{sessionId:window.config.operator.sessionId},numError:a,msError:t},window.opener.callback(o))}).fail(function(e){var n=text[logic.current.language].errors,t="",o=0;if(e.responseJSON)if(o=e.status,401===e.status||403===e.status)t=n.AUTH;else if(404==e.status){if(logic.validateRole("CREATE_PERSON"))return logic.register[1].loadDataFromConfig(),void logic.register[1].initPerson();t=n.INVALID_ROLE}else t=n.PROCESS;else t=n.COMM,o=1e3;var i={action:config.action,data:logic.verify.result,numError:o,msError:t};window.opener.callback(i)}).always(function(){})},createPerson:function(){$("#error-container").addClass("d-none"),$("#loading").removeClass("d-none");var e=[{type:"PERSONAL",address:logic.register.personData.email,primary:!0}];logic.register.personData.email2&&""!=logic.register.personData.email2&&e.push({type:"PERSONAL",address:logic.register.personData.email2,primary:!1});var n={code:"PERSON",type:"REGISTER",subtype:"PERSON",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{personalData:{givenNames:logic.register.personData.givennames,surnames:logic.register.personData.surnames,dob:logic.register.personData.birthdate,gender:logic.register.personData.gender},emailAddresses:e,contactPhones:[{type:"MOBILE",countryCode:1,areaCode:1,number:logic.register.personData.cellphone,primary:!0}],identityDocuments:[{type:logic.register.personData.docType,countryCode:logic.register.personData.docCountry,number:logic.register.personData.documentId,personalNumber:logic.register.personData.personId,issueDate:"20190101",expiryDate:"21001231",issuingAuthority:"",nationality:logic.register.personData.inputDocCountry}],authenticationFactors:[]}}};$.ajax({url:config.baseUrl+"/api/v1/person/create",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(n),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){if(200==e.status.status.code)e.data.digitalIdentity.personId&&(logic.register.personData.internalId=e.data.digitalIdentity.personId,logic.nextStep(logic.register.personData));else{var n=text[logic.current.language].errors,t=n.PROCESS;302==e.status.status.code&&(t=n.PERSON_FOUND),$("#error-message").text(t),$("#error-container").removeClass("d-none"),$("#loading").addClass("d-none")}}).fail(function(e){logic.handleError(e)}).always(function(){$("#loading").addClass("d-none")})},updatePerson:function(){$("#error-container").addClass("d-none"),$("#loading").removeClass("d-none");var e=[{type:"PERSONAL",address:logic.register.personData.email,primary:!0}];logic.register.personData.email2&&""!=logic.register.personData.email2&&e.push({type:"PERSONAL",address:logic.register.personData.email2,primary:!1});var n={code:"PERSON",type:"UPDATE",subtype:"PERSON",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{personalData:{givenNames:logic.register.personData.givennames,surnames:logic.register.personData.surnames,dob:logic.register.personData.birthdate,gender:logic.register.personData.gender},emailAddresses:e,contactPhones:[{type:"MOBILE",countryCode:1,areaCode:1,number:logic.register.personData.cellphone,primary:!0}],identityDocuments:[{type:logic.register.personData.docType,countryCode:logic.register.personData.docCountry,number:logic.register.personData.documentId,personalNumber:logic.register.personData.personId,issueDate:"20190101",expiryDate:"21001231",issuingAuthority:"",nationality:logic.register.personData.inputDocCountry}],authenticationFactors:[]}}};$.ajax({url:config.baseUrl+"/api/v1/person/update",datatype:"json",type:"PUT",crossDomain:!0,contentType:"application/json",data:JSON.stringify(n),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){e.data.digitalIdentity.personId&&(logic.register.personData.internalId=e.data.digitalIdentity.personId,logic.nextStep(logic.register.personData))}).fail(function(e){logic.handleError(e)}).always(function(){$("#loading").addClass("d-none")})}},2:{begin:function(e){$.isEmptyObject(logic.register.personData)&&null!=e&&!$.isEmptyObject(e)&&(logic.register.personData.internalId=e.internalId,logic.register.personData.gender=e.gender,logic.register.personData.surnames=e.surnames,logic.register.personData.givennames=e.givennames,logic.register.personData.docType=e.type,logic.register.personData.docCountry=e.countryCode,logic.register.personData.personId=e.personId,logic.register.personData.documentId=e.documentId,logic.register.personData.cellphone=e.cellphone,logic.register.personData.email=e.email,logic.register.personData.email2=e.email2,logic.register.personData.personIdFormatted=e.personIdFormatted),!1===config.usePin?logic.loadStep("register",4,window.config.language,logic.register.personData):($(".pin").keyup(function(e){var n=null;if(8==e.keyCode)(n=$(".pin")[$(".pin").index(this)-1])&&n.focus();else if(/^[0-9]$/.test(e.key)){if(""!=$(this).val()){var t=$(this).data("nextfocus");t&&$("#"+t).focus()}}else $(this).val("")}),$("#btnNextStep").unbind("click").click(function(e){e.preventDefault(),logic.validateCurrent()&&logic.nextStep(logic.register.personData)}),e.backTo&&(logic.register.backTo=e.backTo)),$("#loading").addClass("d-none")},validate:function(){$("#pin-invalid-error").addClass("d-none"),$(".pin").removeClass("error");var e="",n="";$(".pin-1 .pin").each(function(){e+=$(this).val()}),$(".pin-2 .pin").each(function(){n+=$(this).val()});var t=e===n&&6===e.length;return t?logic.register.personData.pin=e:($("#pin-invalid-error").removeClass("d-none"),$(".pin").addClass("error"),$(".pin").val(""),$("#input-pin-1").focus()),t}},3:{begin:function(e){$("#btnNextStep").unbind("click").click(function(e){e.preventDefault(),logic.validateCurrent()&&logic.register[3].createPin()})},validate:function(){$("#error-container").addClass("d-none");var t=!0;return $(".kba").each(function(){var e=$(this).val(),n=$(this).data("required");(n=0!=n)&&""==e&&(t=!1,$(this).addClass("error"))}),t||($("#error-message").text(text[logic.current.language].errors.REQUIRED_FIELD),$("#error-container").removeClass("d-none")),t},createPin:function(){$("#loading").removeClass("d-none");var e={code:"PERSON",type:"REGISTER",subtype:"PIN",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{personId:logic.register.personData.internalId,emailAddresses:[],addresses:[],contactPhones:[],identityDocuments:[]},authenticationFactors:[{type:"PIN",subtype:"PIN",value:logic.register.personData.pin,checksum:""},{type:"KBA",subtype:"KBA",questionType:"STATIC",questions:{},checksum:""}]}};e.data.authenticationFactors[1].questions[$("#inputQuestion").val()]={answers:{RESP:$("#inputAnswer").val()}},$.ajax({url:config.baseUrl+"/api/v1/pin/create",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(e),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){logic.nextStep(logic.register.personData)}).fail(logic.handleError).always(function(){$("#loading").addClass("d-none")})}},4:{captureOk:!1,begin:function(e){!1===config.useFingerprint?logic.nextStep(logic.register.personData):($("#loading").removeClass("d-none"),$("#btnNextStep").addClass("d-none"),window.logic.websocket.isConnect||window.logic.websocket.isConnecting?window.logic.websocket.isConnecting?window.setTimeout(window.logic.register[4].begin,1e3,e):!window.logic.websocket.isConnecting&&window.logic.websocket.isConnect&&($("#inFinger").val("2"),$("#btnCapture").click(function(){$("#error-container").addClass("d-none"),$(".feedback").removeClass("d-none"),$(this).addClass("disabled"),$("#current-capture-text").text("1").data("number",1),$("#total-capture-text").text(logic.websocket.captureQty),$("#capture-progress").removeClass("d-none");var e=window.text[logic.current.language].register.step4.userMessage.partA+$("#inFinger").children("option:selected").text()+window.text[logic.current.language].register.step4.userMessage.partB;$("#user-message").text(e),logic.register[4].captureOk=!1,window.logic.websocket.capture($("#inFinger").val(),logic.register[4].updateFingerprint,logic.register[4].createFingerprint)}),$("#inFinger").on("change",function(){var e="assets/finger/"+$(this).val().toString()+".png";$("#image-swap").attr("src",e)}),$("#loading").addClass("d-none")):logic.nextStep(logic.register.personData))},validate:function(){return!0},updateFingerprint:function(e){if(0==e.status.code){if($("#error-container").addClass("d-none"),e.data.authenticationFactors&&e.data.authenticationFactors[0].preview){$("#error-container").addClass("d-none");var n=$("#current-capture-text").data("number");n=parseInt(n)+1,$("#current-capture-text").text(n).data("number",n),$("#imgFingerprint").attr("src","data:image/jpeg;base64,"+e.data.authenticationFactors[0].preview)}}else{var t="";t=18==e.status.code?text[logic.current.language].errors.CAPTURE_MATCH:text[logic.current.language].errors.CAPTURE_GENERAL,$(".feedback").addClass("d-none"),$("#error-message").text(t),$("#error-container").removeClass("d-none")}},captureComplete:function(){return!0},createFingerprint:function(e){if($("#capturing").addClass("d-none"),$("#btnCapture").removeClass("disabled"),$("#capture-progress").addClass("d-none"),0==e.status.code)$("#loading").removeClass("d-none"),delete e.status,delete e.data.config,e.code="PERSON",e.type="REGISTER",e.subtype="FINGERPRINT",e.data.digitalIdentity={personId:logic.register.personData.internalId,identityDocuments:[]},e.client?(e.client.operationId=config.operationId,e.client.companyId=config.companyId,e.client.username=""):e.client={operationId:config.operationId,companyId:config.companyId,username:config.username,token:""},$.ajax({url:config.baseUrl+"/api/v1/fingerprint/",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(e),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){logic.register[4].captureOk=!0,logic.nextStep(logic.register.personData)}).fail(logic.handleError).always(function(){$("#loading").addClass("d-none")});else{var n="";n=21==e.status.code?text[logic.current.language].errors.CAPTURE_MATCH:text[logic.current.language].errors.CAPTURE_GENERAL,$("#error-message").text(n),$("#error-container").removeClass("d-none")}}},5:{begin:function(e){$("#btnFinish").click(function(){if(logic.register.backTo){var e=Object.assign({from:"register"},logic.register.personData);logic.loadStep(logic.register.backTo.process,logic.register.backTo.step,window.config.language,e)}else{var n=[{type:"PERSONAL",address:logic.register.personData.email,primary:!0}];logic.register.personData.email2&&""!=logic.register.personData.email2&&n.push({type:"PERSONAL",address:logic.register.personData.email2,primary:!1});var t={action:config.action,data:{digitalIdentity:{personId:logic.register.personData.internalId,personalData:{givenNames:logic.register.personData.givennames,surnames:logic.register.personData.surnames,dob:logic.register.personData.birthdate,gender:logic.register.personData.gender},emailAddresses:n,contactPhones:{type:"MOBILE",number:logic.register.personData.cellphone,primary:!0},identityDocuments:[{type:logic.register.personData.docType,countryCode:logic.register.personData.docCountry,number:logic.register.personData.documentId,personalNumber:logic.register.personData.personId,issueDate:"20190101",expiryDate:"21001231",issuingAuthority:"",nationality:logic.register.personData.inputDocCountry}]}},operator:{sessionId:window.config.operator.sessionId},numError:0,msError:""};window.opener.callback(t)}}),$("main").addClass("nopadding"),$("footer").addClass("d-none")}}},window.logic||(window.logic={}),window.logic.verify={personData:{},loadedParams:!1,countRetry:0,steps:5,1:{begin:function(e){if(logic.getRoles(),window.config.operator.identityDocument.personalNumber==window.config.digitalIdentity.identityDocuments[0].personalNumber?console.log("misma persona"):console.log("distinta persona"),logic.validateRole("VERIFY_PERSON")||window.config.operator.identityDocument.personalNumber==window.config.digitalIdentity.identityDocuments[0].personalNumber){if($("#loading").removeClass("d-none"),e.from)return logic.verify.personData=e.personData,void logic.nextStep(logic.verify.personData);logic.verify.loadedParams||logic.verify[1].loadDataFromParams(),logic.verify[1].getPerson(),$("#btnNextStep").addClass("d-none")}else{console.log("sin perfil");var n={action:config.action,data:null,operator:{sessionId:window.config.operator.sessionId},numError:1e3,msError:text[logic.current.language].errors.INVALID_ROLE};window.opener.callback(n)}},validate:function(){return!0},loadDataFromParams:function(){if(logic.verify.loadedParams=!0,config.digitalIdentity.personalData){var e=config.digitalIdentity.personalData;e.dob&&(logic.verify.personData.birthdate=e.dob),e.gender&&(logic.verify.personData.gender=e.gender),e.surnames&&(logic.verify.personData.surnames=e.surnames),e.givenNames&&(logic.verify.personData.givennames=e.givenNames)}if(config.digitalIdentity.emailAddresses){var n=config.digitalIdentity.emailAddresses;0<n.length&&(n[0].address&&(logic.verify.personData.email=n[0].address),1<n.length&&n[1].address&&(logic.verify.personData.email2=n[1].address))}if(config.digitalIdentity.contactPhones){var t=config.digitalIdentity.contactPhones;0<t.length&&t[0].number&&(logic.verify.personData.cellphone=t[0].number)}if(logic.verify.personData.docType="ID",logic.verify.personData.docCountry="CL",config.digitalIdentity.identityDocuments){var o=config.digitalIdentity.identityDocuments;0<o.length&&(o[0].personalNumber&&(logic.verify.personData.personId=o[0].personalNumber),o[0].number&&(logic.verify.personData.documentId=o[0].number),o[0].type&&(logic.verify.personData.docType=o[0].type),o[0].countryCode&&(logic.verify.personData.docCountry=o[0].countryCode))}},getPerson:function(){var e={code:"PERSON",type:"GET",subtype:"PERSON",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:1549887978384,client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[config.digitalIdentity.identityDocuments[0]]}}};$.ajax({method:"POST",contentType:"application/json",dataType:"json",crossDomain:!0,url:config.baseUrl+"/api/v1/person/get",headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId},data:JSON.stringify(e)}).done(function(e){logic.verify.personData.internalId=e.data.digitalIdentity.personId,logic.verify.personData.gender=e.data.digitalIdentity.personalData.gender,logic.verify.personData.surnames=e.data.digitalIdentity.personalData.surnames,logic.verify.personData.givennames=e.data.digitalIdentity.personalData.givenNames,logic.verify.personData.docType=e.data.digitalIdentity.identityDocuments[0].type,logic.verify.personData.docCountry=e.data.digitalIdentity.identityDocuments[0].countryCode,logic.verify.personData.personId=e.data.digitalIdentity.identityDocuments[0].personalNumber,logic.verify.personData.documentId=e.data.digitalIdentity.identityDocuments[0].number,logic.verify.personData.personIdFormatted=Formatter.PersonId[logic.verify.personData.docCountry][logic.verify.personData.docType].format(logic.verify.personData.personId);var n=e.data.digitalIdentity.contactPhones,t=e.data.digitalIdentity.emailAddresses;n&&0<n.length&&$.each(n,function(e,n){n.primary&&(logic.verify.personData.cellphone=n.number)}),t&&0<t.length&&$.each(t,function(e,n){n.primary?logic.verify.personData.email=n.address:logic.verify.personData.email2=n.address}),logic.nextStep(logic.verify.personData)}).fail(function(e){var n=text[logic.current.language].errors,t="",o=0;e.responseJSON?(o=e.status,401===e.status||403===e.status?t=n.AUTH:404==e.status?logic.loadStep("register",1,window.config.language,{backTo:{process:"verify",step:1}}):t=n.PROCESS):(t=n.COMM,o=1e3);var i={action:config.action,data:logic.verify.result,numError:o,msError:t};window.opener.callback(i)}).always(function(){})}},2:{begin:function(e){if($("#loading").removeClass("d-none"),config.method)"PIN"==config.method?logic.nextStep(logic.verify.personData):"FINGERPRINT"==config.method&&logic.loadStep("verify",5,window.config.language,logic.verify.personData);else{if($("#verify-opt-pin").click(function(){logic.nextStep(logic.verify.personData)}),$("#verify-opt-finger").click(function(){$("#loading").removeClass("d-none"),logic.loadStep("verify",5,window.config.language,logic.verify.personData)}).removeClass("d-none"),$("#verify-opt-clave_unica").click(function(){}),$("#verify-opt-facial").click(function(){}),!window.logic.websocket.isConnecting&&window.logic.websocket.isConnect)return void window.setTimeout(window.logic.verify[5].begin,1e3,e);$("#loading").addClass("d-none")}},validate:function(){return!0}},3:{begin:function(e){$("footer").removeClass("d-none"),$("main").removeClass("nopadding"),$("#btnNextStep").removeClass("d-none").unbind("click").click(function(e){e.preventDefault(),logic.validateCurrent()&&logic.verify[3].validatePin()}),$(".pin").keyup(function(e){var n=null;if(8==e.keyCode)(n=$(".pin")[$(".pin").index(this)-1])&&n.focus();else if(/^[0-9]$/.test(e.key)){if(""!=$(this).val()){var t=$(this).data("nextfocus");t&&$("#"+t).focus()}}else $(this).val("")}),$("#btnForgot").click(function(e){e.preventDefault(),$("#loading").removeClass("d-none"),logic.nextStep(logic.verify.personData)}),$("#loading").addClass("d-none")},validate:function(){return!0},validatePin:function(){$("#loading").removeClass("d-none");var t="";$(".pin").each(function(e,n){t+=$(n).val()});var e={code:"PERSON",type:"VERIFY",subtype:"PIN",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:123456,appFlow:{code:"",step:""},client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[config.digitalIdentity.identityDocuments[0]]},authenticationFactors:[{type:"PIN",subtype:"PIN",value:t}]}};$.ajax({url:config.baseUrl+"/api/v1/verify/pin",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(e),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){if(e.data.authenticationResult.authenticated)logic.verify.result=e.data.authenticationResult,logic.loadStep("verify",6,window.config.language,{personData:logic.verify.personData,authentication:logic.verify.result});else{if(logic.verify.countRetry++,logic.verify.countRetry>=window.config.retry.pin)return void logic.loadStep("verify",6,window.config.language,{personData:logic.verify.personData,authentication:logic.verify.result});var n,t=window.config.retry.fingerprint-logic.verify.countRetry,o="";o=1==t?window.text[logic.current.language].verify.step3.attempsB:t+" "+window.text[logic.current.language].verify.step3.attempsA,$("#attemps").removeClass("d-none"),$("#attemps").text(o),$(".pin").val(""),$("#input-pin-1").focus(),n=text[logic.current.language].errors.PERSON_NO_AUTH,$("#error-message").text(n),$("#error-container").removeClass("d-none"),$("#loading").addClass("d-none")}}).fail(logic.handleError).always(function(){$("#loading").addClass("d-none")})}},4:{begin:function(e){var n={code:"PERSON",type:"GET",subtype:"KBA",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:1549887978384,client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[config.digitalIdentity.identityDocuments[0]]},authenticationFactors:[{type:"KBA",subtype:"KBA",questionType:"STATIC"}]}};$.ajax({url:config.baseUrl+"/api/v1/kba/get",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(n),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){var n;e.data.authenticationFactors&&0<e.data.authenticationFactors.length?(logic.verify.lastQuestion=atob(e.data.authenticationFactors[0].value),$("#lbl-question").text(atob(e.data.authenticationFactors[0].value))):(n=text[logic.current.language].errors.OPERATOR_NO_DATA,$("#error-message").text(n),$("#error-container").removeClass("d-none"))}).fail(function(e){var n=text[logic.current.language].errors,t="";e.responseJSON?401===e.status||403===e.status?t=n.AUTH:404==e.status?logic.loadStep("register",1,window.config.language,{backTo:{process:"verify",step:1}}):t=n.PROCESS:t=n.COMM,$("#error-message").text(t),$("#error-container").removeClass("d-none")}).always(function(){$("#loading").addClass("d-none")}),$("#btnNextStep").removeClass("d-none").unbind("click").click(function(e){e.preventDefault(),logic.validateCurrent()&&logic.verify[4].validateQuestion()})},validateQuestion:function(){var e={code:"PERSON",type:"VERIFY",subtype:"KBA",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:1549887978384,client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[config.digitalIdentity.identityDocuments[0]]},authenticationFactors:[{type:"KBA",subtype:"KBA",questionType:"STATIC",questions:{}}]}};e.data.authenticationFactors[0].questions[logic.verify.lastQuestion]={answers:{RESP:$("#input-answer").val()}},$.ajax({url:config.baseUrl+"/api/v1/verify/kba",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(e),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){if(e.data.authenticationResult.authenticated){logic.verify.personData=logic.verify.personData;var n=Object.assign({backTo:{process:"verify",step:3}},logic.verify.personData);config.useFingerprint=!1,config.usePin=!0,logic.loadStep("register",2,window.config.language,n)}else $("#error-message").text(text[logic.current.language].errors.QUESTION_MATCH),$("#error-container").removeClass("d-none")}).fail(function(e){var n=text[logic.current.language].errors,t="";e.responseJSON?401===e.status||403===e.status?t=n.AUTH:404==e.status?logic.loadStep("register",1,window.config.language,{backTo:{process:"verify",step:1}}):t=n.PROCESS:t=n.COMM,$("#error-message").text(t),$("#error-container").removeClass("d-none")}).always(function(){$("#loading").addClass("d-none")})},validate:function(){return!0}},5:{begin:function(e){if($("#loading").removeClass("d-none"),window.logic.websocket.isConnect||window.logic.websocket.isConnecting){if(window.logic.websocket.isConnecting)window.setTimeout(window.logic.verify[5].begin,1e3,e);else if(!window.logic.websocket.isConnecting&&window.logic.websocket.isConnect){$(".finger-layer").addClass("d-none"),$("#btnNextStep").unbind("click").click(function(e){e.preventDefault(),logic.validateCurrent()&&logic.nextStep({})}),$("#loading").removeClass("d-none"),$("#inFinger").val("2"),$("#btnCapture").click(function(){$(".feedback").removeClass("d-none"),logic.verify[5].captureOk=!1,window.logic.websocket.verify(logic.verify[5].data,logic.verify[5].matching),$("#btnCapture").addClass("disabled"),$("#error-container").addClass("d-none")}),$("#inFinger").on("change",function(){var e="assets/finger/"+$(this).val().toString()+".png";$("#image-swap").attr("src",e)});var n={code:"PERSON",type:"GET",subtype:"FINGERPRINT",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:123456,client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[config.digitalIdentity.identityDocuments[0]]},authenticationFactors:[{type:"FINGERPRINT",subtype:"FINGERPRINT",id:0,minutiaesFormat:"0"}]}};$.ajax({url:config.baseUrl+"/api/v1/fingerprint/get",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(n),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){if(0==(logic.verify[5].data=e).data.authenticationFactors.length){var n=text[logic.current.language].errors.NOT_FOUND_FINGERPRINTS;$("#error-message").text(n),$("#error-container").removeClass("d-none")}else $.each(e.data.authenticationFactors,function(e,n){$("#finger-layer-"+n.id).removeClass("d-none")}),$("#btnCapture").click()}).fail(function(e){var n=text[logic.current.language].errors,t="";e.responseJSON?401===e.status||403===e.status?t=n.AUTH:404==e.status?logic.loadStep("register",1,window.config.language,{backTo:{process:"verify",step:1}}):t=n.PROCESS:t=n.COMM,$("#error-message").text(t),$("#error-container").removeClass("d-none")}).always(function(){$("#loading").addClass("d-none")})}}else{var t={action:config.action,method:"FINGERPRINT",data:logic.verify.result,numError:5e3,msError:text[logic.current.language].errors.WS_CONNECTION};window.opener.callback(t)}},validate:function(){return!0},matching:function(e){if(console.log("matching"),$(".feedback").addClass("d-none"),0==e.status.code){console.log("matching code 0"),$("#loading").removeClass("d-none"),logic.verify.result=e.data.authenticationResult;var n={code:"PERSON",type:"VERIFY",subtype:"FINGERPRINT",createdAt:e.createdAt,id:e.id,client:{operationId:config.operationId,companyId:config.companyId,username:"",machineId:e.client.machineId},data:{digitalIdentity:{identityDocuments:[config.digitalIdentity.identityDocuments[0]]},authenticationFactors:[],authenticationResult:e.data.authenticationResult}};$.ajax({url:config.baseUrl+"/api/v1/verify/fingerprint",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(n),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){if(e.data.authenticationResult.authenticated)logic.verify.result=e.data.authenticationResult,logic.loadStep("verify",6,window.config.language,{personData:logic.verify.personData,authentication:logic.verify.result});else{if(logic.verify.countRetry++,logic.verify.countRetry>=window.config.retry.fingerprint)return void logic.loadStep("verify",6,window.config.language,{personData:logic.verify.personData,authentication:logic.verify.result});var n,t=window.config.retry.fingerprint-logic.verify.countRetry,o="";o=1==t?window.text[logic.current.language].verify.step3.attempsB:t+" "+window.text[logic.current.language].verify.step3.attempsA,$("#attemps").removeClass("d-none"),$("#attemps").text(o),n=text[logic.current.language].errors.PERSON_NO_AUTH,$("#error-message").text(n),$("#error-container").removeClass("d-none"),$("#loading").addClass("d-none"),$("#btnCapture").removeClass("disabled"),$("#btnCapture").removeClass("d-none")}}).fail(function(e){var n=text[logic.current.language].errors,t="";e.responseJSON?401===e.status||403===e.status?t=n.AUTH:404==e.status?logic.loadStep("register",1,window.config.language,{backTo:{process:"verify",step:1}}):t=n.PROCESS:t=n.COMM,$("#error-message").text(t),$("#error-container").removeClass("d-none")}).always(function(){$("#loading").addClass("d-none")})}else{console.log("matching code <> 0 "+e.status.code);var t=text[logic.current.language].errors,o="";401===e.status.code||403===e.status.code?o=t.AUTH:404==e.status.code?logic.loadStep("register",1,window.config.language,{backTo:{process:"verify",step:1}}):o=t.PROCESS,$("#error-message").text(o),$("#error-container").removeClass("d-none"),$("#btnCapture").removeClass("disabled")}}},6:{begin:function(e){$("#btnFinish").click(function(){var e={action:config.action,data:logic.verify.result,operator:{sessionId:window.config.operator.sessionId},numError:0,msError:""};window.opener.callback(e)}),$("main").addClass("nopadding"),$("footer").addClass("d-none")},validate:function(){return!0}}},window.logic=window.logic?window.logic:{},window.logic.websocket=function(){var n=function(){0==window.logic.websocket.socket.readyState?window.setTimeout(n,500):3==window.logic.websocket.socket.readyState?(window.logic.websocket.isConnecting=!1,window.logic.websocket.isConnect=!1):window.logic.websocket.isConnecting=!1};return{isConnect:!1,isConnecting:!1,captureQty:3,threshold:50,minQuality:50,connect:function(t){window.logic.websocket.isConnecting=!0;var e=new WebSocket("wss://wsocktray.checkid.cl:3013");e.onopen=function(e){},e.onmessage=function(e){var n=JSON.parse(e.data);"CONNECTION"==n.code?(t&&t(n),window.logic.websocket.isConnect=!0):"PERSONA"==n.code&&"VERIFICAR"==n.type?window.logic.websocket.finishCallback&&window.logic.websocket.finishCallback(n):"PERSONA"==n.code&&"REGISTRAR"==n.type&&(n.status.update?window.logic.websocket.updateCallback&&window.logic.websocket.updateCallback(n):window.logic.websocket.finishCallback&&window.logic.websocket.finishCallback(n))},e.onclose=function(e){window.logic.websocket.isConnect=!1},e.onerror=function(e){window.logic.websocket.errorCallback&&window.logic.websocket.errorCallback(e)},window.logic.websocket.socket=e,n()},capture:function(e,n,t){var o={code:"PERSONA",type:"REGISTRAR",subtype:"FINGERPRINT",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),data:{config:{MaxCapture:window.logic.websocket.captureQty,Threshold:window.logic.websocket.threshold,MinQuality:window.logic.websocket.minQuality,fingerId:e}}};window.logic.websocket.updateCallback=n,window.logic.websocket.finishCallback=t,window.logic.websocket.socket.send(JSON.stringify(o))},verify:function(e,n){console.log("svcRespose",e);var t={code:"PERSONA",type:"VERIFICAR",subtype:"FINGERPRINT",createdAt:e.createdAt,client:{operationId:config.operationId,companyId:null,username:null,password:null,token:logic.current.sessionId,machineId:null},data:{authenticationFactors:e.data.authenticationFactors,config:{threshold:window.logic.websocket.threshold,maxCapture:1,minQuality:window.logic.websocket.minQuality}}};window.logic.websocket.finishCallback=n,window.logic.websocket.socket.send(JSON.stringify(t))},setHandleError:function(e){window.logic.websocket.errorCallback=e}}}();