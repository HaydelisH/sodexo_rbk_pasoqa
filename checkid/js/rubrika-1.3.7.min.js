/*! Rubrika.LogicJS - v1.3.7 - 24/06/2020
* Copyright (c) 2020 Ingenieria Solem */

window.logic=function(){"use strict";return{current:{process:"",step:0,language:"",sessionId:null},profiles:[],pages:[],equalUser:!1,personStatus:"",loadStep:function(e,t,n,o){var i={text:text[n][e]["step"+t],data:o};if($("#body-content").html(Handlebars.templates[e+"/step"+t](i)),logic.current.process=e,logic.current.step=t,logic.current.language=n,1==t){$("#dot-container").empty();for(var a=1;a<=logic[e].steps;a++)$("#dot-container").append('<span id="dot-'+a+'" class="dot">&#9679;</span>')}$(".dot").attr("selected",!1),$("#dot-"+t).attr("selected",!0),logic[e][t].begin(o)},loadStepModule:function(e,t,n,o,i){var a={text:text[o].pages[t[n-1]],data:i};$("#body-content").html(Handlebars.templates["pages/"+t[n-1]](a)),logic.current.process=e,logic.current.step=n,logic.current.language=o,logic.pages=t,$("#dot-container").empty();for(var r=1;r<=t.length;r++)$("#dot-container").append('<span id="dot-'+r+'" class="dot">&#9679;</span>');$(".dot").attr("selected",!1),$("#dot-"+n).attr("selected",!0),logic[t[n-1]].begin(i)},nextStep:function(e){logic.loadStep(logic.current.process,logic.current.step+1,logic.current.language,e)},nextStepModule:function(e){logic.loadStepModule(logic.current.process,logic.pages,logic.current.step+1,logic.current.language,e)},validateCurrent:function(){return logic[logic.current.process][logic.current.step].validate()},validateCurrentModule:function(){return logic[logic.pages[logic.current.step-1]].validate()},getText:function(){return text[logic.current.language][logic.current.process]["step"+logic.current.step]},handleError:function(e){var t=text[logic.current.language].errors,n="";n=e.responseJSON?401===e.status||403===e.status?t.AUTH:t.PROCESS:t.COMM,$("#error-message").text(n),$("#error-container").removeClass("d-none"),$("#loading").addClass("d-none")},getProfiles:function(){var e={code:"PERSON",type:"GET",subtype:"PROFILE",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:1549887978384,client:{operationId:config.operationId,companyId:config.companyId,machineId:"",username:"",password:"",operator:{identityDocument:config.operator.identityDocument}},data:{digitalIdentity:{identityDocuments:[config.operator.identityDocument]}}},l=config.baseUrl+"/api/v1/profile/get";$.ajax({method:"POST",contentType:"application/json",dataType:"json",crossDomain:!0,url:l,headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId},data:JSON.stringify(e),async:!1}).done(function(e){if(logic.equalUser&&"CREATE"==window.config.action)if(0==e.data.digitalIdentity.profiles.length)e.data.digitalIdentity.profiles.push({code:"CREATE_PIN",description:""});else{for(var t=!1,n=0;n<e.data.digitalIdentity.profiles.length;n++)if("CREATE_PIN"==e.data.digitalIdentity.profiles[n].code){t=!0;break}0==t&&e.data.digitalIdentity.profiles.push({code:"CREATE_PIN",description:""})}logic.profiles=e.data.digitalIdentity.profiles,logic.personStatus=e.data.info.codEstadoPersona}).fail(function(e,t,n){var o=text[window.config.language].errors,i="",a=0;if(e.responseJSON){if(401===e.status||403===e.status)return void logic.loadStep("login",1,window.config.language,{});if(404==e.status){if(logic.equalUser&&"CREATE"==window.config.action){var r={code:"CREATE_PERSON",description:""},s=[];return s.push(r),r={code:"CREATE_PIN",description:""},s.push(r),void(logic.profiles=s)}i=o.PROFILE_NO_DATA,a=e.status}else i=o.PROCESS,a=e.status}else i=o.COMM+" ["+l+"]",a=1e3;if(null==config.handleErrs||0==config.handleErrs){var c={action:config.action,data:null,operator:{sessionId:window.config.operator.sessionId},numError:a,msError:i};window.opener.callback(c)}else{var d={};d.personIdFormatted=Formatter.PersonId[config.operator.identityDocument.countryCode][config.operator.identityDocument.type].format(config.operator.identityDocument.personalNumber),d.numError=a,d.msError=i,d.action=config.action,logic.loadStep("weberror",1,window.config.language,d)}}).always(function(){$("#loading").addClass("d-none")})},getFlow:function(e){var t=[];switch(e){case"register":t=["personinit","persondocument","person","pincreate","pinkbacreate","pfingerprintcreate","presult"];break;case"verify":t=["personinit","personauth","pinauth","pinrestore","pfingerprintauth","presult"];break;case"reg-simple":t=["persondocument","person","pincreate","pinkbacreate","pfingerprintcreate","presult"];break;case"pinrestore":t=["pincreate","pinkbacreate","presult"]}return t},validateProfile:function(e){for(var t=0;t<logic.profiles.length;t++)if(logic.profiles[t].code==e)return!0;return!1},validateAction:function(e){for(var t=!1,n=0;n<logic.profiles.length;n++)switch(logic.profiles[n].code){case"CREATE_PERSON":"CREATE"==e&&(t=!0);break;case"CREATE_PIN":"CREATE"!=e&&"UPDATE"!=e&&"UPDATE_PIN"!=e||(t=!0);break;case"UPDATE_AUTH":case"UPDATE_PERSON":"UPDATE"==e&&(t=!0);break;case"VERIFY_PERSON":"VERIFY"==e&&(t=!0);break;default:t=!1}return t},validateIdentityDocument:function(e){var t=!0;return e&&(e.type||0!=e.type.length)&&(e.countryCode||0!=e.countryCode.length)&&(e.personalNumber||0!=e.personalNumber.length)&&Validator.PersonId[e.countryCode][e.type].validate(e.personalNumber)||(t=!1),t},init:function(){if($('[data-toggle="tooltip"]').tooltip(),window.opener&&window.opener.getParams&&(window.config=window.opener.getParams(),window.config)){if(!window.config.language&&(window.config.language="esCL",config.digitalIdentity.identityDocuments))switch(config.digitalIdentity.identityDocuments[0].countryCode){case"CL":case"CHL":window.config.language="esCL";break;case"COL":window.config.language="esCO";break;case"PER":window.config.language="esPE"}if(null!=window.config.useKBA&&(window.config.pinRestore=window.config.useKBA),null==window.config.pinRestore&&(window.config.pinRestore=!0),null==window.config.pinRestoreMethod)window.config.pinRestoreMethod="KBA";else switch(window.config.pinRestoreMethod){case"KBA":case"ACEP":break;default:window.config.pinRestore=!1}if(null==window.config.handleErrs&&(window.config.handleErrs=!1),null==window.config.useVerifyExt&&(window.config.useVerifyExt=!1),null==window.config.operator.usePin&&(window.config.operator.usePin=!0),null==window.config.operator.useFingerprint&&(window.config.operator.useFingerprint=!0),null==window.config.operator.pinRestore&&(window.config.operator.pinRestore=!0),null==window.config.operator.pinRestoreMethod)window.config.operator.pinRestoreMethod="KBA";else switch(window.config.operator.pinRestoreMethod){case"KBA":case"ACEP":break;default:window.config.operator.pinRestore=!1}var e=!0,t=0,n="";if(window.config.digitalIdentity&&window.config.digitalIdentity.identityDocuments&&0<window.config.digitalIdentity.identityDocuments.length?logic.validateIdentityDocument(window.config.digitalIdentity.identityDocuments[0])?window.config.operator.identityDocument?logic.validateIdentityDocument(window.config.operator.identityDocument)||(t=1101,n=text[window.config.language].errors.INVALID_OPERATOR_DATA,e=!1):(t=1102,n=text[window.config.language].errors.INVALID_OPERATOR_DATA,e=!1):(t=1001,n=text[window.config.language].errors.INVALID_PERSON_DATA,e=!1):(t=1002,n=text[window.config.language].errors.INVALID_PERSON_DATA,e=!1),!e){var o={action:config.action,data:null,operator:{sessionId:window.config.operator.sessionId},numError:t,msError:n};return void window.opener.callback(o)}if(window.config.retry?(window.config.retry.pin||(window.config.retry.pin=3),window.config.retry.fingerprint||(window.config.retry.fingerprint=3)):window.config.retry={pin:3,fingerprint:3},moment.locale(window.config.language.substring(0,2).toUpperCase()),window.setInterval(function(){$("#datetime").text(moment().format("LLLL"))},1e3),$("#datetime").text(moment().format("LLLL")),$(".secure-tx-text").text(text[window.config.language].general.secureTx),$("#wait-text").text(text[window.config.language].general.wait),$("#btnNextStep").text(text[window.config.language].general.next),$("#btnClose").text(text[window.config.language].general.close).click(function(e){e.preventDefault();var t={action:config.action,data:null,numError:100,msError:text[window.config.language].errors.CLOSED};window.opener.callback(t)}),window.logic.websocket.connect(),"CREATE"==window.config.action?logic.pages=logic.getFlow("register"):"VERIFY"==window.config.action&&(logic.pages=logic.getFlow("verify")),!window.config.operator.sessionId)return void(window.config.operator.identityDocument.personalNumber==window.config.digitalIdentity.identityDocuments[0].personalNumber?(logic.equalUser=!0,logic.current.sessionId=window.config.sessionId,"CREATE"==window.config.action?logic.loadStepModule("register",logic.pages,1,window.config.language,{}):"VERIFY"==window.config.action&&logic.loadStepModule("verify",logic.pages,1,window.config.language,{})):(logic.equalUser=!1,logic.loadStep("login",1,window.config.language,{})));if(logic.current.sessionId=window.config.operator.sessionId,"CREATE"==window.config.action)return void logic.loadStepModule("register",logic.pages,1,window.config.language,{});if("VERIFY"==window.config.action)return void logic.loadStepModule("verify",logic.pages,1,window.config.language,{})}}}}(),$(document).ready(window.logic.init),window.logic||(window.logic={}),window.logic.login={personData:{},loadedParams:!1,countRetry:0,steps:10,1:{begin:function(e){if(logic.current.sessionId=window.config.sessionId,$("body").addClass("loggin"),$("#loading").removeClass("d-none"),e.from)return logic.login.personData=e.personData,void logic.nextStep(logic.login.personData);logic.login.loadedParams||logic.login[1].loadDataFromParams(),logic.login[1].getPerson(),$("#btnNextStep").addClass("d-none")},validate:function(){return!0},loadDataFromParams:function(){if(logic.login.loadedParams=!0,config.digitalIdentity.personalData){var e=config.digitalIdentity.personalData;e.dob&&(logic.login.personData.birthdate=e.dob),e.gender&&(logic.login.personData.gender=e.gender),e.surnames&&(logic.login.personData.surnames=e.surnames),e.givenNames&&(logic.login.personData.givennames=e.givenNames)}if(config.digitalIdentity.emailAddresses){var t=config.digitalIdentity.emailAddresses;0<t.length&&(t[0].address&&(logic.login.personData.email=t[0].address),1<t.length&&t[1].address&&(logic.login.personData.email2=t[1].address))}if(config.digitalIdentity.contactPhones){var n=config.digitalIdentity.contactPhones;0<n.length&&n[0].number&&(logic.login.personData.cellphone=n[0].number)}if(logic.login.personData.docType="ID",logic.login.personData.docCountry="CL",config.digitalIdentity.identityDocuments){var o=config.digitalIdentity.identityDocuments;0<o.length&&(o[0].personalNumber&&(logic.login.personData.personId=o[0].personalNumber),o[0].number&&(logic.login.personData.documentId=o[0].number),o[0].type&&(logic.login.personData.docType=o[0].type),o[0].countryCode&&(logic.login.personData.docCountry=o[0].countryCode))}},getPerson:function(){var e={code:"PERSON",type:"GET",subtype:"PERSON",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:1549887978384,client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[config.operator.identityDocument]}}};$.ajax({method:"POST",contentType:"application/json",dataType:"json",crossDomain:!0,url:config.baseUrl+"/api/v1/person/get",headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":config.sessionId},data:JSON.stringify(e)}).done(function(e){logic.login.personData.internalId=e.data.digitalIdentity.personId,logic.login.personData.gender=e.data.digitalIdentity.personalData.gender,logic.login.personData.surnames=e.data.digitalIdentity.personalData.surnames,logic.login.personData.givennames=e.data.digitalIdentity.personalData.givenNames,logic.login.personData.docType=e.data.digitalIdentity.identityDocuments[0].type,logic.login.personData.docCountry=e.data.digitalIdentity.identityDocuments[0].countryCode,logic.login.personData.personId=e.data.digitalIdentity.identityDocuments[0].personalNumber,logic.login.personData.documentId=e.data.digitalIdentity.identityDocuments[0].number,logic.login.personData.personIdFormatted=Formatter.PersonId[logic.login.personData.docCountry][logic.login.personData.docType].format(logic.login.personData.personId),logic.login.personData.pinRestore=config.operator.pinRestore,logic.login.personData.pinRestoreMethod=config.operator.pinRestoreMethod;var t=e.data.digitalIdentity.contactPhones,n=e.data.digitalIdentity.emailAddresses;t&&0<t.length&&$.each(t,function(e,t){t.primary&&(logic.login.personData.cellphone=t.number)}),n&&0<n.length&&$.each(n,function(e,t){t.primary?logic.login.personData.email=t.address:logic.login.personData.email2=t.address}),logic.nextStep(logic.login.personData)}).fail(function(e){var t=text[logic.current.language].errors,n="",o=0;if(e.responseJSON?(o=e.status,n=401===e.status||403===e.status?t.AUTH:404==e.status?t.OPERATOR_NO_DATA:t.PROCESS):(n=t.COMM,o=1e3),null==config.handleErrs||0==config.handleErrs){var i={action:config.action,data:logic.login.result,operator:{sessionId:window.config.operator.sessionId},numError:o,msError:n};window.opener.callback(i)}else{$("#loading").addClass("d-none");var a={};a.personIdFormatted=Formatter.PersonId[config.digitalIdentity.identityDocuments[0].countryCode][config.digitalIdentity.identityDocuments[0].type].format(config.digitalIdentity.identityDocuments[0].personalNumber),a.numError=o,a.msError=n,a.action=config.action,a.result=logic.verify.result,logic.loadStep("weberror",1,window.config.language,a)}}).always(function(){})}},2:{begin:function(e){if($("#loading").removeClass("d-none"),1==config.operator.usePin&&1==config.operator.useFingerprint){if($("#verify-opt-pin").click(function(){logic.nextStep(logic.login.personData)}),$("#verify-opt-finger").click(function(){$("#loading").removeClass("d-none"),logic.loadStep("login",5,window.config.language,logic.login.personData)}).removeClass("d-none"),$("#verify-opt-clave_unica").click(function(){}),$("#verify-opt-facial").click(function(){}),!window.logic.websocket.isConnecting&&window.logic.websocket.isConnect)return void window.setTimeout(window.logic.login[5].begin,1e3,e);$("#loading").addClass("d-none")}else 1==config.operator.useFingerprint?($("#loading").removeClass("d-none"),logic.loadStep("login",5,window.config.language,logic.login.personData)):logic.nextStep(logic.login.personData)},validate:function(){return!0}},3:{begin:function(e){$("footer").removeClass("d-none"),$("main").removeClass("nopadding"),$("#btnNextStep").removeClass("d-none").unbind("click").click(function(e){e.preventDefault(),logic.validateCurrent()&&logic.login[3].validatePin()}),$(".pin").keyup(function(e){var t=null;if(8==e.keyCode)(t=$(".pin")[$(".pin").index(this)-1])&&t.focus();else if(/^[0-9]$/.test(e.target.value)){if(""!=$(this).val()){var n=$(this).data("nextfocus");n&&$("#"+n).focus()}}else $(this).val("")}),$("#btnForgot").click(function(e){e.preventDefault(),$("#loading").removeClass("d-none"),logic.nextStep(logic.login.personData)}),$("#loading").addClass("d-none")},validate:function(){return!0},validatePin:function(){$("#loading").removeClass("d-none");var n="";$(".pin").each(function(e,t){n+=$(t).val()});var e={code:"PERSON",type:"VERIFY",subtype:"PIN",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:123456,appFlow:{code:"",step:""},client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[config.operator.identityDocument]},authenticationFactors:[{type:"PIN",subtype:"PIN",value:n}]}};$.ajax({url:config.baseUrl+"/api/v1/verify/pin",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(e),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":config.sessionId}}).done(function(e){if(logic.login.personData.pinRestorePage=!1,e.data.authenticationResult.authenticated)logic.login.result=e.data.authenticationResult,logic.loadStep("login",6,window.config.language,{personData:logic.login.personData,authentication:logic.login.result});else{if(logic.login.countRetry++,logic.login.countRetry>=window.config.retry.pin)return void logic.loadStep("login",7,window.config.language,{personData:logic.login.personData,success:!1});var t,n=window.config.retry.fingerprint-logic.login.countRetry,o="";o=1==n?window.text[logic.current.language].login.step3.attempsB:n+" "+window.text[logic.current.language].login.step3.attempsA,$("#attemps").removeClass("d-none"),$("#attemps").text(o),$(".pin").val(""),$("#input-pin-1").focus(),t=text[logic.current.language].errors.OPERATOR_NO_AUTH,$("#error-message").text(t),$("#error-container").removeClass("d-none"),$("#loading").addClass("d-none")}}).fail(logic.handleError).always(function(){})}},4:{personId:"",personIdFormatted:"",documentId:"",begin:function(e){switch(config.operator.pinRestoreMethod){case"KBA":logic.login[4].getKBA(e);break;case"ACEP":if($("#inputPersonId").blur(function(e){Validator.PersonId[logic.login.personData.docCountry][logic.login.personData.docType].validate(e.target.value)&&($(this).removeClass("error"),$(".label-error").html("&nbsp"),$(this).val(Formatter.PersonId[logic.login.personData.docCountry][logic.login.personData.docType].format(e.target.value)))}),logic.login.personData){var t=logic.login.personData;t.personId?(logic.login[4].personId=Formatter.PersonId[t.docCountry][t.docType].plain(t.personId),logic.login[4].personIdFormatted=Formatter.PersonId[t.docCountry][t.docType].format(t.personId),$("#inputPersonId").val(logic.login[4].personIdFormatted)):$("#inputPersonId").removeAttr("disabled")}else $("#inputPersonId").removeAttr("disabled");$("#helpSerial").click(function(e){e.preventDefault(),$("#modalSerial").modal()}),$("#loading").addClass("d-none")}$("#btnNextStep").removeClass("d-none").unbind("click").click(function(e){e.preventDefault(),$("#error-container").addClass("d-none"),logic.validateCurrent()&&("KBA"===config.operator.pinRestoreMethod?logic.login[4].validateQuestion():"ACEP"===config.operator.pinRestoreMethod?logic.login[4].validateDocument():($("#error-message").text("Método de recuperación no válido."),$("#error-container").removeClass("d-none")))})},getKBA:function(e){var t={code:"PERSON",type:"GET",subtype:"KBA",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:1549887978384,client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[config.operator.identityDocument]},authenticationFactors:[{type:"KBA",subtype:"KBA",questionType:"STATIC"}]}};$.ajax({url:config.baseUrl+"/api/v1/kba/get",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(t),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":config.sessionId}}).done(function(e){var t;e.data.authenticationFactors&&0<e.data.authenticationFactors.length?(logic.login.lastQuestion=atob(e.data.authenticationFactors[0].value),$("#lbl-question").text(atob(e.data.authenticationFactors[0].value))):(t=text[logic.current.language].errors.KBA_NO_DATA,$("#error-message").text(t),$("#error-container").removeClass("d-none"))}).fail(function(e){var t=text[logic.current.language].errors,n="";n=e.responseJSON?401===e.status||403===e.status?t.AUTH:404==e.status?t.KBA_NO_DATA:t.PROCESS:t.COMM,$("#error-message").text(n),$("#error-container").removeClass("d-none")}).always(function(){$("#loading").addClass("d-none")})},validateQuestion:function(){var e={code:"PERSON",type:"VERIFY",subtype:"KBA",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:1549887978384,client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[config.operator.identityDocument]},authenticationFactors:[{type:"KBA",subtype:"KBA",questionType:"STATIC",questions:{}}]}};e.data.authenticationFactors[0].questions[logic.login.lastQuestion]={answers:{RESP:$("#input-answer").val()}},$.ajax({url:config.baseUrl+"/api/v1/verify/kba",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(e),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":config.sessionId}}).done(function(e){e.data.authenticationResult.authenticated?(logic.login.personData=logic.login.personData,Object.assign({backTo:{process:"login",step:3}},logic.login.personData),config.operator.useFingerprint=!1,config.operator.usePin=!0,logic.login.personData.pinRestorePage=!0,logic.loadStep("login",8,window.config.language,logic.login.personData)):($("#error-message").text(text[logic.current.language].errors.QUESTION_MATCH),$("#error-container").removeClass("d-none"))}).fail(function(e){var t=text[logic.current.language].errors,n="";n=e.responseJSON?401===e.status||403===e.status?t.AUTH:404==e.status?t.OPERATOR_NO_DATA:t.PROCESS:t.COMM,$("#error-message").text(n),$("#error-container").removeClass("d-none")}).always(function(){$("#loading").addClass("d-none")})},validateDocument:function(){$("#error-container").addClass("d-none"),$("#loading").removeClass("d-none");var e={code:"DOCUMENT",type:"VALIDATE",subtype:"EXPIRY",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[{type:logic.login.personData.docType,countryCode:logic.login.personData.docCountry,number:logic.login[4].documentId,personalNumber:logic.login[4].personId,nationality:logic.login.personData.docCountry}]}}};$.ajax({url:config.baseUrl+"/api/v1/document/validate",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(e),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){if(200==e.status.status.code)logic.login.personData=logic.login.personData,Object.assign({backTo:{process:"login",step:3}},logic.login.personData),config.operator.useFingerprint=!1,config.operator.usePin=!0,logic.login.personData.pinRestorePage=!0,logic.loadStep("login",8,window.config.language,logic.login.personData);else{var t=text[logic.current.language].errors.PROCESS;406==e.status.status.code&&(t=e.status.status.message),$("#error-message").text(t),$("#error-container").removeClass("d-none")}}).fail(function(e){logic.handleError(e)}).always(function(){$("#loading").addClass("d-none")})},validate:function(){var n=!0;return"ACEP"===config.operator.pinRestoreMethod&&($(".label-error").html("&nbsp"),$(".person-data-input").removeClass("error"),$(".person-data-input").each(function(){var e=$(this).val(),t=$(this).data("required");(t=0!=t)&&""==e&&(n=!1,$(this).next("p.label-error").text(text[logic.current.language].errors.REQUIRED),$(this).addClass("error")),logic.login[4][$(this).data("name")]=e}),""!=logic.login[4].personId&&(Validator.PersonId[logic.login.personData.docCountry][logic.login.personData.docType].validate(logic.login[4].personId)?(logic.login[4].personIdFormatted=Formatter.PersonId[logic.login.personData.docCountry][logic.login.personData.docType].format(logic.login[4].personId),logic.login[4].personId=Formatter.PersonId[logic.login.personData.docCountry][logic.login.personData.docType].plain(logic.login[4].personId),logic.login[4].personId!=logic.login.personData.personId&&(n=!1,$("#inputPersonId").addClass("error").next("p.label-error").text(text[logic.current.language].errors.PERSONALNUMBER_ISDIFERENT))):(n=!1,$("#inputPersonId").addClass("error").next("p.label-error").text(text[logic.current.language].errors.INVALID_FORMAT)))),n}},5:{begin:function(e){if($("#loading").removeClass("d-none"),window.logic.websocket.isConnect||window.logic.websocket.isConnecting){if(window.logic.websocket.isConnecting)window.setTimeout(window.logic.login[5].begin,1e3,e);else if(!window.logic.websocket.isConnecting&&window.logic.websocket.isConnect){$(".finger-layer").addClass("d-none"),$("#btnNextStep").unbind("click").click(function(e){e.preventDefault(),logic.validateCurrent()&&logic.nextStep({})}),$("#loading").removeClass("d-none"),$("#inFinger").val("2"),$("#btnCapture").click(function(){$(".feedback").removeClass("d-none"),logic.login[5].captureOk=!1,window.logic.websocket.verify(logic.login[5].data,logic.login[5].matching),$("#error-container").addClass("d-none"),$("#btnCapture").addClass("disabled")}),$("#inFinger").on("change",function(){var e="assets/finger/"+$(this).val().toString()+".png";$("#image-swap").attr("src",e)});var t={code:"PERSON",type:"GET",subtype:"FINGERPRINT",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:123456,client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[config.operator.identityDocument]},authenticationFactors:[{type:"FINGERPRINT",subtype:"FINGERPRINT",id:0,minutiaesFormat:"0"}]}};$.ajax({url:config.baseUrl+"/api/v1/fingerprint/get",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(t),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":config.sessionId}}).done(function(e){var t;0==(logic.login[5].data=e).data.authenticationFactors.length?(t=text[logic.current.language].errors.OPERATOR_NO_DATA,$("#error-message").text(t),$("#error-container").removeClass("d-none")):($.each(e.data.authenticationFactors,function(e,t){$("#finger-layer-"+t.id).removeClass("d-none")}),$("#btnCapture").click())}).fail(function(e){var t=text[logic.current.language].errors,n="";n=e.responseJSON?401===e.status||403===e.status?t.AUTH:404==e.status?t.OPERATOR_NO_DATA:t.PROCESS:t.COMM,$("#error-message").text(n),$("#error-container").removeClass("d-none")}).always(function(){$("#loading").addClass("d-none")})}}else{var n=text[logic.current.language].errors.WS_CONNECTION,o={};if(null==config.handleErrs||0==config.handleErrs){var i={action:config.action,method:"FINGERPRINT",data:logic.login.result,operator:{sessionId:window.config.operator.sessionId},numError:5e3,msError:n};window.opener.callback(i)}else $("#loading").addClass("d-none"),o.numError=5e3,o.msError=n,o.action=config.action,o.result=logic.login.result,o.personIdFormatted=logic.login.personData.personIdFormatted,o.givennames=logic.login.personData.givennames,o.surnames=logic.login.personData.surnames,logic.loadStep("weberror",1,window.config.language,o)}},validate:function(){return!0},matching:function(e){if($(".feedback").addClass("d-none"),0==e.status.code){$("#loading").removeClass("d-none"),logic.login.result=e.data.authenticationResult;var t={code:"PERSON",type:"VERIFY",subtype:"FINGERPRINT",createdAt:e.createdAt,id:e.id,client:{operationId:config.operationId,companyId:config.companyId,username:"",machineId:e.client.machineId},data:{digitalIdentity:{identityDocuments:[config.operator.identityDocument]},authenticationFactors:e.data.authenticationFactors,authenticationResult:e.data.authenticationResult,info:e.data.info}};$.ajax({url:config.baseUrl+"/api/v1/verify/fingerprint",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(t),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":config.sessionId}}).done(function(e){if(e.data.authenticationResult.authenticated)logic.login.result=e.data.authenticationResult,logic.loadStep("login",6,window.config.language,{personData:logic.login.personData,authentication:logic.login.result});else{if(logic.login.countRetry++,logic.login.countRetry>=window.config.retry.fingerprint)return void logic.loadStep("login",7,window.config.language,{personData:logic.login.personData,success:!1});var t,n=window.config.retry.fingerprint-logic.login.countRetry,o="";o=1==n?window.text[logic.current.language].login.step3.attempsB:n+" "+window.text[logic.current.language].login.step3.attempsA,$("#attemps").removeClass("d-none"),$("#attemps").text(o),t=text[logic.current.language].errors.OPERATOR_NO_AUTH,$("#error-message").text(t),$("#error-container").removeClass("d-none"),$("#loading").addClass("d-none"),$("#btnCapture").removeClass("disabled"),$("#btnCapture").removeClass("d-none")}}).fail(function(e){var t=text[logic.current.language].errors,n="";e.responseJSON?401===e.status||403===e.status?n=t.AUTH:404==e.status?logic.loadStep("register",1,window.config.language,{backTo:{process:"login",step:5}}):n=t.PROCESS:n=t.COMM,$("#error-message").text(n),$("#error-container").removeClass("d-none"),$("#loading").addClass("d-none")}).always(function(){})}else{var n=text[logic.current.language].errors,o="";401===e.status.code||403===e.status.code?o=n.AUTH:404==e.status.code?logic.loadStep("register",1,window.config.language,{backTo:{process:"login",step:5}}):o=n.PROCESS,$("#error-message").text(o),$("#error-container").removeClass("d-none"),$("#btnCapture").removeClass("disabled")}}},6:{begin:function(e){$("#loading").removeClass("d-none"),$("#btnFinish").click(function(){var e=text[logic.current.language].errors.PROFILE_NO_DATA,t={action:config.action,method:"",data:logic.login.result,operator:{sessionId:window.config.operator.sessionId},numError:1e3,msError:e};window.opener.callback(t)}),window.logic.login[6].createSessionId()},validate:function(){return!0},createSessionId:function(){var e={code:"USER",type:"START",subtype:"SESSION",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:1549887978384,client:{operationId:config.operationId,companyId:config.companyId,username:"",password:""},data:{digitalIdentity:{identityDocuments:[config.operator.identityDocument]},authenticationResult:logic.login.result}},t=config.baseUrl+"/api/v1/session/operator";$.ajax({method:"POST",contentType:"application/json",dataType:"json",crossDomain:!0,url:t,headers:{"X-Auth-Token":config.apiKey},data:JSON.stringify(e)}).done(function(e){200==e.status.status.code&&(window.config.operator.sessionId=e.client.token,logic.current.sessionId=e.client.token,logic.nextStep({personData:logic.login.personData,success:!0}))}).fail(function(e){var t=text[logic.current.language].errors,n="";e.responseJSON&&404===e.status?n=t.PROFILE_NO_DATA:logic.nextStep({personData:logic.login.personData,success:!1}),$("#error-message").text(n),$("main").addClass("nopadding"),$("footer").addClass("d-none"),$("#loading").addClass("d-none")}).always(function(){})}},7:{begin:function(n){$("#btnFinish").click(function(){if(n.success){if($("body").removeClass("loggin"),"CREATE"==window.config.action)return void logic.loadStepModule("register",logic.pages,1,window.config.language,{});if("VERIFY"==window.config.action)return void logic.loadStepModule("verify",logic.pages,1,window.config.language,{})}else{var e=text[logic.current.language].errors.OPERATOR_NO_AUTH,t={action:config.action,method:"FINGERPRINT",data:logic.login.result,operator:{sessionId:window.config.operator.sessionId},numError:1e3,msError:e};window.opener.callback(t)}}),$("main").addClass("nopadding"),$("footer").addClass("d-none"),$("#loading").addClass("d-none")},validate:function(){return!0}},8:{begin:function(e){$(".pin").keyup(function(e){var t=null;if(8==e.keyCode)(t=$(".pin")[$(".pin").index(this)-1])&&t.focus();else if(/^[0-9]$/.test(e.target.value)){if(""!=$(this).val()){var n=$(this).data("nextfocus");n&&$("#"+n).focus()}}else $(this).val("")}),$("#btnNextStep").unbind("click").click(function(e){e.preventDefault(),logic.validateCurrent()&&(!1===config.operator.pinRestore?logic.login[9].createPin():"KBA"===config.operator.pinRestoreMethod?logic.nextStep(logic.login.personData):logic.login[9].createPin())}),$("#loading").addClass("d-none")},validate:function(){$("#pin-invalid-error").addClass("d-none"),$(".pin").removeClass("error");var e="",t="";$(".pin-1 .pin").each(function(){e+=$(this).val()}),$(".pin-2 .pin").each(function(){t+=$(this).val()});var n=e===t&&6===e.length;return n?logic.login.personData.pin=e:($("#pin-invalid-error").removeClass("d-none"),$(".pin").addClass("error"),$(".pin").val(""),$("#input-pin-1").focus()),n}},9:{begin:function(e){$("#btnNextStep").unbind("click").click(function(e){e.preventDefault(),logic.validateCurrent()&&logic.login[9].createPin()})},validate:function(){$("#error-container").addClass("d-none");var n=!0;return $(".kba").each(function(){var e=$(this).val(),t=$(this).data("required");(t=0!=t)&&""==e&&(n=!1,$(this).addClass("error"))}),n||($("#error-message").text(text[logic.current.language].errors.REQUIRED_FIELD),$("#error-container").removeClass("d-none")),n},createPin:function(){$("#loading").removeClass("d-none");var e={code:"PERSON",type:"REGISTER",subtype:"PIN",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{personId:logic.login.personData.internalId,emailAddresses:[],addresses:[],contactPhones:[],identityDocuments:[]},authenticationFactors:[{type:"PIN",subtype:"PIN",value:logic.login.personData.pin,checksum:""},{type:"KBA",subtype:"KBA",questionType:"STATIC",questions:{},checksum:""}]}};config.operator.pinRestore&&"KBA"==config.operator.pinRestoreMethod?e.data.authenticationFactors[1].questions[$("#inputQuestion").val()]={answers:{RESP:$("#inputAnswer").val()}}:e.data.authenticationFactors.splice(1,1),$.ajax({url:config.baseUrl+"/api/v1/pin/create",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(e),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){!1===config.operator.pinRestore?logic.nextStep(logic.login.personData):"KBA"==config.operator.pinRestoreMethod?logic.nextStep(logic.login.personData):logic.loadStep("login",10,window.config.language,logic.login.personData)}).fail(logic.handleError).always(function(){$("#loading").addClass("d-none")})}},10:{begin:function(e){$("#btnFinish").click(function(){logic.loadStep("login",3,window.config.language,logic.login.personData)}),$("main").addClass("nopadding"),$("footer").addClass("d-none")}}},window.logic||(window.logic={}),window.logic.person={loadedParams:!1,begin:function(e){var t="",n=!0,o=0;if(e.backTo&&(logic.personinit.backTo=e.backTo),1==logic.personinit.data.documentVerified&&$("#inputDocumentId").attr("disabled",!0),logic.validateProfile("CREATE_PERSON")||logic.validateProfile("UPDATE_PERSON")?logic.person.initPerson():logic.validateProfile("UPDATE_AUTH")||"PENDI"==logic.personStatus?logic.nextStepModule(logic.personinit.data):(n=!1,o=1001),!n)if(t=text[logic.current.language].errors.INVALID_PROFILE,null==config.handleErrs||0==config.handleErrs){var i={action:config.action,data:null,operator:{sessionId:window.config.operator.sessionId},numError:o,msError:t};window.opener.callback(i)}else{var a={};a.numError=o,a.msError=t,a.action=config.action,a.personIdFormatted=logic.personinit.data.personIdFormatted,a.givennames=logic.personinit.data.givennames,a.surnames=logic.personinit.data.surnames,logic.loadStep("weberror",1,window.config.language,a)}},validate:function(){$(".label-error").html("&nbsp");var n=!0;$(".person-data-input").removeClass("error"),$(".person-data-input").each(function(){var e=$(this).val(),t=$(this).data("required");(t=0!=t)&&""==e&&(n=!1,$(this).next("p.label-error").text(text[logic.current.language].errors.REQUIRED),$(this).addClass("error")),logic.personinit.data[$(this).data("name")]=e}),logic.personinit.data.docType||(n=!1),logic.personinit.data.docCountry||(n=!1);var e=/^\+?([0-9]{2})\)?[-. ]?([0-9]{1})[-. ]?([0-9]{4})[-. ]?([0-9]{4})$/;$(".phone-input").each(function(){e.test($(this).val())||(n=!1,$(this).next("p.label-error").text(text[logic.current.language].errors.INVALID_FORMAT),$(this).addClass("error"))});var t=/^(([^<>()\[\]\\.,;:\s@']+(\.[^<>()\[\]\\.,;:\s@']+)*)|('.+'))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return $(".email-input").each(function(){var e=$(this).data("required");(e=0!=e)||""!=$(this).val()&&(e=!0),e&&!t.test($(this).val())&&(n=!1,$(this).next("p.label-error").text(text[logic.current.language].errors.INVALID_FORMAT),$(this).addClass("error"))}),Validator.PersonId[logic.personinit.data.docCountry][logic.personinit.data.docType].validate(logic.personinit.data.personId)?(logic.personinit.data.personIdFormatted=Formatter.PersonId[logic.personinit.data.docCountry][logic.personinit.data.docType].format(logic.personinit.data.personId),logic.personinit.data.personId=Formatter.PersonId[logic.personinit.data.docCountry][logic.personinit.data.docType].plain(logic.personinit.data.personId)):(n=!1,$("#inputPersonId").addClass("error").next("p.label-error").text(text[logic.current.language].errors.INVALID_FORMAT)),moment($("#inputBirthdate").val(),"YYYY-MM-DD").isSameOrAfter(moment())&&(n=!1,$("#inputBirthdate").addClass("error")),n},loadDataFromParams:function(){if(logic.person){if(logic.person.loadedParams=!0,logic.personinit.data){var e=logic.personinit.data;if(e.dob){var t=moment(e.dob,"YYYYMMDD");t.isValid()&&$("#inputBirthdate").val(t.format("YYYY-MM-DD"))}e.gender&&$("#inputGender").val(e.gender),e.surnames&&$("#inputSurnames").val(e.surnames),e.givennames&&$("#inputGivennames").val(e.givennames),e.email&&$("#inputEmail").val(e.email),e.email2&&$("#inputEmail2").val(e.email2),e.cellphone&&$("#inputCellphone").val(e.cellphone),e.documentId&&$("#inputDocumentId").val(e.documentId),e.docType&&$("#inputDocType").val(e.docType),e.docCountry&&$("#inputDocCountry").val(e.docCountry),e.personId&&(e.personId=Formatter.PersonId[logic.personinit.data.docCountry][logic.personinit.data.docType].plain(e.personId),logic.personinit.data.personIdFormatted=Formatter.PersonId[logic.personinit.data.docCountry][logic.personinit.data.docType].format(e.personId),$("#inputPersonId").val(logic.personinit.data.personIdFormatted))}$("#inputPersonId").change()}},initPerson:function(){$("#inputBirthdate").attr("max",moment().format("YYYY-MM-DD")).val(moment().subtract(18,"years").format("YYYY-MM-DD")),logic.person.loadDataFromParams(),$("footer").removeClass("d-none"),$("#btnNextStep").removeClass("d-none").unbind("click").click(function(e){e.preventDefault(),logic.validateCurrentModule()&&(null==logic.personinit.data.internalId?logic.person.createPerson():0!=logic.personinit.data.internalId?logic.person.updatePerson():logic.person.createPerson())}),$(".person-data-input").change(function(){var e=$(this).val(),t=$(this).data("required");(t=0!=t)&&""==e?($(this).next("p.label-error").text(text[logic.current.language].errors.REQUIRED),$(this).addClass("error")):($(this).removeClass("error"),$(this).next("p.label-error").html("&nbsp"))}),$("#inputPersonId").change(function(){$(this).removeClass("error");var e=$(this).val();Validator.PersonId[logic.personinit.data.docCountry][logic.personinit.data.docType].validate(e)?$(this).next("p.label-error").html("&nbsp"):($(this).addClass("error"),$(this).next("p.label-error").text(text[logic.current.language].errors.INVALID_FORMAT)),e=Formatter.PersonId[logic.personinit.data.docCountry][logic.personinit.data.docType].format(e),$(this).val(e)}),$("#helpSerial").click(function(e){e.preventDefault(),$("#modalSerial").modal()});var e=/^\+?([0-9]{2})\)?[-. ]?([0-9]{1})[-. ]?([0-9]{4})[-. ]?([0-9]{4})$/;$(".phone-input").change(function(){$(this).removeClass("error"),e.test($(this).val())?$(this).next("p.label-error").html("&nbsp"):($(this).next("p.label-error").text(text[logic.current.language].errors.INVALID_FORMAT),$(this).addClass("error"))});var t=/^(([^<>()\[\]\\.,;:\s@']+(\.[^<>()\[\]\\.,;:\s@']+)*)|('.+'))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;$(".email-input").change(function(){$(this).removeClass("error");var e=$(this).data("required");(e=0!=e)||""!=$(this).val()&&(e=!0),e&&!t.test($(this).val())?($(this).next("p.label-error").text(text[logic.current.language].errors.INVALID_FORMAT),$(this).addClass("error")):$(this).next("p.label-error").html("&nbsp")}),$("#loading").addClass("d-none")},createPerson:function(){$("#error-container").addClass("d-none"),$("#loading").removeClass("d-none");var e=[{type:"PERSONAL",address:logic.personinit.data.email,primary:!0}];logic.personinit.data.email2&&""!=logic.personinit.data.email2&&e.push({type:"PERSONAL",address:logic.personinit.data.email2,primary:!1});var t={code:"PERSON",type:"REGISTER",subtype:"PERSON",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{personalData:{givenNames:logic.personinit.data.givennames,surnames:logic.personinit.data.surnames,dob:moment(logic.personinit.data.birthdate,"YYYY-MM-DD").format("YYYYMMDD"),gender:logic.personinit.data.gender},emailAddresses:e,contactPhones:[{type:"MOBILE",countryCode:1,areaCode:1,number:logic.personinit.data.cellphone,primary:!0}],identityDocuments:[{type:logic.personinit.data.docType,countryCode:logic.personinit.data.docCountry,number:logic.personinit.data.documentId,personalNumber:logic.personinit.data.personId,issueDate:moment(logic.personinit.data.issueDate,"YYYY-MM-DD").format("YYYYMMDD"),expiryDate:moment(logic.personinit.data.expiryDate,"YYYY-MM-DD").format("YYYYMMDD"),issuingAuthority:logic.personinit.data.issuingAuthority,issuePlace:logic.personinit.data.issuePlace,nationality:logic.personinit.data.docCountry}],authenticationFactors:[]}}};$.ajax({url:config.baseUrl+"/api/v1/person/create",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(t),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){if(200==e.status.status.code||202==e.status.status.code||204==e.status.status.code)202==e.status.status.code||204==e.status.status.code?logic.personinit.data.documentPendi=!0:logic.personinit.data.documentPendi=!1,e.data.digitalIdentity.personId&&(logic.personinit.data.internalId=e.data.digitalIdentity.personId,logic.nextStepModule(logic.personinit.data));else{var t=text[logic.current.language].errors,n=t.PROCESS;302==e.status.status.code&&(n=t.PERSON_FOUND),406==e.status.status.code&&(n=e.status.status.message),$("#error-message").text(n),$("#error-container").removeClass("d-none"),$("#loading").addClass("d-none")}}).fail(function(e){logic.handleError(e)}).always(function(){$("#loading").addClass("d-none")})},updatePerson:function(){$("#error-container").addClass("d-none"),$("#loading").removeClass("d-none");var e=[{type:"PERSONAL",address:logic.personinit.data.email,primary:!0}];logic.personinit.data.email2&&""!=logic.personinit.data.email2&&e.push({type:"PERSONAL",address:logic.personinit.data.email2,primary:!1});var t={code:"PERSON",type:"UPDATE",subtype:"PERSON",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{personalData:{givenNames:logic.personinit.data.givennames,surnames:logic.personinit.data.surnames,dob:moment(logic.personinit.data.birthdate,"YYYY-MM-DD").format("YYYYMMDD"),gender:logic.personinit.data.gender},emailAddresses:e,contactPhones:[{type:"MOBILE",countryCode:1,areaCode:1,number:logic.personinit.data.cellphone,primary:!0}],identityDocuments:[{type:logic.personinit.data.docType,countryCode:logic.personinit.data.docCountry,number:logic.personinit.data.documentId,personalNumber:logic.personinit.data.personId,issueDate:"20190101",expiryDate:"21001231",issuingAuthority:"",nationality:logic.personinit.data.docCountry}],authenticationFactors:[]}}};$.ajax({url:config.baseUrl+"/api/v1/person/update",datatype:"json",type:"PUT",crossDomain:!0,contentType:"application/json",data:JSON.stringify(t),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){if(200==e.status.status.code||202==e.status.status.code||204==e.status.status.code)202==e.status.status.code||204==e.status.status.code?logic.personinit.data.documentPendi=!0:logic.personinit.data.documentPendi=!1,e.data.digitalIdentity.personId&&(logic.personinit.data.internalId=e.data.digitalIdentity.personId,logic.nextStepModule(logic.personinit.data));else{var t=text[logic.current.language].errors.PROCESS;406==e.status.status.code&&(t=e.status.status.message),$("#error-message").text(t),$("#error-container").removeClass("d-none"),$("#loading").addClass("d-none")}}).fail(function(e){logic.handleError(e)}).always(function(){$("#loading").addClass("d-none")})}},window.logic||(window.logic={}),window.logic.personauth={begin:function(e){$("#loading").removeClass("d-none"),config.method?"PIN"==config.method?logic.nextStepModule(logic.personinit.data):"FINGERPRINT"==config.method&&logic.loadStepModule("verify",logic.pages,5,window.config.language,logic.personinit.data):($("#verify-opt-pin").click(function(){logic.nextStepModule(logic.personinit.data)}),$("#verify-opt-finger").click(function(){$("#loading").removeClass("d-none"),logic.loadStepModule("verify",logic.pages,5,window.config.language,logic.personinit.data)}).removeClass("d-none"),$("#verify-opt-clave_unica").click(function(){}),$("#verify-opt-facial").click(function(){}),$("#loading").addClass("d-none"))},validate:function(){return!0}},window.logic||(window.logic={}),window.logic.persondocument={paramIdValue:"",begin:function(e){$("#loading").removeClass("d-none"),$("footer").removeClass("d-none"),e.backTo&&(logic.personinit.backTo=e.backTo),logic.personinit.data.docCountry&&"COL"!=logic.personinit.data.docCountry&&($("#docInfo").addClass("d-none"),$("#docTypeInput").addClass("d-none"),$("#inputIssueDate").attr("data-required",!1),$("#inputIssuePlace").attr("data-required",!1),$("#selectDocType").attr("data-required",!1)),logic.personinit.data.docCountry&&"COL"==logic.personinit.data.docCountry&&($("#docId").addClass("d-none"),$("#inputPersonId").removeAttr("disabled"),$("#inputPersonId").removeAttr("placeholder"),$("#inputDocumentId").attr("data-required",!1),$("#inputPersonId").blur(function(e){Validator.PersonId[logic.personinit.data.docCountry][logic.personinit.data.docType].validate(e.target.value)&&($(this).removeClass("error"),$(".label-error").html("&nbsp"),$(this).val(Formatter.PersonId[logic.personinit.data.docCountry][logic.personinit.data.docType].format(e.target.value)))})),logic.persondocument.loadDataFromParams(),$("#btnNextStep").removeClass("d-none").unbind("click").click(function(e){e.preventDefault(),logic.validateCurrentModule()&&logic.persondocument.validateDocument()}),$("#helpSerial").click(function(e){e.preventDefault(),$("#modalSerial").modal()}),$("#loading").addClass("d-none")},validate:function(){$(".label-error").html("&nbsp");var n=!0;return $(".person-data-input").removeClass("error"),$(".person-data-input").each(function(){var e=$(this).val(),t=$(this).data("required");(t=0!=t)&&""==e&&(n=!1,$(this).next("p.label-error").text(text[logic.current.language].errors.REQUIRED),$(this).addClass("error")),logic.personinit.data[$(this).data("name")]=e}),logic.personinit.data.docType||(n=!1),logic.personinit.data.docCountry||(n=!1),Validator.PersonId[logic.personinit.data.docCountry][logic.personinit.data.docType].validate(logic.personinit.data.personId)?(logic.personinit.data.personIdFormatted=Formatter.PersonId[logic.personinit.data.docCountry][logic.personinit.data.docType].format(logic.personinit.data.personId),logic.personinit.data.personId=Formatter.PersonId[logic.personinit.data.docCountry][logic.personinit.data.docType].plain(logic.personinit.data.personId)):(n=!1,$("#inputPersonId").addClass("error").next("p.label-error").text(text[logic.current.language].errors.INVALID_FORMAT)),logic.personinit.data.docCountry&&"COL"==logic.personinit.data.docCountry&&(logic.personinit.data.personId!=logic.persondocument.paramIdValue&&(n=!1,$("#inputPersonId").addClass("error").next("p.label-error").text("Cédula no coincide")),logic.personinit.data.docType!=$("#selectDocType").val()&&(n=!1,$("#selectDocType").addClass("error").next("p.label-error").text("Tipo de Cédula no coincide"))),n},loadDataFromParams:function(){if(logic.person&&logic.personinit.data){var e=logic.personinit.data;if(e.personId&&(e.personId=Formatter.PersonId[logic.personinit.data.docCountry][logic.personinit.data.docType].plain(e.personId),logic.personinit.data.personIdFormatted=Formatter.PersonId[logic.personinit.data.docCountry][logic.personinit.data.docType].format(e.personId),logic.persondocument.paramIdValue=Formatter.PersonId[logic.personinit.data.docCountry][logic.personinit.data.docType].plain(e.personId),logic.personinit.data.docCountry&&"COL"==logic.personinit.data.docCountry?($("#inputDocumentId").val(e.personId),$("#inputPersonId").val("")):$("#inputPersonId").val(logic.personinit.data.personIdFormatted)),e.documentId,e.issueDate){var t=moment(e.issueDate,"YYYYMMDD");t.isValid()&&$("#inputIssueDate").val(t.format("YYYY-MM-DD"))}else logic.personinit.data.issueDate="1900-01-01",$("#inputIssueDate").val("1900-01-01");e.issuePlace?$("#inputIssuePlace").val(e.issuePlace):e.issuePlace="",e.expiryDate&&""!=e.expiryDate||(e.expiryDate="2100-12-31"),e.issuingAuthority&&""!=e.issuingAuthority||(e.issuingAuthority="")}},validateDocument:function(){$("#error-container").addClass("d-none"),$("#loading").removeClass("d-none");var e={code:"DOCUMENT",type:"VALIDATE",subtype:"EXPIRY",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[{type:logic.personinit.data.docType,countryCode:logic.personinit.data.docCountry,number:logic.personinit.data.documentId,personalNumber:logic.personinit.data.personId,nationality:logic.personinit.data.docCountry}]}}};$.ajax({url:config.baseUrl+"/api/v1/document/validate",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(e),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){if(200==e.status.status.code||202==e.status.status.code||204==e.status.status.code)logic.personinit.data.documentVerified=!0,logic.nextStepModule(logic.personinit.data);else{logic.personinit.data.documentVerified=!1;var t=text[logic.current.language].errors.PROCESS;406==e.status.status.code&&(t=e.status.status.message),$("#error-message").text(t),$("#error-container").removeClass("d-none")}}).fail(function(e){logic.handleError(e)}).always(function(){$("#loading").addClass("d-none")})}},window.logic||(window.logic={}),window.logic.personinit={data:{},loadedParams:!1,backTo:null,countRetry:0,result:{},begin:function(e){var t=0,n=!0,o=text[logic.current.language].errors;if($("#loading").removeClass("d-none"),logic.getProfiles(),e.backTo&&(logic.personinit.backTo=e.backTo),"CREATE"==window.config.action?logic.personinit.getPerson():"VERIFY"==window.config.action?(logic.personinit.loadedParams||logic.personinit.loadDataFromConfig(),logic.personinit.getPerson()):(o=o.INVALID_ACTION,n=!(t=1e3)),!n)if(null==config.handleErrs||0==config.handleErrs){var i={action:config.action,data:null,operator:{sessionId:window.config.operator.sessionId},numError:t,msError:o};window.opener.callback(i)}else{var a={};a.personIdFormatted=Formatter.PersonId[config.digitalIdentity.identityDocuments[0].countryCode][config.digitalIdentity.identityDocuments[0].type].format(config.digitalIdentity.identityDocuments[0].personalNumber),a.numError=t,a.msError=o,a.action=config.action,logic.loadStep("weberror",1,window.config.language,a)}},loadDataFromConfig:function(){if(config.digitalIdentity){if(logic.personinit.data.pinRestore=config.pinRestore,logic.personinit.data.pinRestoreMethod=config.pinRestoreMethod,null!=config.useVerifyExt&&1==config.useVerifyExt?(logic.personinit.data.useVerifyExt=!0,config.useFingerprint=!0,config.usePin=!1,config.method="FINGERPRINT"):logic.personinit.data.useVerifyExt=!1,logic.personinit.data.internalId=0,config.digitalIdentity.personalData&&(logic.personinit.data=config.digitalIdentity.personalData),logic.personinit.data.email="",logic.personinit.data.email2="",config.digitalIdentity.emailAddresses){var e=config.digitalIdentity.emailAddresses;0<e.length&&(e[0].address&&(logic.personinit.data.email=e[0].address),1<e.length&&e[1].address&&(logic.personinit.data.email2=e[1].address))}if(logic.personinit.data.cellphone="",config.digitalIdentity.contactPhones){var t=config.digitalIdentity.contactPhones;0<t.length&&t[0].number&&(logic.personinit.data.cellphone=t[0].number)}if(logic.personinit.data.docType="ID",logic.personinit.data.docCountry="CL",logic.personinit.data.documentId="",logic.personinit.data.documentVerified=!1,config.digitalIdentity.identityDocuments){var n=config.digitalIdentity.identityDocuments;0<n.length&&(n[0].number&&(logic.personinit.data.documentId=n[0].number),n[0].type&&(logic.personinit.data.docType=n[0].type),n[0].countryCode&&(logic.personinit.data.docCountry=n[0].countryCode),n[0].personalNumber&&(logic.personinit.data.personId=n[0].personalNumber,logic.personinit.data.personIdFormatted=Formatter.PersonId[logic.personinit.data.docCountry][logic.personinit.data.docType].format(logic.personinit.data.personId)))}logic.personinit.loadedParams=!0}},getPerson:function(){var r=text[logic.current.language].errors,s="",c=0,a=!0;logic.personinit.data.documentVerified=!1;var e={code:"PERSON",type:"GET",subtype:"PERSON",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:1549887978384,client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[config.digitalIdentity.identityDocuments[0]]}}};$.ajax({method:"POST",contentType:"application/json",dataType:"json",crossDomain:!0,url:config.baseUrl+"/api/v1/person/get",headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId},data:JSON.stringify(e)}).done(function(e){if(logic.validateAction("UPDATE")||logic.validateAction("VERIFY")||"PENDI"==logic.personStatus||window.config.operator.identityDocument.personalNumber==window.config.digitalIdentity.identityDocuments[0].personalNumber){"CREATE"==window.config.action&&(logic.validateProfile("UPDATE_AUTH")||"PENDI"===logic.personStatus||(config.useFingerprint=!1,config.usePin=!1)),logic.personinit.data.internalId=e.data.digitalIdentity.personId,logic.personinit.data.gender=e.data.digitalIdentity.personalData.gender,logic.personinit.data.surnames=e.data.digitalIdentity.personalData.surnames,logic.personinit.data.givennames=e.data.digitalIdentity.personalData.givenNames,logic.personinit.data.dob=e.data.digitalIdentity.personalData.dob,logic.personinit.data.docType=e.data.digitalIdentity.identityDocuments[0].type,logic.personinit.data.docCountry=e.data.digitalIdentity.identityDocuments[0].countryCode,logic.personinit.data.personId=e.data.digitalIdentity.identityDocuments[0].personalNumber,logic.personinit.data.documentId=e.data.digitalIdentity.identityDocuments[0].number,logic.personinit.data.statusDocument=e.data.digitalIdentity.identityDocuments[0].statusDocument,logic.personinit.data.personIdFormatted=Formatter.PersonId[logic.personinit.data.docCountry][logic.personinit.data.docType].format(logic.personinit.data.personId),logic.personinit.data.issueDate=e.data.digitalIdentity.identityDocuments[0].issueDate,logic.personinit.data.issuePlace=e.data.digitalIdentity.identityDocuments[0].issuePlace,logic.personinit.data.expiryDate=e.data.digitalIdentity.identityDocuments[0].expiryDate,logic.personinit.data.issuingAuthority=e.data.digitalIdentity.identityDocuments[0].issuingAuthority,logic.personinit.data.pinRestore=window.config.pinRestore,logic.personinit.data.pinRestoreMethod=window.config.pinRestoreMethod,logic.personinit.data.pinRestorePage=!1,"VERIFY"==window.config.action&&(null!=window.config.useVerifyExt&&1==window.config.useVerifyExt?(logic.personinit.data.useVerifyExt=!0,config.useFingerprint=!0,config.usePin=!1,config.method="FINGERPRINT"):logic.personinit.data.useVerifyExt=!1),logic.personinit.data.statusDocument&&"VERIFICACION_OK"==logic.personinit.data.statusDocument&&(logic.personinit.data.documentVerified=!0);var t=e.data.digitalIdentity.contactPhones,n=e.data.digitalIdentity.emailAddresses;t&&0<t.length&&$.each(t,function(e,t){t.primary&&(logic.personinit.data.cellphone=t.number)}),n&&0<n.length&&$.each(n,function(e,t){t.primary?logic.personinit.data.email=t.address:logic.personinit.data.email2=t.address}),logic.validateProfile("UPDATE_PERSON")&&"CREATE"==window.config.action||logic.validateProfile("VERIFY_PERSON")&&"VERIFY"==window.config.action?logic.nextStepModule(logic.personinit.data):!logic.validateProfile("UPDATE_AUTH")&&"PENDI"!=logic.personStatus||"CREATE"!=window.config.action?window.config.operator.identityDocument.personalNumber==window.config.digitalIdentity.identityDocuments[0].personalNumber?"VERIFY"==window.config.action?logic.nextStepModule(logic.personinit.data):logic.validateProfile("CREATE_PIN")?(config.useFingerprint=!1,config.usePin=!0,logic.loadStepModule("register",logic.pages,4,window.config.language,logic.personinit.data)):(a=!1,c=10002):(a=!1,c=1001):logic.loadStepModule("register",logic.pages,4,window.config.language,logic.personinit.data)}else a=!(c=1e3);if(!a)if(s=r.INVALID_PROFILE,null==config.handleErrs||0==config.handleErrs){var o={action:config.action,data:null,operator:{sessionId:window.config.operator.sessionId},numError:c,msError:s};window.opener.callback(o)}else{var i={};i.numError=c,i.msError=s,i.action=config.action,i.personIdFormatted=logic.personinit.data.personIdFormatted,i.givennames=logic.personinit.data.givennames,i.surnames=logic.personinit.data.surnames,logic.loadStep("weberror",1,window.config.language,i)}}).fail(function(e){if("VERIFY"==window.config.action&&null!=config.useVerifyExt&&1==config.useVerifyExt)return window.config.digitalIdentity.personId=1,logic.personinit.data.internalId=logic.personinit.data.personId,logic.personinit.data.personIdFormatted=Formatter.PersonId[logic.personinit.data.docCountry][logic.personinit.data.docType].format(logic.personinit.data.personId),void logic.nextStepModule(logic.personinit.data);if(e.responseJSON)if(c=e.status,401===e.status||403===e.status)s=r.AUTH;else if(404==e.status)if("CREATE"==window.config.action){if(logic.validateProfile("CREATE_PERSON"))return logic.personinit.loadDataFromConfig(),void logic.nextStepModule(logic.personinit.data);s=r.INVALID_PROFILE}else{if("VERIFY"==window.config.action){var t=logic.getFlow("reg-simple"),n=logic.pages,o=Object.assign({backTo:{process:"verify",pages:n,step:1}},logic.personinit.data);return void logic.loadStepModule("register",t,1,window.config.language,o)}s=r.INVALID_ACTION}else s=r.PROCESS;else s=r.COMM,c=1e3;if(null==config.handleErrs||0==config.handleErrs){var i={action:config.action,data:logic.personinit.result,operator:{sessionId:window.config.operator.sessionId},numError:c,msError:s};window.opener.callback(i)}else{var a={};a.numError=c,a.msError=s,a.action=config.action,a.personIdFormatted=Formatter.PersonId[config.digitalIdentity.identityDocuments[0].countryCode][config.digitalIdentity.identityDocuments[0].type].format(config.digitalIdentity.identityDocuments[0].personalNumber),a.result=logic.personinit.result,logic.loadStep("weberror",1,window.config.language,a)}}).always(function(){$("#loading").addClass("d-none")})}},window.logic||(window.logic={}),window.logic.pfingerprintauth={data:{},captureOk:!1,fingers:[],contUpd:0,begin:function(e){if($("#loading").removeClass("d-none"),$("footer").removeClass("d-none"),window.logic.websocket.isConnect||window.logic.websocket.isConnecting){if(window.logic.websocket.isConnecting)window.setTimeout(window.logic.pfingerprintauth.begin,1e3,e);else if(!window.logic.websocket.isConnecting&&window.logic.websocket.isConnect){$("#btnNextStep").addClass("d-none"),$("#btnNextStep").unbind("click").click(function(e){e.preventDefault(),logic.validateCurrentModule()&&logic.nextStepModule({})});var o=0;$(".hands__hand__fingers__item").click(function(e){var n;n=e.currentTarget.id.replace("hand-layer-",""),"hands__hand__fingers__item hands__hand__fingers__item--active"==e.currentTarget.className?($.each(logic.pfingerprintauth.fingers,function(e,t){t==n&&(logic.pfingerprintauth.fingers.splice(e,1),o-=1)}),$("#"+e.currentTarget.id).removeClass("hands__hand__fingers__item--active")):(logic.pfingerprintauth.fingers[o]=n,o+=1,$("#"+e.currentTarget.id).addClass("hands__hand__fingers__item--active"))}),$(".finger-layer").addClass("d-none"),$("#loading").removeClass("d-none"),$("#inFinger").val("2"),$("#btnCapture").click(function(){var e=logic.websocket.captureQtyVerifyExt;if($("#error-container").addClass("d-none"),logic.pfingerprintauth.captureOk=!1,0==logic.personinit.data.useVerifyExt){$("#total-capture-text").text(e);var t=window.text[logic.current.language].pages.pfingerprintauth.userMessage.partA+$("#inFinger").children("option:selected").text()+window.text[logic.current.language].pages.pfingerprintauth.userMessage.partB;$("#user-message").text(t),window.logic.websocket.verify(logic.pfingerprintauth.data,logic.pfingerprintauth.matching)}else{if(logic.pfingerprintauth.fingers.length<=1)return $("#error-message").text(window.text[logic.current.language].errors.NO_FINGERS_SELECTED),void $("#error-container").removeClass("d-none");1<e?$("#total-capture-text").text(e+logic.pfingerprintauth.fingers.length):$("#total-capture-text").text(logic.pfingerprintauth.fingers.length),logic.pfingerprintauth.contUpd=0,window.logic.websocket.capture(logic.pfingerprintauth.fingers[0],logic.pfingerprintauth.fingers,e,logic.pfingerprintauth.updateFingerprint,logic.pfingerprintauth.matching)}$(".feedback").removeClass("d-none"),$(".progress-status").removeClass("d-none"),$("#btnCapture").addClass("disabled"),$("#btnCapture").addClass("d-none"),$("#current-capture-text").text("1").data("number",1),$("#capture-progress").removeClass("d-none")}),$("#inFinger").on("change",function(){var e="assets/finger/"+$(this).val().toString()+".png";$("#image-swap").attr("src",e)});var t="N";logic.personinit.data.useVerifyExt&&(t="S");var n={code:"PERSON",type:"GET",subtype:"FINGERPRINT",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:123456,client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[config.digitalIdentity.identityDocuments[0]]},authenticationFactors:[{type:"FINGERPRINT",subtype:"FINGERPRINT",id:0,minutiaesFormat:"0"}],settings:{codParametro:["VERIFYEXT"],indicador:[t]}}};$.ajax({url:config.baseUrl+"/api/v1/fingerprint/get",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(n),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){if(logic.pfingerprintauth.data=e,0==logic.personinit.data.useVerifyExt)if(0==e.data.authenticationFactors.length){var t=text[logic.current.language].errors.NOT_FOUND_FINGERPRINTS;$("#error-message").text(t),$("#error-container").removeClass("d-none")}else $.each(e.data.authenticationFactors,function(e,t){$("#finger-layer-"+t.id).removeClass("d-none")}),$("#btnCapture").click()}).fail(function(e){var t=text[logic.current.language].errors,n="";if(e.responseJSON)if(401===e.status||403===e.status)n=t.AUTH;else if(404==e.status){if(0==logic.personinit.data.useVerifyExt){var o=logic.getFlow("reg-simple"),i=logic.pages,a=Object.assign({backTo:{process:"verify",pages:i,step:1}},logic.personinit.data);logic.loadStepModule("register",o,1,window.config.language,a)}}else n=t.PROCESS;else n=t.COMM;$("#error-message").text(n),$("#error-container").removeClass("d-none")}).always(function(){$("#loading").addClass("d-none")})}}else{var i=text[logic.current.language].errors.WS_CONNECTION,a={};if(null==config.handleErrs||0==config.handleErrs){var r={action:config.action,method:"FINGERPRINT",data:logic.personinit.result,operator:{sessionId:window.config.operator.sessionId},numError:5e3,msError:i};window.opener.callback(r)}else $("#loading").addClass("d-none"),a.numError=5e3,a.msError=i,a.action=config.action,a.result=logic.personinit.result,a.personIdFormatted=logic.personinit.data.personIdFormatted,a.givennames=logic.personinit.data.givennames,a.surnames=logic.personinit.data.surnames,logic.loadStep("weberror",1,window.config.language,a)}},validate:function(){return!0},updateFingerprint:function(e){if(0==e.status.code){var t="";if($("#error-container").addClass("d-none"),e.data.authenticationFactors){if(e.data.authenticationFactors[0].preview){logic.pfingerprintauth.contUpd=logic.pfingerprintauth.contUpd+1,t=100*logic.pfingerprintauth.contUpd/(2*logic.pfingerprintauth.fingers.length)+"%",$(".progress-bar").text(t),$(".progress-bar").css("width",t),$("#error-container").addClass("d-none");var n=$("#current-capture-text").data("number");n=parseInt(n)+1,$("#current-capture-text").text(n).data("number",n),$("#imgFingerprint").attr("src","data:image/jpeg;base64,"+e.data.authenticationFactors[0].preview)}}else if(e.data.config&&e.data.config.fingerId){logic.pfingerprintauth.contUpd=logic.pfingerprintauth.contUpd+1,t=100*logic.pfingerprintauth.contUpd/(2*logic.pfingerprintauth.fingers.length)+"%",$(".progress-bar").text(t),$(".progress-bar").css("width",t);var o=window.text[logic.current.language].pages.pfingerprintauth.captureView.message.partA+" "+window.text[logic.current.language].pages.pfingerprintauth.fingers[e.data.config.fingerId];$("#user-message").text(o)}}else{var i="";i=18==e.status.code?text[logic.current.language].errors.CAPTURE_MATCH:text[logic.current.language].errors.CAPTURE_GENERAL,$("#error-message").text(i),$("#error-container").removeClass("d-none")}},matching:function(e){if($(".feedback").addClass("d-none"),0==e.status.code){$("#loading").removeClass("d-none"),logic.personinit.result=e.data.authenticationResult;var t="N";logic.personinit.data.useVerifyExt&&(t="S");var n={code:"PERSON",type:"VERIFY",subtype:"FINGERPRINT",createdAt:e.createdAt,id:e.id,client:{operationId:config.operationId,companyId:config.companyId,username:"",machineId:e.client.machineId},data:{digitalIdentity:config.digitalIdentity,authenticationFactors:e.data.authenticationFactors,authenticationResult:e.data.authenticationResult,settings:{codParametro:["VERIFYEXT"],indicador:[t]},info:e.data.info}};$.ajax({url:config.baseUrl+"/api/v1/verify/fingerprint",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(n),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){if(logic.personinit.result=e.data.authenticationResult,logic.personinit.data.authentication=logic.personinit.result,logic.personinit.data.fromVerify=!0,e.data.authenticationResult.authenticated)logic.nextStepModule(logic.personinit.data);else{if(logic.personinit.countRetry++,logic.personinit.countRetry>=window.config.retry.fingerprint)return void logic.nextStepModule(logic.personinit.data);var t,n=window.config.retry.fingerprint-logic.personinit.countRetry,o="";o=1==n?window.text[logic.current.language].pages.pfingerprintauth.attempsB:n+" "+window.text[logic.current.language].pages.pfingerprintauth.attempsA,$("#attemps").removeClass("d-none"),$("#attemps").text(o),t=text[logic.current.language].errors.PERSON_NO_AUTH,$("#error-message").text(t),$("#error-container").removeClass("d-none"),$("#loading").addClass("d-none"),$("#btnCapture").removeClass("disabled"),$("#btnCapture").removeClass("d-none")}}).fail(function(e){var t=text[logic.current.language].errors,n="";if(e.responseJSON)if(401===e.status||403===e.status)n=t.PERMISSION_DENIED;else if(404==e.status)if(0==logic.personinit.data.useVerifyExt){var o=logic.getFlow("reg-simple"),i=logic.pages,a=Object.assign({backTo:{process:"verify",pages:i,step:1}},logic.personinit.data);logic.loadStepModule("register",o,1,window.config.language,a)}else n=t.NOT_FOUND_FINGERPRINTS;else n=t.PROCESS;else n=t.COMM;$("#btnCapture").removeClass("disabled"),$("#btnCapture").removeClass("d-none"),$("#error-message").text(n),$("#error-container").removeClass("d-none")}).always(function(){$("#loading").addClass("d-none")})}else{var o=text[logic.current.language].errors,i="";if(401===e.status.code||403===e.status.code)i=o.AUTH;else if(404==e.status.code)if(0==logic.personinit.data.useVerifyExt){var a=logic.getFlow("reg-simple"),r=logic.pages,s=Object.assign({backTo:{process:"verify",pages:r,step:1}},logic.personinit.data);logic.loadStepModule("register",a,1,window.config.language,s)}else i=o.NOT_FOUND_FINGERPRINTS;else i=24==e.status.code?o.FINGERS_NEED_TO_BE_DIFFERENT:o.PROCESS;$("#error-message").text(i),$("#error-container").removeClass("d-none"),$("#btnCapture").removeClass("disabled"),$("#btnCapture").removeClass("d-none")}}},window.logic||(window.logic={}),window.logic.pfingerprintcreate={captureOk:!1,begin:function(e){e.backTo&&(logic.person.backTo=e.backTo),!1===config.useFingerprint?logic.nextStepModule(logic.personinit.data):($("#loading").removeClass("d-none"),$("#btnNextStep").addClass("d-none"),window.logic.websocket.isConnect||window.logic.websocket.isConnecting?window.logic.websocket.isConnecting?window.setTimeout(window.logic.pfingerprintcreate.begin,1e3,e):!window.logic.websocket.isConnecting&&window.logic.websocket.isConnect&&($("#inFinger").val("2"),$("#btnCapture").click(function(){$("#error-container").addClass("d-none"),$(".feedback").removeClass("d-none"),$(this).addClass("disabled"),$(this).addClass("d-none"),$("#current-capture-text").text("1").data("number",1),$("#total-capture-text").text(logic.websocket.captureQty),$("#capture-progress").removeClass("d-none");var e=window.text[logic.current.language].pages.pfingerprintcreate.userMessage.partA+$("#inFinger").children("option:selected").text()+window.text[logic.current.language].pages.pfingerprintcreate.userMessage.partB;$("#user-message").text(e),logic.pfingerprintcreate.captureOk=!1,window.logic.websocket.register($("#inFinger").val(),logic.websocket.captureQty,logic.pfingerprintcreate.updateFingerprint,logic.pfingerprintcreate.createFingerprint)}),$("#inFinger").on("change",function(){var e="assets/finger/"+$(this).val().toString()+".png";$("#image-swap").attr("src",e)}),$("#loading").addClass("d-none")):logic.nextStepModule(logic.personinit.data))},validate:function(){return!0},updateFingerprint:function(e){if(0==e.status.code){if($("#error-container").addClass("d-none"),e.data.authenticationFactors&&e.data.authenticationFactors[0].preview){$("#error-container").addClass("d-none");var t=$("#current-capture-text").data("number");t=parseInt(t)+1,$("#current-capture-text").text(t).data("number",t),$("#imgFingerprint").attr("src","data:image/jpeg;base64,"+e.data.authenticationFactors[0].preview)}}else{var n="";n=18==e.status.code?text[logic.current.language].errors.CAPTURE_MATCH:text[logic.current.language].errors.CAPTURE_GENERAL,$(".feedback").addClass("d-none"),$("#error-message").text(n),$("#error-container").removeClass("d-none")}},captureComplete:function(){return!0},createFingerprint:function(e){if($("#capturing").addClass("d-none"),$("#btnCapture").removeClass("disabled"),$("#btnCapture").removeClass("d-none"),$("#capture-progress").addClass("d-none"),0==e.status.code)$("#loading").removeClass("d-none"),delete e.status,delete e.data.config,e.code="PERSON",e.type="REGISTER",e.subtype="FINGERPRINT",e.data.digitalIdentity={personId:logic.personinit.data.internalId,identityDocuments:[]},e.client?(e.client.operationId=config.operationId,e.client.companyId=config.companyId,e.client.username=""):e.client={operationId:config.operationId,companyId:config.companyId,username:config.username,token:""},$.ajax({url:config.baseUrl+"/api/v1/fingerprint/",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(e),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){logic.pfingerprintcreate.captureOk=!0,logic.nextStepModule(logic.personinit.data)}).fail(function(e){var t=text[logic.current.language].errors,n="";n=e.responseJSON?401===e.status||403===e.status?t.PERMISSION_DENIED:t.PROCESS:t.COMM,$("#error-message").text(n),$("#error-container").removeClass("d-none")}).always(function(){$("#loading").addClass("d-none")});else{var t="";t=21==e.status.code?text[logic.current.language].errors.CAPTURE_MATCH:text[logic.current.language].errors.CAPTURE_GENERAL,$("#error-message").text(t),$("#error-container").removeClass("d-none")}}},window.logic||(window.logic={}),window.logic.pinauth={begin:function(e){$("footer").removeClass("d-none"),$("main").removeClass("nopadding"),$("#btnNextStep").removeClass("d-none").unbind("click").click(function(e){e.preventDefault(),logic.validateCurrentModule()&&logic.pinauth.validatePin()}),$(".pin").keyup(function(e){var t=null;if(8==e.keyCode)(t=$(".pin")[$(".pin").index(this)-1])&&t.focus();else if(/^[0-9]$/.test(e.target.value)){if(""!=$(this).val()){var n=$(this).data("nextfocus");n&&$("#"+n).focus()}}else $(this).val("")}),$("#btnForgot").click(function(e){e.preventDefault(),$("#loading").removeClass("d-none"),logic.nextStepModule(logic.personinit.data)}),$("#loading").addClass("d-none")},validate:function(){return!0},validatePin:function(){$("#loading").removeClass("d-none");var n="";$(".pin").each(function(e,t){n+=$(t).val()});var e={code:"PERSON",type:"VERIFY",subtype:"PIN",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:123456,appFlow:{code:"",step:""},client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[config.digitalIdentity.identityDocuments[0]]},authenticationFactors:[{type:"PIN",subtype:"PIN",value:n}]}};$.ajax({url:config.baseUrl+"/api/v1/verify/pin",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(e),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){if(logic.personinit.result=e.data.authenticationResult,logic.personinit.data.authentication=logic.personinit.result,logic.personinit.data.fromVerify=!0,logic.personinit.data.pinRestorePage=!1,e.data.authenticationResult.authenticated)logic.loadStepModule("verify",logic.pages,6,window.config.language,logic.personinit.data);else{if(logic.personinit.countRetry++,logic.personinit.countRetry>=window.config.retry.pin)return void logic.loadStepModule("verify",logic.pages,6,window.config.language,logic.personinit.data);var t,n=window.config.retry.fingerprint-logic.personinit.countRetry,o="";o=1==n?window.text[logic.current.language].pages.pinauth.attempsB:n+" "+window.text[logic.current.language].pages.pinauth.attempsA,$("#attemps").removeClass("d-none"),$("#attemps").text(o),$(".pin").val(""),$("#input-pin-1").focus(),t=text[logic.current.language].errors.PERSON_NO_AUTH,$("#error-message").text(t),$("#error-container").removeClass("d-none"),$("#loading").addClass("d-none")}}).fail(logic.handleError).always(function(){$("#loading").addClass("d-none")})}},window.logic||(window.logic={}),window.logic.pincreate={begin:function(e){$("footer").removeClass("d-none"),$.isEmptyObject(logic.personinit.data)&&null!=e&&!$.isEmptyObject(e)&&(logic.personinit.data.internalId=e.internalId,logic.personinit.data.gender=e.gender,logic.personinit.data.surnames=e.surnames,logic.personinit.data.givennames=e.givennames,logic.personinit.data.docType=e.docType,logic.personinit.data.docCountry=e.docCountry,logic.personinit.data.personId=e.personId,logic.personinit.data.documentId=e.documentId,logic.personinit.data.cellphone=e.cellphone,logic.personinit.data.email=e.email,logic.personinit.data.email2=e.email2,logic.personinit.data.pinRestore=e.pinRestore,logic.personinit.data.pinRestoreMethod=e.pinRestoreMethod,logic.personinit.data.useVerifyExt=e.useVerifyExt,logic.personinit.data.personIdFormatted=e.personIdFormatted,logic.personinit.data.pinRestorePage=e.pinRestorePage),logic.personinit.data.pinRestorePage||config.usePin?($(".pin").keyup(function(e){var t=null;if(8==e.keyCode)(t=$(".pin")[$(".pin").index(this)-1])&&t.focus();else if(/^[0-9]$/.test(e.target.value)){if(""!=$(this).val()){var n=$(this).data("nextfocus");n&&$("#"+n).focus()}}else $(this).val("")}),$("#btnNextStep").unbind("click").click(function(e){e.preventDefault(),logic.validateCurrentModule()&&(!1===config.pinRestore?logic.pinkbacreate.createPin():"KBA"===config.pinRestoreMethod?logic.nextStepModule(logic.personinit.data):logic.pinkbacreate.createPin())}),e.backTo&&(logic.personinit.backTo=e.backTo)):"CREATE"==window.config.action?logic.loadStepModule(logic.current.process,logic.pages,6,window.config.language,logic.personinit.data):logic.loadStepModule(logic.current.process,logic.pages,5,window.config.language,logic.personinit.data),$("#loading").addClass("d-none")},validate:function(){$("#pin-invalid-error").addClass("d-none"),$(".pin").removeClass("error");var e="",t="";$(".pin-1 .pin").each(function(){e+=$(this).val()}),$(".pin-2 .pin").each(function(){t+=$(this).val()});var n=e===t&&6===e.length;return n?logic.personinit.data.pin=e:($("#pin-invalid-error").removeClass("d-none"),$(".pin").addClass("error"),$(".pin").val(""),$("#input-pin-1").focus()),n}},window.logic||(window.logic={}),window.logic.pinkbacreate={data:{},backTo:null,begin:function(e){$("#btnNextStep").unbind("click").click(function(e){e.preventDefault(),logic.validateCurrentModule()&&logic.pinkbacreate.createPin()})},validate:function(){$("#error-container").addClass("d-none");var n=!0;return $(".kba").each(function(){var e=$(this).val(),t=$(this).data("required");(t=0!=t)&&""==e&&(n=!1,$(this).addClass("error"))}),n||($("#error-message").text(text[logic.current.language].errors.REQUIRED_FIELD),$("#error-container").removeClass("d-none")),n},createPin:function(){$("#loading").removeClass("d-none");var e={code:"PERSON",type:"REGISTER",subtype:"PIN",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{personId:logic.personinit.data.internalId,emailAddresses:[],addresses:[],contactPhones:[],identityDocuments:[]},authenticationFactors:[{type:"PIN",subtype:"PIN",value:logic.personinit.data.pin,checksum:""},{type:"KBA",subtype:"KBA",questionType:"STATIC",questions:{},checksum:""}]}};config.pinRestore&&"KBA"==config.pinRestoreMethod?e.data.authenticationFactors[1].questions[$("#inputQuestion").val()]={answers:{RESP:$("#inputAnswer").val()}}:e.data.authenticationFactors.splice(1,1),$.ajax({url:config.baseUrl+"/api/v1/pin/create",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(e),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){!1===config.pinRestore?logic.loadStepModule("register",logic.pages,6,window.config.language,logic.personinit.data):"KBA"==config.pinRestoreMethod?logic.nextStepModule(logic.personinit.data):logic.loadStepModule("pinrestore",logic.pages,3,window.config.language,logic.personinit.data)}).fail(logic.handleError).always(function(){$("#loading").addClass("d-none")})}},window.logic||(window.logic={}),window.logic.pinrestore={personId:"",personIdFormatted:"",documentId:"",begin:function(e){switch(config.pinRestoreMethod){case"KBA":logic.pinrestore.getKBA(e);break;case"ACEP":if($("#inputPersonId").blur(function(e){Validator.PersonId[logic.personinit.data.docCountry][logic.personinit.data.docType].validate(e.target.value)&&($(this).removeClass("error"),$(".label-error").html("&nbsp"),$(this).val(Formatter.PersonId[logic.personinit.data.docCountry][logic.personinit.data.docType].format(e.target.value)))}),logic.personinit.data){var t=logic.personinit.data;t.personId?(logic.pinrestore.personId=Formatter.PersonId[logic.personinit.data.docCountry][logic.personinit.data.docType].plain(t.personId),logic.pinrestore.personIdFormatted=Formatter.PersonId[logic.personinit.data.docCountry][logic.personinit.data.docType].format(t.personId),$("#inputPersonId").val(logic.pinrestore.personIdFormatted)):$("#inputPersonId").removeAttr("disabled")}else $("#inputPersonId").removeAttr("disabled");$("#helpSerial").click(function(e){e.preventDefault(),$("#modalSerial").modal()}),$("#loading").addClass("d-none")}$("#btnNextStep").removeClass("d-none").unbind("click").click(function(e){e.preventDefault(),$("#error-container").addClass("d-none"),logic.validateCurrentModule()&&("KBA"===config.pinRestoreMethod?logic.pinrestore.validateQuestion():"ACEP"===config.pinRestoreMethod?logic.pinrestore.validateDocument():($("#error-message").text("Método de recuperación no válido."),$("#error-container").removeClass("d-none")))})},getKBA:function(e){var t={code:"PERSON",type:"GET",subtype:"KBA",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:1549887978384,client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[config.digitalIdentity.identityDocuments[0]]},authenticationFactors:[{type:"KBA",subtype:"KBA",questionType:"STATIC"}]}};$.ajax({url:config.baseUrl+"/api/v1/kba/get",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(t),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){var t;e.data.authenticationFactors&&0<e.data.authenticationFactors.length?(logic.pinrestore.lastQuestion=atob(e.data.authenticationFactors[0].value),$("#lbl-question").text(atob(e.data.authenticationFactors[0].value))):(t=text[logic.current.language].errors.KBA_NO_DATA,$("#error-message").text(t),$("#error-container").removeClass("d-none"))}).fail(function(e){var t=text[logic.current.language].errors,n="";n=e.responseJSON?401===e.status||403===e.status?t.AUTH:404==e.status?t.PERSON_NOT_FOUND:t.PROCESS:t.COMM,$("#error-message").text(n),$("#error-container").removeClass("d-none")}).always(function(){$("#loading").addClass("d-none")})},validateQuestion:function(){var e={code:"PERSON",type:"VERIFY",subtype:"KBA",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:1549887978384,client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[config.digitalIdentity.identityDocuments[0]]},authenticationFactors:[{type:"KBA",subtype:"KBA",questionType:"STATIC",questions:{}}]}};e.data.authenticationFactors[0].questions[logic.pinrestore.lastQuestion]={answers:{RESP:$("#input-answer").val()}},$.ajax({url:config.baseUrl+"/api/v1/verify/kba",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(e),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){if(e.data.authenticationResult.authenticated){logic.personinit.data=logic.personinit.data,logic.personinit.data.pinRestorePage=!0;var t=logic.getFlow("pinrestore"),n=logic.pages,o=Object.assign({backTo:{process:"verify",pages:n,step:3}},logic.personinit.data);logic.loadStepModule("register",t,1,window.config.language,o)}else $("#error-message").text(text[logic.current.language].errors.QUESTION_MATCH),$("#error-container").removeClass("d-none")}).fail(function(e){var t=text[logic.current.language].errors,n="";n=e.responseJSON?401===e.status||403===e.status?t.AUTH:404==e.status?t.PERSON_NOT_FOUND:t.PROCESS:t.COMM,$("#error-message").text(n),$("#error-container").removeClass("d-none")}).always(function(){$("#loading").addClass("d-none")})},validateDocument:function(){$("#error-container").addClass("d-none"),$("#loading").removeClass("d-none");var e={code:"DOCUMENT",type:"VALIDATE",subtype:"EXPIRY",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[{type:logic.personinit.data.docType,countryCode:logic.personinit.data.docCountry,number:logic.pinrestore.documentId,personalNumber:logic.pinrestore.personId,nationality:logic.personinit.data.docCountry}]}}};$.ajax({url:config.baseUrl+"/api/v1/document/validate",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(e),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){if(200==e.status.status.code){logic.personinit.data.documentVerified=!0,logic.personinit.data.pinRestorePage=!0;var t=logic.getFlow("pinrestore"),n=logic.pages,o=Object.assign({backTo:{process:"verify",pages:n,step:3}},logic.personinit.data);logic.loadStepModule("pinrestore",t,1,window.config.language,o)}else{logic.personinit.data.documentVerified=!1;var i=text[logic.current.language].errors.PROCESS;406==e.status.status.code&&(i=e.status.status.message),$("#error-message").text(i),$("#error-container").removeClass("d-none")}}).fail(function(e){logic.handleError(e)}).always(function(){$("#loading").addClass("d-none")})},validate:function(){var n=!0;return"ACEP"===config.pinRestoreMethod?($(".label-error").html("&nbsp"),$(".person-data-input").removeClass("error"),$(".person-data-input").each(function(){var e=$(this).val(),t=$(this).data("required");(t=0!=t)&&""==e&&(n=!1,$(this).next("p.label-error").text(text[logic.current.language].errors.REQUIRED),$(this).addClass("error")),logic.pinrestore[$(this).data("name")]=e}),""!=logic.pinrestore.personId&&(Validator.PersonId[logic.personinit.data.docCountry][logic.personinit.data.docType].validate(logic.pinrestore.personId)?(logic.pinrestore.personIdFormatted=Formatter.PersonId[logic.personinit.data.docCountry][logic.personinit.data.docType].format(logic.pinrestore.personId),logic.pinrestore.personId=Formatter.PersonId[logic.personinit.data.docCountry][logic.personinit.data.docType].plain(logic.pinrestore.personId),logic.pinrestore.personId!=logic.personinit.data.personId&&(n=!1,$("#inputPersonId").addClass("error").next("p.label-error").text(text[logic.current.language].errors.PERSONALNUMBER_ISDIFERENT))):(n=!1,$("#inputPersonId").addClass("error").next("p.label-error").text(text[logic.current.language].errors.INVALID_FORMAT)))):n=!0,n}},window.logic||(window.logic={}),window.logic.presult={begin:function(o){$("#btnFinish").click(function(){if(logic.personinit.backTo){var e=Object.assign({from:"register"},logic.personinit.data);return logic.loadStepModule(logic.personinit.backTo.process,logic.personinit.backTo.pages,logic.personinit.backTo.step,window.config.language,e),void(logic.personinit.backTo=null)}var t=[{type:"PERSONAL",address:o.email,primary:!0}];o.email2&&""!=o.email2&&t.push({type:"PERSONAL",address:o.email2,primary:!1});var n={};n="CREATE"==config.action?{action:config.action,data:{digitalIdentity:{personId:o.internalId,personalData:{givenNames:o.givennames,surnames:o.surnames,dob:o.birthdate,gender:o.gender},emailAddresses:t,contactPhones:{type:"MOBILE",number:o.cellphone,primary:!0},identityDocuments:[{type:o.docType,countryCode:o.docCountry,number:o.documentId,personalNumber:o.personId,issueDate:"20190101",expiryDate:"21001231",issuingAuthority:"",nationality:o.docCountry,statusDocument:o.statusDocument}]}},operator:{sessionId:window.config.operator.sessionId},numError:0,msError:""}:"VERIFY"==config.action?{action:config.action,data:o.authentication,operator:{sessionId:window.config.operator.sessionId},numError:0,msError:""}:{action:config.action,data:null,operator:{sessionId:window.config.operator.sessionId},numError:0,msError:""},window.opener.callback(n)}),$("main").addClass("nopadding"),$("footer").addClass("d-none")}},window.logic||(window.logic={}),window.logic.pverifyinit={data:{},loadedParams:!1,countRetry:0,result:{},begin:function(e){if(logic.getProfiles(),null!=config.useVerifyExt&&1==config.useVerifyExt?logic.pverifyinit.data.useVerifyExt=!0:logic.pverifyinit.data.useVerifyExt=!1,logic.validateProfile("VERIFY_PERSON")||window.config.operator.identityDocument.personalNumber==window.config.digitalIdentity.identityDocuments[0].personalNumber){if($("#loading").removeClass("d-none"),e.from)return logic.pverifyinit.data=e.personData,void logic.nextStepModule(logic.pverifyinit.data);logic.pverifyinit.loadedParams||logic.pverifyinit.loadDataFromParams(),logic.pverifyinit.getPerson(),$("#btnNextStep").addClass("d-none")}else{var t=text[logic.current.language].errors.INVALID_PROFILE;if(null==config.handleErrs||0==config.handleErrs){var n={action:config.action,data:null,operator:{sessionId:window.config.operator.sessionId},numError:1e3,msError:t};window.opener.callback(n)}else{var o={};o.personIdFormatted=Formatter.PersonId[config.digitalIdentity.identityDocuments[0].countryCode][config.digitalIdentity.identityDocuments[0].type].format(config.digitalIdentity.identityDocuments[0].personalNumber),o.numError=1e3,o.msError=t,o.action=config.action,logic.loadStep("weberror",1,window.config.language,o)}}},validate:function(){return!0},loadDataFromParams:function(){if(logic.pverifyinit.loadedParams=!0,config.digitalIdentity.personalData){var e=config.digitalIdentity.personalData;e.dob&&(logic.pverifyinit.data.birthdate=e.dob),e.gender&&(logic.pverifyinit.data.gender=e.gender),e.surnames&&(logic.pverifyinit.data.surnames=e.surnames),e.givenNames&&(logic.pverifyinit.data.givennames=e.givenNames)}if(config.digitalIdentity.emailAddresses){var t=config.digitalIdentity.emailAddresses;0<t.length&&(t[0].address&&(logic.pverifyinit.data.email=t[0].address),1<t.length&&t[1].address&&(logic.pverifyinit.data.email2=t[1].address))}if(config.digitalIdentity.contactPhones){var n=config.digitalIdentity.contactPhones;0<n.length&&n[0].number&&(logic.pverifyinit.data.cellphone=n[0].number)}if(logic.pverifyinit.data.docType="ID",logic.pverifyinit.data.docCountry="CL",config.digitalIdentity.identityDocuments){var o=config.digitalIdentity.identityDocuments;0<o.length&&(o[0].personalNumber&&(logic.pverifyinit.data.personId=o[0].personalNumber),o[0].number&&(logic.pverifyinit.data.documentId=o[0].number),o[0].type&&(logic.pverifyinit.data.docType=o[0].type),o[0].countryCode&&(logic.pverifyinit.data.docCountry=o[0].countryCode))}},getPerson:function(){var e={code:"PERSON",type:"GET",subtype:"PERSON",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:1549887978384,client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[config.digitalIdentity.identityDocuments[0]]}}};$.ajax({method:"POST",contentType:"application/json",dataType:"json",crossDomain:!0,url:config.baseUrl+"/api/v1/person/get",headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId},data:JSON.stringify(e)}).done(function(e){logic.pverifyinit.data.internalId=e.data.digitalIdentity.personId,logic.pverifyinit.data.gender=e.data.digitalIdentity.personalData.gender,logic.pverifyinit.data.surnames=e.data.digitalIdentity.personalData.surnames,logic.pverifyinit.data.givennames=e.data.digitalIdentity.personalData.givenNames,logic.pverifyinit.data.docType=e.data.digitalIdentity.identityDocuments[0].type,logic.pverifyinit.data.docCountry=e.data.digitalIdentity.identityDocuments[0].countryCode,logic.pverifyinit.data.personId=e.data.digitalIdentity.identityDocuments[0].personalNumber,logic.pverifyinit.data.documentId=e.data.digitalIdentity.identityDocuments[0].number,logic.pverifyinit.data.personIdFormatted=Formatter.PersonId[logic.pverifyinit.data.docCountry][logic.pverifyinit.data.docType].format(logic.pverifyinit.data.personId);var t=e.data.digitalIdentity.contactPhones,n=e.data.digitalIdentity.emailAddresses;t&&0<t.length&&$.each(t,function(e,t){t.primary&&(logic.pverifyinit.data.cellphone=t.number)}),n&&0<n.length&&$.each(n,function(e,t){t.primary?logic.pverifyinit.data.email=t.address:logic.pverifyinit.data.email2=t.address}),logic.nextStepModule(logic.pverifyinit.data)}).fail(function(e){var t=text[logic.current.language].errors,n="",o=0;if(null!=config.useVerifyExt&&1==config.useVerifyExt)return window.config.digitalIdentity.personId=1,logic.pverifyinit.data.internalId=logic.pverifyinit.data.personId,logic.pverifyinit.data.personIdFormatted=Formatter.PersonId[logic.pverifyinit.data.docCountry][logic.pverifyinit.data.docType].format(logic.pverifyinit.data.personId),void logic.nextStepModule(logic.pverifyinit.data);if(e.responseJSON)if(o=e.status,401===e.status||403===e.status)n=t.AUTH;else{if(404==e.status){var i=logic.getFlow("reg-simple");return void logic.loadStepModule("register",i,1,window.config.language,{backTo:{process:"verify",pages:["pverifyinit","pfingerprintauth"],step:1}})}n=t.PROCESS}else n=t.COMM,o=1e3;if(null==config.handleErrs||0==config.handleErrs){var a={action:config.action,data:logic.pverifyinit.result,operator:{sessionId:window.config.operator.sessionId},numError:o,msError:n};window.opener.callback(a)}else{$("#loading").addClass("d-none");var r={};r.numError=o,r.msError=n,r.action=config.action,r.personIdFormatted=Formatter.PersonId[config.digitalIdentity.identityDocuments[0].countryCode][config.digitalIdentity.identityDocuments[0].type].format(config.digitalIdentity.identityDocuments[0].personalNumber),r.result=logic.pverifyinit.result,logic.loadStep("weberror",1,window.config.language,r)}}).always(function(){})}},window.logic||(window.logic={}),window.logic.register={personData:{},loadedParams:!1,steps:5,backTo:null,1:{begin:function(e){if(logic.getProfiles(),e.backTo&&(logic.register.backTo=e.backTo),logic.validateProfile("CREATE_PERSON")||logic.validateProfile("UPDATE_AUTH")||logic.validateProfile("UPDATE_PERSON")||logic.validateProfile("CREATE_PIN")||"PENDI"==logic.personStatus)logic.register[1].getPerson();else{var t=text[logic.current.language].errors.INVALID_PROFILE;if(null==config.handleErrs||0==config.handleErrs){var n={action:config.action,data:null,operator:{sessionId:window.config.operator.sessionId},numError:1e3,msError:t};window.opener.callback(n)}else{var o={};o.personIdFormatted=Formatter.PersonId[config.digitalIdentity.identityDocuments[0].countryCode][config.digitalIdentity.identityDocuments[0].type].format(config.digitalIdentity.identityDocuments[0].personalNumber),o.numError=1e3,o.msError=t,o.action=config.action,logic.loadStep("weberror",1,window.config.language,o)}}},validate:function(){$(".label-error").html("&nbsp");var n=!0;$(".person-data-input").removeClass("error"),$(".person-data-input").each(function(){var e=$(this).val(),t=$(this).data("required");(t=0!=t)&&""==e&&(n=!1,$(this).next("p.label-error").text(text[logic.current.language].errors.REQUIRED),$(this).addClass("error")),logic.register.personData[$(this).data("name")]=e}),logic.register.personData.docType=$("#inputDocType").val(),logic.register.personData.docCountry=$("#inputDocCountry").val(),logic.register.personData.docType||(n=!1),logic.register.personData.docCountry||(n=!1);var e=/^\+?([0-9]{2})\)?[-. ]?([0-9]{1})[-. ]?([0-9]{4})[-. ]?([0-9]{4})$/;$(".phone-input").each(function(){e.test($(this).val())||(n=!1,$(this).next("p.label-error").text(text[logic.current.language].errors.INVALID_FORMAT),$(this).addClass("error"))});var t=/^(([^<>()\[\]\\.,;:\s@']+(\.[^<>()\[\]\\.,;:\s@']+)*)|('.+'))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return $(".email-input").each(function(){var e=$(this).data("required");(e=0!=e)||""!=$(this).val()&&(e=!0),e&&!t.test($(this).val())&&(n=!1,$(this).next("p.label-error").text(text[logic.current.language].errors.INVALID_FORMAT),$(this).addClass("error"))}),Validator.PersonId[logic.register.personData.docCountry][logic.register.personData.docType].validate(logic.register.personData.personId)?(logic.register.personData.personIdFormatted=Formatter.PersonId[logic.register.personData.docCountry][logic.register.personData.docType].format(logic.register.personData.personId),logic.register.personData.personId=Formatter.PersonId[logic.register.personData.docCountry][logic.register.personData.docType].plain(logic.register.personData.personId)):(n=!1,$("#inputPersonId").addClass("error").next("p.label-error").text(text[logic.current.language].errors.INVALID_FORMAT)),moment($("#inputBirthdate").val(),"YYYY-MM-DD").isSameOrAfter(moment())&&(n=!1,$("#inputBirthdate").addClass("error")),n},loadDataFromConfig:function(){if(config.digitalIdentity){if(logic.register.personData.internalId=0,config.digitalIdentity.personalData&&(logic.register.personData=config.digitalIdentity.personalData),logic.register.personData.email="",logic.register.personData.email2="",config.digitalIdentity.emailAddresses){var e=config.digitalIdentity.emailAddresses;0<e.length&&(e[0].address&&(logic.register.personData.email=e[0].address),1<e.length&&e[1].address&&(logic.register.personData.email2=e[1].address))}if(logic.register.personData.cellphone="",config.digitalIdentity.contactPhones){var t=config.digitalIdentity.contactPhones;0<t.length&&t[0].number&&(logic.register.personData.cellphone=t[0].number)}if(config.digitalIdentity.identityDocuments){var n=config.digitalIdentity.identityDocuments;0<n.length&&(n[0].number&&(logic.register.personData.documentId=n[0].number),n[0].type&&(logic.register.personData.docType=n[0].type),n[0].countryCode&&(logic.register.personData.docCountry=n[0].countryCode),n[0].personalNumber&&(logic.register.personData.personId=n[0].personalNumber))}}},loadDataFromParams:function(){if(logic.register.loadedParams=!0,logic.register){if($("#inputDocType").val("ID"),$("#inputDocCountry").val("CL"),logic.register.personData){var e=logic.register.personData;if(e.dob){var t=moment(e.dob,"YYYYMMDD");t.isValid()&&$("#inputBirthdate").val(t.format("YYYY-MM-DD"))}e.gender&&$("#inputGender").val(e.gender),e.surnames&&$("#inputSurnames").val(e.surnames),e.givennames&&$("#inputGivennames").val(e.givennames),e.email&&$("#inputEmail").val(e.email),e.email2&&$("#inputEmail2").val(e.email2),e.cellphone&&$("#inputCellphone").val(e.cellphone),e.documentId&&$("#inputDocumentId").val(e.documentId),e.docType&&$("#inputDocType").val(e.docType),e.docCountry&&$("#inputDocCountry").val(e.docCountry),e.personId&&(e.personId=Formatter.PersonId[logic.register.personData.docCountry][logic.register.personData.docType].plain(e.personId),logic.register.personData.personIdFormatted=Formatter.PersonId[logic.register.personData.docCountry][logic.register.personData.docType].format(e.personId),$("#inputPersonId").val(logic.register.personData.personIdFormatted))}$("#inputPersonId").change()}},initPerson:function(){$("#inputBirthdate").attr("max",moment().format("YYYY-MM-DD")).val(moment().subtract(18,"years").format("YYYY-MM-DD")),logic.register[1].loadDataFromParams(),$("footer").removeClass("d-none"),$("#btnNextStep").removeClass("d-none").unbind("click").click(function(e){e.preventDefault(),logic.validateCurrent()&&(null==logic.register.personData.internalId?logic.register[1].createPerson():0!=logic.register.personData.internalId?logic.register[1].updatePerson():logic.register[1].createPerson())}),$(".person-data-input").change(function(){var e=$(this).val(),t=$(this).data("required");(t=0!=t)&&""==e?($(this).next("p.label-error").text(text[logic.current.language].errors.REQUIRED),$(this).addClass("error")):($(this).removeClass("error"),$(this).next("p.label-error").html("&nbsp"))}),$("#inputPersonId").change(function(){$(this).removeClass("error");var e=$(this).val();Validator.PersonId[logic.register.personData.docCountry][logic.register.personData.docType].validate(e)?$(this).next("p.label-error").html("&nbsp"):($(this).addClass("error"),$(this).next("p.label-error").text(text[logic.current.language].errors.INVALID_FORMAT)),e=Formatter.PersonId[logic.register.personData.docCountry][logic.register.personData.docType].format(e),$(this).val(e)}),$("#helpSerial").click(function(e){e.preventDefault(),$("#modalSerial").modal()});var e=/^\+?([0-9]{2})\)?[-. ]?([0-9]{1})[-. ]?([0-9]{4})[-. ]?([0-9]{4})$/;$(".phone-input").change(function(){$(this).removeClass("error"),e.test($(this).val())?$(this).next("p.label-error").html("&nbsp"):($(this).next("p.label-error").text(text[logic.current.language].errors.INVALID_FORMAT),$(this).addClass("error"))});var t=/^(([^<>()\[\]\\.,;:\s@']+(\.[^<>()\[\]\\.,;:\s@']+)*)|('.+'))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;$(".email-input").change(function(){$(this).removeClass("error");var e=$(this).data("required");(e=0!=e)||""!=$(this).val()&&(e=!0),e&&!t.test($(this).val())?($(this).next("p.label-error").text(text[logic.current.language].errors.INVALID_FORMAT),$(this).addClass("error")):$(this).next("p.label-error").html("&nbsp")}),$("#loading").addClass("d-none")},getPerson:function(){var e={code:"PERSON",type:"GET",subtype:"PERSON",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:1549887978384,client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[config.digitalIdentity.identityDocuments[0]]}}};$.ajax({method:"POST",contentType:"application/json",dataType:"json",crossDomain:!0,url:config.baseUrl+"/api/v1/person/get",headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId},data:JSON.stringify(e)}).done(function(e){text[logic.current.language].errors;var t="",n=!0,o=0;if(logic.validateProfile("UPDATE_AUTH")||logic.validateProfile("UPDATE_PERSON")||logic.validateProfile("CREATE_PIN")||"PENDI"==logic.personStatus){logic.validateProfile("UPDATE_AUTH")||"PENDI"===logic.personStatus||(config.useFingerprint=!1,config.usePin=!1),logic.register.personData.internalId=e.data.digitalIdentity.personId,logic.register.personData.gender=e.data.digitalIdentity.personalData.gender,logic.register.personData.surnames=e.data.digitalIdentity.personalData.surnames,logic.register.personData.givennames=e.data.digitalIdentity.personalData.givenNames,logic.register.personData.dob=e.data.digitalIdentity.personalData.dob,logic.register.personData.docType=e.data.digitalIdentity.identityDocuments[0].type,logic.register.personData.docCountry=e.data.digitalIdentity.identityDocuments[0].countryCode,logic.register.personData.personId=e.data.digitalIdentity.identityDocuments[0].personalNumber,logic.register.personData.documentId=e.data.digitalIdentity.identityDocuments[0].number,logic.register.personData.statusDocument=e.data.digitalIdentity.identityDocuments[0].statusDocument;var i=e.data.digitalIdentity.contactPhones,a=e.data.digitalIdentity.emailAddresses;i&&0<i.length&&$.each(i,function(e,t){t.primary&&(logic.register.personData.cellphone=t.number)}),a&&0<a.length&&$.each(a,function(e,t){t.primary?logic.register.personData.email=t.address:logic.register.personData.email2=t.address}),logic.validateProfile("UPDATE_PERSON")?logic.register[1].initPerson():logic.validateProfile("UPDATE_AUTH")||"PENDI"==logic.personStatus?logic.loadStep("register",2,window.config.language,logic.register.personData):window.config.operator.identityDocument.personalNumber==window.config.digitalIdentity.identityDocuments[0].personalNumber?logic.validateProfile("CREATE_PIN")?(config.useFingerprint=!1,config.usePin=!0,logic.loadStep("register",2,window.config.language,logic.register.personData)):(n=!1,o=1e3):(n=!1,o=1001)}else n=!1,o=1002;if(!n)if(t=text[logic.current.language].errors.INVALID_PROFILE,null==config.handleErrs||0==config.handleErrs){var r={action:config.action,data:null,operator:{sessionId:window.config.operator.sessionId},numError:o,msError:t};window.opener.callback(r)}else{var s={};s.numError=o,s.msError=t,s.action=config.action,s.personIdFormatted=logic.register.personData.personIdFormatted,s.givennames=logic.register.personData.givennames,s.surnames=logic.register.personData.surnames,logic.loadStep("weberror",1,window.config.language,s)}}).fail(function(e){var t=text[logic.current.language].errors,n="",o=0;if(e.responseJSON)if(o=e.status,401===e.status||403===e.status)n=t.AUTH;else if(404==e.status){if(logic.validateProfile("CREATE_PERSON"))return logic.register[1].loadDataFromConfig(),void logic.register[1].initPerson();n=t.INVALID_PROFILE}else n=t.PROCESS;else n=t.COMM,o=1e3;if(null==config.handleErrs||0==config.handleErrs){var i={action:config.action,data:logic.verify.result,operator:{sessionId:window.config.operator.sessionId},numError:o,msError:n};window.opener.callback(i)}else{$("#loading").addClass("d-none");var a={};a.numError=o,a.msError=n,a.action=config.action,a.personIdFormatted=Formatter.PersonId[config.digitalIdentity.identityDocuments[0].countryCode][config.digitalIdentity.identityDocuments[0].type].format(config.digitalIdentity.identityDocuments[0].personalNumber),a.result=logic.register.result,logic.loadStep("weberror",1,window.config.language,a)}}).always(function(){})},createPerson:function(){$("#error-container").addClass("d-none"),$("#loading").removeClass("d-none");var e=[{type:"PERSONAL",address:logic.register.personData.email,primary:!0}];logic.register.personData.email2&&""!=logic.register.personData.email2&&e.push({type:"PERSONAL",address:logic.register.personData.email2,primary:!1});var t={code:"PERSON",type:"REGISTER",subtype:"PERSON",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{personalData:{givenNames:logic.register.personData.givennames,surnames:logic.register.personData.surnames,dob:moment(logic.register.personData.birthdate,"YYYY-MM-DD").format("YYYYMMDD"),gender:logic.register.personData.gender},emailAddresses:e,contactPhones:[{type:"MOBILE",countryCode:1,areaCode:1,number:logic.register.personData.cellphone,primary:!0}],identityDocuments:[{type:logic.register.personData.docType,countryCode:logic.register.personData.docCountry,number:logic.register.personData.documentId,personalNumber:logic.register.personData.personId,issueDate:"20190101",expiryDate:"21001231",issuingAuthority:"",nationality:logic.register.personData.docCountry}],authenticationFactors:[]}}};$.ajax({url:config.baseUrl+"/api/v1/person/create",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(t),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){if(200==e.status.status.code||202==e.status.status.code||204==e.status.status.code)202==e.status.status.code||204==e.status.status.code?logic.register.personData.documentPendi=!0:logic.register.personData.documentPendi=!1,e.data.digitalIdentity.personId&&(logic.register.personData.internalId=e.data.digitalIdentity.personId,logic.nextStep(logic.register.personData));else{var t=text[logic.current.language].errors,n=t.PROCESS;302==e.status.status.code&&(n=t.PERSON_FOUND),406==e.status.status.code&&(n=e.status.status.message),$("#error-message").text(n),$("#error-container").removeClass("d-none"),$("#loading").addClass("d-none")}}).fail(function(e){logic.handleError(e)}).always(function(){$("#loading").addClass("d-none")})},updatePerson:function(){$("#error-container").addClass("d-none"),$("#loading").removeClass("d-none");var e=[{type:"PERSONAL",address:logic.register.personData.email,primary:!0}];logic.register.personData.email2&&""!=logic.register.personData.email2&&e.push({type:"PERSONAL",address:logic.register.personData.email2,primary:!1});var t={code:"PERSON",type:"UPDATE",subtype:"PERSON",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{personalData:{givenNames:logic.register.personData.givennames,surnames:logic.register.personData.surnames,dob:moment(logic.register.personData.birthdate,"YYYY-MM-DD").format("YYYYMMDD"),gender:logic.register.personData.gender},emailAddresses:e,contactPhones:[{type:"MOBILE",countryCode:1,areaCode:1,number:logic.register.personData.cellphone,primary:!0}],identityDocuments:[{type:logic.register.personData.docType,countryCode:logic.register.personData.docCountry,number:logic.register.personData.documentId,personalNumber:logic.register.personData.personId,issueDate:"20190101",expiryDate:"21001231",issuingAuthority:"",nationality:logic.register.personData.docCountry}],authenticationFactors:[]}}};$.ajax({url:config.baseUrl+"/api/v1/person/update",datatype:"json",type:"PUT",crossDomain:!0,contentType:"application/json",data:JSON.stringify(t),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){if(200==e.status.status.code||202==e.status.status.code||204==e.status.status.code)202==e.status.status.code||204==e.status.status.code?logic.register.personData.documentPendi=!0:logic.register.personData.documentPendi=!1,e.data.digitalIdentity.personId&&(logic.register.personData.internalId=e.data.digitalIdentity.personId,logic.nextStep(logic.register.personData));else{var t=text[logic.current.language].errors.PROCESS;406==e.status.status.code&&(t=e.status.status.message),$("#error-message").text(t),$("#error-container").removeClass("d-none"),$("#loading").addClass("d-none")}}).fail(function(e){logic.handleError(e)}).always(function(){$("#loading").addClass("d-none")})},validateDocument:function(){$("#error-container").addClass("d-none"),$("#loading").removeClass("d-none");var e={code:"DOCUMENT",type:"VALIDATE",subtype:"EXPIRY",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[{type:logic.register.personData.docType,countryCode:logic.register.personData.docCountry,number:logic.register.personData.documentId,personalNumber:logic.register.personData.personId,nationality:logic.register.personData.docCountry}]}}};$.ajax({url:config.baseUrl+"/api/v1/document/validate",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(e),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){if(200==e.status.status.code||202==e.status.status.code||204==e.status.status.code)null==logic.register.personData.internalId?logic.register[1].createPerson():0!=logic.register.personData.internalId?logic.register[1].updatePerson():logic.register[1].createPerson();else{var t=text[logic.current.language].errors.PROCESS;406==e.status.status.code&&(t=e.status.status.message),$("#error-message").text(t),$("#error-container").removeClass("d-none"),$("#loading").addClass("d-none")}}).fail(function(e){logic.handleError(e)}).always(function(){$("#loading").addClass("d-none")})}},2:{begin:function(e){$.isEmptyObject(logic.register.personData)&&null!=e&&!$.isEmptyObject(e)&&(logic.register.personData.internalId=e.internalId,logic.register.personData.gender=e.gender,logic.register.personData.surnames=e.surnames,logic.register.personData.givennames=e.givennames,logic.register.personData.docType=e.type,logic.register.personData.docCountry=e.countryCode,logic.register.personData.personId=e.personId,logic.register.personData.documentId=e.documentId,logic.register.personData.cellphone=e.cellphone,logic.register.personData.email=e.email,logic.register.personData.email2=e.email2,logic.register.personData.personIdFormatted=e.personIdFormatted),!1===config.usePin?logic.loadStep("register",4,window.config.language,logic.register.personData):($(".pin").keyup(function(e){var t=null;if(8==e.keyCode)(t=$(".pin")[$(".pin").index(this)-1])&&t.focus();else if(/^[0-9]$/.test(e.target.value)){if(""!=$(this).val()){var n=$(this).data("nextfocus");n&&$("#"+n).focus()}}else $(this).val("")}),$("#btnNextStep").unbind("click").click(function(e){e.preventDefault(),logic.validateCurrent()&&(!1===config.pinRestore?logic.register[3].createPin():logic.nextStep(logic.register.personData))}),e.backTo&&(logic.register.backTo=e.backTo)),$("#loading").addClass("d-none")},validate:function(){$("#pin-invalid-error").addClass("d-none"),$(".pin").removeClass("error");var e="",t="";$(".pin-1 .pin").each(function(){e+=$(this).val()}),$(".pin-2 .pin").each(function(){t+=$(this).val()});var n=e===t&&6===e.length;return n?logic.register.personData.pin=e:($("#pin-invalid-error").removeClass("d-none"),$(".pin").addClass("error"),$(".pin").val(""),$("#input-pin-1").focus()),n}},3:{begin:function(e){$("#btnNextStep").unbind("click").click(function(e){e.preventDefault(),logic.validateCurrent()&&logic.register[3].createPin()})},validate:function(){$("#error-container").addClass("d-none");var n=!0;return $(".kba").each(function(){var e=$(this).val(),t=$(this).data("required");(t=0!=t)&&""==e&&(n=!1,$(this).addClass("error"))}),n||($("#error-message").text(text[logic.current.language].errors.REQUIRED_FIELD),$("#error-container").removeClass("d-none")),n},createPin:function(){$("#loading").removeClass("d-none");var e={code:"PERSON",type:"REGISTER",subtype:"PIN",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{personId:logic.register.personData.internalId,emailAddresses:[],addresses:[],contactPhones:[],identityDocuments:[]},authenticationFactors:[{type:"PIN",subtype:"PIN",value:logic.register.personData.pin,checksum:""},{type:"KBA",subtype:"KBA",questionType:"STATIC",questions:{},checksum:""}]}};!1===config.pinRestore?e.data.authenticationFactors.splice(1,1):e.data.authenticationFactors[1].questions[$("#inputQuestion").val()]={answers:{RESP:$("#inputAnswer").val()}},$.ajax({url:config.baseUrl+"/api/v1/pin/create",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(e),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){!1===config.pinRestore?logic.loadStep("register",4,window.config.language,logic.register.personData):logic.nextStep(logic.register.personData)}).fail(logic.handleError).always(function(){$("#loading").addClass("d-none")})}},4:{captureOk:!1,begin:function(e){!1===config.useFingerprint?logic.nextStep(logic.register.personData):($("#loading").removeClass("d-none"),$("#btnNextStep").addClass("d-none"),window.logic.websocket.isConnect||window.logic.websocket.isConnecting?window.logic.websocket.isConnecting?window.setTimeout(window.logic.register[4].begin,1e3,e):!window.logic.websocket.isConnecting&&window.logic.websocket.isConnect&&($("#inFinger").val("2"),$("#btnCapture").click(function(){$("#error-container").addClass("d-none"),$(".feedback").removeClass("d-none"),$(this).addClass("disabled"),$(this).addClass("d-none"),$("#current-capture-text").text("1").data("number",1),$("#total-capture-text").text(logic.websocket.captureQty),$("#capture-progress").removeClass("d-none");var e=window.text[logic.current.language].register.step4.userMessage.partA+$("#inFinger").children("option:selected").text()+window.text[logic.current.language].register.step4.userMessage.partB;$("#user-message").text(e),logic.register[4].captureOk=!1,window.logic.websocket.register($("#inFinger").val(),logic.websocket.captureQty,logic.register[4].updateFingerprint,logic.register[4].createFingerprint)}),$("#inFinger").on("change",function(){var e="assets/finger/"+$(this).val().toString()+".png";$("#image-swap").attr("src",e)}),$("#loading").addClass("d-none")):logic.nextStep(logic.register.personData))},validate:function(){return!0},updateFingerprint:function(e){if(0==e.status.code){if($("#error-container").addClass("d-none"),e.data.authenticationFactors&&e.data.authenticationFactors[0].preview){$("#error-container").addClass("d-none");var t=$("#current-capture-text").data("number");t=parseInt(t)+1,$("#current-capture-text").text(t).data("number",t),$("#imgFingerprint").attr("src","data:image/jpeg;base64,"+e.data.authenticationFactors[0].preview)}}else{var n="";n=18==e.status.code?text[logic.current.language].errors.CAPTURE_MATCH:text[logic.current.language].errors.CAPTURE_GENERAL,$(".feedback").addClass("d-none"),$("#error-message").text(n),$("#error-container").removeClass("d-none")}},captureComplete:function(){return!0},createFingerprint:function(e){if(console.log(e),$("#capturing").addClass("d-none"),$("#btnCapture").removeClass("disabled"),$("#btnCapture").removeClass("d-none"),$("#capture-progress").addClass("d-none"),0==e.status.code)$("#loading").removeClass("d-none"),delete e.status,delete e.data.config,e.code="PERSON",e.type="REGISTER",e.subtype="FINGERPRINT",e.data.digitalIdentity={personId:logic.register.personData.internalId,identityDocuments:[]},e.client?(e.client.operationId=config.operationId,e.client.companyId=config.companyId,e.client.username=""):e.client={operationId:config.operationId,companyId:config.companyId,username:config.username,token:""},$.ajax({url:config.baseUrl+"/api/v1/fingerprint/",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(e),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){logic.register[4].captureOk=!0,logic.nextStep(logic.register.personData)}).fail(logic.handleError).always(function(){$("#loading").addClass("d-none")});else{var t="";t=21==e.status.code?text[logic.current.language].errors.CAPTURE_MATCH:text[logic.current.language].errors.CAPTURE_GENERAL,$("#error-message").text(t),$("#error-container").removeClass("d-none")}}},5:{begin:function(e){$("#btnFinish").click(function(){if(logic.register.backTo){var e=Object.assign({from:"register"},logic.register.personData);logic.loadStep(logic.register.backTo.process,logic.register.backTo.step,window.config.language,e)}else{var t=[{type:"PERSONAL",address:logic.register.personData.email,primary:!0}];logic.register.personData.email2&&""!=logic.register.personData.email2&&t.push({type:"PERSONAL",address:logic.register.personData.email2,primary:!1});var n={action:config.action,data:{digitalIdentity:{personId:logic.register.personData.internalId,personalData:{givenNames:logic.register.personData.givennames,surnames:logic.register.personData.surnames,dob:logic.register.personData.birthdate,gender:logic.register.personData.gender},emailAddresses:t,contactPhones:{type:"MOBILE",number:logic.register.personData.cellphone,primary:!0},identityDocuments:[{type:logic.register.personData.docType,countryCode:logic.register.personData.docCountry,number:logic.register.personData.documentId,personalNumber:logic.register.personData.personId,issueDate:"20190101",expiryDate:"21001231",issuingAuthority:"",nationality:logic.register.personData.docCountry,statusDocument:logic.register.personData.statusDocument}]}},operator:{sessionId:window.config.operator.sessionId},numError:0,msError:""};window.opener.callback(n)}}),$("main").addClass("nopadding"),$("footer").addClass("d-none")}}},window.logic||(window.logic={}),window.logic.verify={personData:{},loadedParams:!1,countRetry:0,steps:7,1:{begin:function(e){if(console.log("begin verify"),logic.getProfiles(),window.config.operator.identityDocument.personalNumber==window.config.digitalIdentity.identityDocuments[0].personalNumber?console.log("same person"):console.log("different person"),logic.validateProfile("VERIFY_PERSON")||window.config.operator.identityDocument.personalNumber==window.config.digitalIdentity.identityDocuments[0].personalNumber){if($("#loading").removeClass("d-none"),e.from)return logic.verify.personData=e.personData,void logic.nextStep(logic.verify.personData);logic.verify.loadedParams||logic.verify[1].loadDataFromParams(),logic.verify[1].getPerson(),$("#btnNextStep").addClass("d-none")}else{var t=text[logic.current.language].errors.INVALID_PROFILE;if(null==config.handleErrs||0==config.handleErrs){var n={action:config.action,data:null,operator:{sessionId:window.config.operator.sessionId},numError:1e3,msError:t};window.opener.callback(n)}else{var o={};o.personIdFormatted=Formatter.PersonId[config.digitalIdentity.identityDocuments[0].countryCode][config.digitalIdentity.identityDocuments[0].type].format(config.digitalIdentity.identityDocuments[0].personalNumber),o.numError=1e3,o.msError=t,o.action=config.action,logic.loadStep("weberror",1,window.config.language,o)}}},validate:function(){return!0},loadDataFromParams:function(){if(logic.verify.loadedParams=!0,config.digitalIdentity.personalData){var e=config.digitalIdentity.personalData;e.dob&&(logic.verify.personData.birthdate=e.dob),e.gender&&(logic.verify.personData.gender=e.gender),e.surnames&&(logic.verify.personData.surnames=e.surnames),e.givenNames&&(logic.verify.personData.givennames=e.givenNames)}if(config.digitalIdentity.emailAddresses){var t=config.digitalIdentity.emailAddresses;0<t.length&&(t[0].address&&(logic.verify.personData.email=t[0].address),1<t.length&&t[1].address&&(logic.verify.personData.email2=t[1].address))}if(config.digitalIdentity.contactPhones){var n=config.digitalIdentity.contactPhones;0<n.length&&n[0].number&&(logic.verify.personData.cellphone=n[0].number)}if(logic.verify.personData.docType="ID",logic.verify.personData.docCountry="CL",config.digitalIdentity.identityDocuments){var o=config.digitalIdentity.identityDocuments;0<o.length&&(o[0].personalNumber&&(logic.verify.personData.personId=o[0].personalNumber),o[0].number&&(logic.verify.personData.documentId=o[0].number),o[0].type&&(logic.verify.personData.docType=o[0].type),o[0].countryCode&&(logic.verify.personData.docCountry=o[0].countryCode))}},getPerson:function(){var e={code:"PERSON",type:"GET",subtype:"PERSON",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:1549887978384,client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[config.digitalIdentity.identityDocuments[0]]}}};$.ajax({method:"POST",contentType:"application/json",dataType:"json",crossDomain:!0,url:config.baseUrl+"/api/v1/person/get",headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId},data:JSON.stringify(e)}).done(function(e){logic.verify.personData.internalId=e.data.digitalIdentity.personId,logic.verify.personData.gender=e.data.digitalIdentity.personalData.gender,logic.verify.personData.surnames=e.data.digitalIdentity.personalData.surnames,logic.verify.personData.givennames=e.data.digitalIdentity.personalData.givenNames,logic.verify.personData.docType=e.data.digitalIdentity.identityDocuments[0].type,logic.verify.personData.docCountry=e.data.digitalIdentity.identityDocuments[0].countryCode,logic.verify.personData.personId=e.data.digitalIdentity.identityDocuments[0].personalNumber,logic.verify.personData.documentId=e.data.digitalIdentity.identityDocuments[0].number,logic.verify.personData.personIdFormatted=Formatter.PersonId[logic.verify.personData.docCountry][logic.verify.personData.docType].format(logic.verify.personData.personId);var t=e.data.digitalIdentity.contactPhones,n=e.data.digitalIdentity.emailAddresses;t&&0<t.length&&$.each(t,function(e,t){t.primary&&(logic.verify.personData.cellphone=t.number)}),n&&0<n.length&&$.each(n,function(e,t){t.primary?logic.verify.personData.email=t.address:logic.verify.personData.email2=t.address}),logic.nextStep(logic.verify.personData)}).fail(function(e){var t=text[logic.current.language].errors,n="",o=0;if(null!=config.useVerifyExt&&1==config.useVerifyExt)return window.config.digitalIdentity.personId=1,logic.verify.personData.internalId=logic.verify.personData.personId,logic.verify.personData.personIdFormatted=Formatter.PersonId[logic.verify.personData.docCountry][logic.verify.personData.docType].format(logic.verify.personData.personId),void logic.nextStep(logic.verify.personData);if(e.responseJSON)if(o=e.status,401===e.status||403===e.status)n=t.AUTH;else{if(404==e.status)return void logic.loadStep("register",1,window.config.language,{backTo:{process:"verify",step:1}});n=t.PROCESS}else n=t.COMM,o=1e3;if(null==config.handleErrs||0==config.handleErrs){var i={action:config.action,data:logic.verify.result,operator:{sessionId:window.config.operator.sessionId},numError:o,msError:n};window.opener.callback(i)}else{$("#loading").addClass("d-none");var a={};a.numError=o,a.msError=n,a.action=config.action,a.personIdFormatted=Formatter.PersonId[config.digitalIdentity.identityDocuments[0].countryCode][config.digitalIdentity.identityDocuments[0].type].format(config.digitalIdentity.identityDocuments[0].personalNumber),a.result=logic.verify.result,logic.loadStep("weberror",1,window.config.language,a)}}).always(function(){})}},2:{begin:function(e){if(logic.verify.personData.pinRestore=config.pinRestore,$("#loading").removeClass("d-none"),config.method)"PIN"==config.method?logic.nextStep(logic.verify.personData):"FINGERPRINT"==config.method&&(null!=config.useVerifyExt&&0==config.useVerifyExt?logic.loadStep("verify",5,window.config.language,logic.verify.personData):logic.loadStep("verify",6,window.config.language,logic.verify.personData));else{if($("#verify-opt-pin").click(function(){logic.nextStep(logic.verify.personData)}),$("#verify-opt-finger").click(function(){$("#loading").removeClass("d-none"),null!=config.useVerifyExt&&0==config.useVerifyExt?logic.loadStep("verify",5,window.config.language,logic.verify.personData):logic.loadStep("verify",6,window.config.language,logic.verify.personData)}).removeClass("d-none"),$("#verify-opt-clave_unica").click(function(){}),$("#verify-opt-facial").click(function(){}),!window.logic.websocket.isConnecting&&window.logic.websocket.isConnect)return void(null!=config.useVerifyExt&&0==config.useVerifyExt?window.setTimeout(window.logic.verify[5].begin,1e3,e):window.setTimeout(window.logic.verify[6].begin,1e3,e));$("#loading").addClass("d-none")}},validate:function(){return!0}},3:{begin:function(e){$("footer").removeClass("d-none"),$("main").removeClass("nopadding"),$("#btnNextStep").removeClass("d-none").unbind("click").click(function(e){e.preventDefault(),logic.validateCurrent()&&logic.verify[3].validatePin()}),$(".pin").keyup(function(e){var t=null;if(8==e.keyCode)(t=$(".pin")[$(".pin").index(this)-1])&&t.focus();else if(/^[0-9]$/.test(e.target.value)){if(""!=$(this).val()){var n=$(this).data("nextfocus");n&&$("#"+n).focus()}}else $(this).val("")}),$("#btnForgot").click(function(e){e.preventDefault(),$("#loading").removeClass("d-none"),logic.nextStep(logic.verify.personData)}),$("#loading").addClass("d-none")},validate:function(){return!0},validatePin:function(){$("#loading").removeClass("d-none");var n="";$(".pin").each(function(e,t){n+=$(t).val()});var e={code:"PERSON",type:"VERIFY",subtype:"PIN",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:123456,appFlow:{code:"",step:""},client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[config.digitalIdentity.identityDocuments[0]]},authenticationFactors:[{type:"PIN",subtype:"PIN",value:n}]}};$.ajax({url:config.baseUrl+"/api/v1/verify/pin",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(e),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){if(e.data.authenticationResult.authenticated)logic.verify.result=e.data.authenticationResult,logic.loadStep("verify",7,window.config.language,{personData:logic.verify.personData,authentication:logic.verify.result});else{if(logic.verify.countRetry++,logic.verify.countRetry>=window.config.retry.pin)return void logic.loadStep("verify",7,window.config.language,{personData:logic.verify.personData,authentication:logic.verify.result});var t,n=window.config.retry.fingerprint-logic.verify.countRetry,o="";o=1==n?window.text[logic.current.language].verify.step3.attempsB:n+" "+window.text[logic.current.language].verify.step3.attempsA,$("#attemps").removeClass("d-none"),$("#attemps").text(o),$(".pin").val(""),$("#input-pin-1").focus(),t=text[logic.current.language].errors.PERSON_NO_AUTH,$("#error-message").text(t),$("#error-container").removeClass("d-none"),$("#loading").addClass("d-none")}}).fail(logic.handleError).always(function(){$("#loading").addClass("d-none")})}},4:{begin:function(e){var t={code:"PERSON",type:"GET",subtype:"KBA",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:1549887978384,client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[config.digitalIdentity.identityDocuments[0]]},authenticationFactors:[{type:"KBA",subtype:"KBA",questionType:"STATIC"}]}};$.ajax({url:config.baseUrl+"/api/v1/kba/get",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(t),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){var t;e.data.authenticationFactors&&0<e.data.authenticationFactors.length?(logic.verify.lastQuestion=atob(e.data.authenticationFactors[0].value),$("#lbl-question").text(atob(e.data.authenticationFactors[0].value))):(t=text[logic.current.language].errors.KBA_NO_DATA,$("#error-message").text(t),$("#error-container").removeClass("d-none"))}).fail(function(e){var t=text[logic.current.language].errors,n="";e.responseJSON?401===e.status||403===e.status?n=t.AUTH:404==e.status?logic.loadStep("register",1,window.config.language,{backTo:{process:"verify",step:1}}):n=t.PROCESS:n=t.COMM,$("#error-message").text(n),$("#error-container").removeClass("d-none")}).always(function(){$("#loading").addClass("d-none")}),$("#btnNextStep").removeClass("d-none").unbind("click").click(function(e){e.preventDefault(),logic.validateCurrent()&&logic.verify[4].validateQuestion()})},validateQuestion:function(){var e={code:"PERSON",type:"VERIFY",subtype:"KBA",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:1549887978384,client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[config.digitalIdentity.identityDocuments[0]]},authenticationFactors:[{type:"KBA",subtype:"KBA",questionType:"STATIC",questions:{}}]}};e.data.authenticationFactors[0].questions[logic.verify.lastQuestion]={answers:{RESP:$("#input-answer").val()}},$.ajax({url:config.baseUrl+"/api/v1/verify/kba",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(e),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){if(e.data.authenticationResult.authenticated){logic.verify.personData=logic.verify.personData;var t=Object.assign({backTo:{process:"verify",step:3}},logic.verify.personData);config.useFingerprint=!1,config.usePin=!0,logic.loadStep("register",2,window.config.language,t)}else $("#error-message").text(text[logic.current.language].errors.QUESTION_MATCH),$("#error-container").removeClass("d-none")}).fail(function(e){var t=text[logic.current.language].errors,n="";e.responseJSON?401===e.status||403===e.status?n=t.AUTH:404==e.status?logic.loadStep("register",1,window.config.language,{backTo:{process:"verify",step:1}}):n=t.PROCESS:n=t.COMM,$("#error-message").text(n),$("#error-container").removeClass("d-none")}).always(function(){$("#loading").addClass("d-none")})},validate:function(){return!0}},5:{begin:function(e){if($("#loading").removeClass("d-none"),window.logic.websocket.isConnect||window.logic.websocket.isConnecting){if(window.logic.websocket.isConnecting)window.setTimeout(window.logic.verify[5].begin,1e3,e);else if(!window.logic.websocket.isConnecting&&window.logic.websocket.isConnect){$(".finger-layer").addClass("d-none"),$("#btnNextStep").unbind("click").click(function(e){e.preventDefault(),logic.validateCurrent()&&logic.nextStep({})}),$("#loading").removeClass("d-none"),$("#inFinger").val("2"),$("#btnCapture").click(function(){$(".feedback").removeClass("d-none"),logic.verify[5].captureOk=!1,window.logic.websocket.verify(logic.verify[5].data,logic.verify[5].matching),$("#btnCapture").addClass("disabled"),$("#error-container").addClass("d-none")}),$("#inFinger").on("change",function(){var e="assets/finger/"+$(this).val().toString()+".png";$("#image-swap").attr("src",e)});var t={code:"PERSON",type:"GET",subtype:"FINGERPRINT",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),id:123456,client:{operationId:config.operationId,companyId:config.companyId,username:""},data:{digitalIdentity:{identityDocuments:[config.digitalIdentity.identityDocuments[0]]},authenticationFactors:[{type:"FINGERPRINT",subtype:"FINGERPRINT",id:0,minutiaesFormat:"0"}]}};$.ajax({url:config.baseUrl+"/api/v1/fingerprint/get",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(t),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){if(0==(logic.verify[5].data=e).data.authenticationFactors.length){var t=text[logic.current.language].errors.NOT_FOUND_FINGERPRINTS;$("#error-message").text(t),$("#error-container").removeClass("d-none")}else $.each(e.data.authenticationFactors,function(e,t){$("#finger-layer-"+t.id).removeClass("d-none")}),$("#btnCapture").click()}).fail(function(e){var t=text[logic.current.language].errors,n="";e.responseJSON?401===e.status||403===e.status?n=t.AUTH:404==e.status?logic.loadStep("register",1,window.config.language,{backTo:{process:"verify",step:1}}):n=t.PROCESS:n=t.COMM,$("#error-message").text(n),$("#error-container").removeClass("d-none")}).always(function(){$("#loading").addClass("d-none")})}}else{var n=text[logic.current.language].errors.WS_CONNECTION,o={};if(null==config.handleErrs||0==config.handleErrs){var i={action:config.action,method:"FINGERPRINT",data:logic.verify.result,operator:{sessionId:window.config.operator.sessionId},numError:5e3,msError:n};window.opener.callback(i)}else $("#loading").addClass("d-none"),o.numError=5e3,o.msError=n,o.action=config.action,o.result=logic.verify.result,o.personIdFormatted=logic.verify.personData.personIdFormatted,o.givennames=logic.verify.personData.givennames,o.surnames=logic.verify.personData.surnames,logic.loadStep("weberror",1,window.config.language,o)}},validate:function(){return!0},matching:function(e){if($(".feedback").addClass("d-none"),0==e.status.code){$("#loading").removeClass("d-none"),logic.verify.result=e.data.authenticationResult;var t={code:"PERSON",type:"VERIFY",subtype:"FINGERPRINT",createdAt:e.createdAt,id:e.id,client:{operationId:config.operationId,companyId:config.companyId,username:"",machineId:e.client.machineId},data:{digitalIdentity:{identityDocuments:[config.digitalIdentity.identityDocuments[0]]},authenticationFactors:e.data.authenticationFactors,authenticationResult:e.data.authenticationResult,settings:{codParametro:["VERIFYEXT"],indicador:["N"]},info:e.data.info}};$.ajax({url:config.baseUrl+"/api/v1/verify/fingerprint",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(t),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){if(e.data.authenticationResult.authenticated)logic.verify.result=e.data.authenticationResult,logic.loadStep("verify",7,window.config.language,{personData:logic.verify.personData,authentication:logic.verify.result});else{if(logic.verify.countRetry++,logic.verify.countRetry>=window.config.retry.fingerprint)return void logic.loadStep("verify",7,window.config.language,{personData:logic.verify.personData,authentication:logic.verify.result});var t,n=window.config.retry.fingerprint-logic.verify.countRetry,o="";o=1==n?window.text[logic.current.language].verify.step3.attempsB:n+" "+window.text[logic.current.language].verify.step3.attempsA,$("#attemps").removeClass("d-none"),$("#attemps").text(o),t=text[logic.current.language].errors.PERSON_NO_AUTH,$("#error-message").text(t),$("#error-container").removeClass("d-none"),$("#loading").addClass("d-none"),$("#btnCapture").removeClass("disabled"),$("#btnCapture").removeClass("d-none")}}).fail(function(e){var t=text[logic.current.language].errors,n="";e.responseJSON?401===e.status||403===e.status?n=t.AUTH:404==e.status?logic.loadStep("register",1,window.config.language,{backTo:{process:"verify",step:1}}):n=t.PROCESS:n=t.COMM,$("#error-message").text(n),$("#error-container").removeClass("d-none")}).always(function(){$("#loading").addClass("d-none")})}else{var n=text[logic.current.language].errors,o="";401===e.status.code||403===e.status.code?o=n.AUTH:404==e.status.code?logic.loadStep("register",1,window.config.language,{backTo:{process:"verify",step:1}}):o=n.PROCESS,$("#error-message").text(o),$("#error-container").removeClass("d-none"),$("#btnCapture").removeClass("disabled")}}},6:{begin:function(e){if($("#loading").removeClass("d-none"),window.logic.websocket.isConnect||window.logic.websocket.isConnecting)window.logic.websocket.isConnecting?window.setTimeout(window.logic.verify[6].begin,1e3,e):!window.logic.websocket.isConnecting&&window.logic.websocket.isConnect&&($(".finger-layer").addClass("d-none"),$("#btnNextStep").unbind("click").click(function(e){e.preventDefault(),logic.validateCurrent()&&logic.nextStep({})}),$("#loading").removeClass("d-none"),$("#inFinger").val("2"),$("#btnCapture").click(function(){var e=logic.websocket.captureQtyVerifyExt;$("#error-container").addClass("d-none"),$(".feedback").removeClass("d-none"),$("#btnCapture").addClass("disabled"),$("#btnCapture").addClass("d-none"),$("#current-capture-text").text("1").data("number",1),$("#total-capture-text").text(e),$("#capture-progress").removeClass("d-none");var t=window.text[logic.current.language].verify.step6.userMessage.partA+$("#inFinger").children("option:selected").text()+window.text[logic.current.language].verify.step6.userMessage.partB;$("#user-message").text(t),logic.verify[6].captureOk=!1,window.logic.websocket.capture($("#inFinger").val(),e,logic.verify[6].updateFingerprint,logic.verify[6].matching)}),$("#inFinger").on("change",function(){var e="assets/finger/"+$(this).val().toString()+".png";$("#image-swap").attr("src",e)}),$("#loading").addClass("d-none"));else{var t=text[logic.current.language].errors.WS_CONNECTION,n={};if(null==config.handleErrs||0==config.handleErrs){var o={action:config.action,method:"FINGERPRINT",data:logic.verify.result,operator:{sessionId:window.config.operator.sessionId},numError:5e3,msError:t};window.opener.callback(o)}else $("#loading").addClass("d-none"),n.numError=5e3,n.msError=t,n.action=config.action,n.result=logic.verify.result,n.personIdFormatted=logic.verify.personData.personIdFormatted,n.givennames=logic.verify.personData.givennames,n.surnames=logic.verify.personData.surnames,logic.loadStep("weberror",1,window.config.language,n)}},validate:function(){return!0},updateFingerprint:function(e){if(0==e.status.code){if($("#error-container").addClass("d-none"),e.data.authenticationFactors&&e.data.authenticationFactors[0].preview){$("#error-container").addClass("d-none");var t=$("#current-capture-text").data("number");t=parseInt(t)+1,$("#current-capture-text").text(t).data("number",t),$("#imgFingerprint").attr("src","data:image/jpeg;base64,"+e.data.authenticationFactors[0].preview)}}else{var n="";n=18==e.status.code?text[logic.current.language].errors.CAPTURE_MATCH:text[logic.current.language].errors.CAPTURE_GENERAL,$(".feedback").addClass("d-none"),$("#error-message").text(n),$("#error-container").removeClass("d-none")}},matching:function(e){if($(".feedback").addClass("d-none"),0==e.status.code){$("#loading").removeClass("d-none"),logic.verify.result=e.data.authenticationResult;var t={code:"PERSON",type:"VERIFY",subtype:"FINGERPRINT",createdAt:e.createdAt,id:e.id,client:{operationId:config.operationId,companyId:config.companyId,username:"",machineId:e.client.machineId},data:{digitalIdentity:config.digitalIdentity,authenticationFactors:e.data.authenticationFactors,authenticationResult:e.data.authenticationResult,settings:{codParametro:["VERIFYEXT"],indicador:["S"]},info:e.data.info}};$.ajax({url:config.baseUrl+"/api/v1/verify/fingerprint",datatype:"json",type:"POST",crossDomain:!0,contentType:"application/json",data:JSON.stringify(t),headers:{"X-Auth-Token":config.apiKey,"X-Session-Token":logic.current.sessionId}}).done(function(e){if(e.data.authenticationResult.authenticated)logic.verify.result=e.data.authenticationResult,logic.loadStep("verify",7,window.config.language,{personData:logic.verify.personData,authentication:logic.verify.result});else{if(logic.verify.countRetry++,logic.verify.countRetry>=window.config.retry.fingerprint)return void logic.loadStep("verify",7,window.config.language,{personData:logic.verify.personData,authentication:logic.verify.result});var t,n=window.config.retry.fingerprint-logic.verify.countRetry,o="";o=1==n?window.text[logic.current.language].verify.step3.attempsB:n+" "+window.text[logic.current.language].verify.step3.attempsA,$("#attemps").removeClass("d-none"),$("#attemps").text(o),t=text[logic.current.language].errors.PERSON_NO_AUTH,$("#error-message").text(t),$("#error-container").removeClass("d-none"),$("#loading").addClass("d-none"),$("#btnCapture").removeClass("disabled"),$("#btnCapture").removeClass("d-none")}}).fail(function(e){var t=text[logic.current.language].errors,n="";e.responseJSON?401===e.status||403===e.status?n=t.AUTH:404==e.status?logic.loadStep("register",1,window.config.language,{backTo:{process:"verify",step:1}}):n=t.PROCESS:n=t.COMM,$("#btnCapture").removeClass("disabled"),$("#btnCapture").removeClass("d-none"),$("#error-message").text(n),$("#error-container").removeClass("d-none")}).always(function(){$("#loading").addClass("d-none")})}else{var n=text[logic.current.language].errors,o="";401===e.status.code||403===e.status.code?o=n.AUTH:404==e.status.code?logic.loadStep("register",1,window.config.language,{backTo:{process:"verify",step:1}}):o=n.PROCESS,$("#error-message").text(o),$("#error-container").removeClass("d-none"),$("#btnCapture").removeClass("disabled")}}},7:{begin:function(e){$("#btnFinish").click(function(){var e={action:config.action,data:logic.verify.result,operator:{sessionId:window.config.operator.sessionId},numError:0,msError:""};window.opener.callback(e)}),$("main").addClass("nopadding"),$("footer").addClass("d-none")},validate:function(){return!0}}},window.logic||(window.logic={}),window.logic.weberror={personData:{},steps:1,1:{begin:function(t){return $("#btnFinish").click(function(){var e={action:config.action,data:t.result,operator:{sessionId:window.config.operator.sessionId},numError:t.numError,msError:t.msError};window.opener.callback(e)}),$("main").addClass("nopadding"),$("footer").addClass("d-none"),!0},validate:function(){return!0}}},window.logic=window.logic?window.logic:{},window.logic.websocket=function(){var t=function(){0==window.logic.websocket.socket.readyState?window.setTimeout(t,500):3==window.logic.websocket.socket.readyState?(window.logic.websocket.isConnecting=!1,window.logic.websocket.isConnect=!1):window.logic.websocket.isConnecting=!1};return{isConnect:!1,isConnecting:!1,captureQty:3,captureQtyVerifyExt:1,threshold:50,minQuality:50,connect:function(n){window.logic.websocket.isConnecting=!0;var e=new WebSocket("wss://wsocktray.checkid.cl:3013");e.onopen=function(e){},e.onmessage=function(e){var t=JSON.parse(e.data);"CONNECTION"==t.code?(n&&n(t),window.logic.websocket.isConnect=!0):"PERSONA"!=t.code&&"PERSON"!=t.code||"CAPTURAR"!=t.type&&"CAPTURE"!=t.type?"PERSONA"!=t.code&&"PERSON"!=t.code||"VERIFICAR"!=t.type&&"VERIFY"!=t.type?"PERSONA"!=t.code&&"PERSON"!=t.code||"REGISTRAR"!=t.type&&"REGISTER"!=t.type||(t.status.update?window.logic.websocket.updateCallback&&window.logic.websocket.updateCallback(t):window.logic.websocket.finishCallback&&window.logic.websocket.finishCallback(t)):window.logic.websocket.finishCallback&&window.logic.websocket.finishCallback(t):t.status.update?window.logic.websocket.updateCallback&&window.logic.websocket.updateCallback(t):window.logic.websocket.finishCallback&&window.logic.websocket.finishCallback(t)},e.onclose=function(e){window.logic.websocket.isConnect=!1},e.onerror=function(e){window.logic.websocket.errorCallback&&window.logic.websocket.errorCallback(e)},window.logic.websocket.socket=e,t()},capture:function(e,t,n,o,i){var a={code:"PERSON",type:"CAPTURE",subtype:"FINGERPRINT",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),data:{config:{MaxCapture:n,Threshold:window.logic.websocket.threshold,MinQuality:window.logic.websocket.minQuality,fingerId:e,fingersID:t}}};window.logic.websocket.updateCallback=o,window.logic.websocket.finishCallback=i,window.logic.websocket.socket.send(JSON.stringify(a))},register:function(e,t,n,o){var i={code:"PERSONA",type:"REGISTRAR",subtype:"FINGERPRINT",createdAt:moment().format("YYYY-MM-DDTHH:mm:ss.SSS"),data:{config:{MaxCapture:t,Threshold:window.logic.websocket.threshold,MinQuality:window.logic.websocket.minQuality,fingerId:e}}};window.logic.websocket.updateCallback=n,window.logic.websocket.finishCallback=o,window.logic.websocket.socket.send(JSON.stringify(i))},verify:function(e,t){var n={code:"PERSONA",type:"VERIFICAR",subtype:"FINGERPRINT",createdAt:e.createdAt,client:{operationId:config.operationId,companyId:null,username:null,password:null,token:logic.current.sessionId,machineId:null},data:{authenticationFactors:e.data.authenticationFactors,config:{threshold:window.logic.websocket.threshold,maxCapture:1,minQuality:window.logic.websocket.minQuality}}};window.logic.websocket.finishCallback=t,window.logic.websocket.socket.send(JSON.stringify(n))},setHandleError:function(e){window.logic.websocket.errorCallback=e}}}();