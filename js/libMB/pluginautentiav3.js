function _indexOf(t,e){for(var o=0;o<t.length;o++)if(t[o]===e)return o;return-1}function _filter(t,e){var o,r=[];for(o in t)e(t[o])&&r.push(t[o]);return r}function _trim(t){return t.replace(/^[ \t\r\n]*/,"").replace(/[ \t\r\n]*$/,"")}function done(){}function load(){window.onload=function(){if(void 0===window.jQuery){var t="https:"==location.protocol?"https":"http",e=document.createElement("script");e.onload=done,e.src=t+"://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js",document.getElementsByTagName("body")[0].appendChild(e),e=document.createElement("script"),e.onload=done,document.getElementsByTagName("body")[0].appendChild(e),JQuery.blockUI()}else done()}}function getCookie(t){for(var e=t+"=",o=document.cookie.split(";"),r=0;r<o.length;r++){for(var n=o[r];" "==n.charAt(0);)n=n.substring(1);if(0==n.indexOf(e))return n.substring(e.length,n.length)}return""}function httpRequest(){var t;return window.XMLHttpRequest?(t=new XMLHttpRequest,console.debug("LOAD:: XMLHttpRequest()")):(t=new ActiveXObject("Microsoft.XMLHTTP"),console.debug('LOAD:: ActiveXObject("Microsoft.XMLHTTP")')),t}function FirmaInvalidaMB(t,e){var o=e.replace(/"signature":"[^"]+"/,'"signature":""'),r=new X509;r.readCertPEM(PublicCERT);var n=r.subjectPublicKeyRSA.verifyString(o,t.signature),i=!1;return n||(o=e.replace(/"signature":"[^"]+"/,'"signature":""'),o=o.replace(/"token":"[^"]+"/,'"token":""'),n=r.subjectPublicKeyRSA.verifyString(o,t.signature),n||(i=!0)),i}function procesarJSON(t,e,o){var r=JSON.stringify(t);console.debug("Autentia request:",t);try{var n=jQuery.ajax({headers:{"Content-type":"text/plain; charset=ISO8859_1"},type:"POST",url:"https://plugin.autentia.mb:7777/"+e+"/"+t.token,success:function(t){var e=JSON.parse(t);console.debug("Autentia response:",e),exitoAutentia(e)&&FirmaInvalidaMB(e,t)&&(e={ParamsGet:{ercText:"Firma de proceso seguro invalido"}}),errorFatalAutentia(e)&&console.error(e.ercText),o(e)},error:function(){o({ParamsGet:{ercText:"Error de comunicacion con la componente Autentia."}})},complete:function(){},dataType:"text",data:r});console.log("AjaxResult",n),1!==n.readyState&&o({ParamsGet:{erc:-1,ercText:"AjaxError: "+n.statusText}})}catch(i){console.log("ERROR",i),o({ParamsGet:{erc:-1,ercText:"ERROR: "+i.message}})}}function mensajeBloqueo(t,e){var o='<h5 style="font-family: Arial;">&nbsp;&nbsp;',r=location.href.replace(/[^\/]+$/,"img/ruedita.gif");return e===!0&&(o+='<img style="vertical-align: middle" src="'+r+'" />&nbsp;&nbsp;&nbsp;'),o+=t+"&nbsp;&nbsp;</h5>",{message:o,centerY:0,css:{border:"none",backgroundColor:"#ffffff","-webkit-border-radius":"10px","-moz-border-radius":"10px",opacity:1,color:"#000000",top:"20%",left:"37%",right:"",width:"400px","font-family":"Arial","font-weight":"Bold","font-size":"10px"}}}function plgAutentiaJS(){console.debug("Plugin Loaded!")}function valueOrDefault(t,e){try{var o=t();if(void 0!==o)return o}catch(r){}return e}function glosaAutentia(t){return decodeURIComponent(escape(t.ParamsGet.ErcText||t.ParamsGet.ercText||t.ParamsGet.ErcDesc||t.ParamsGet.ercDesc))}function exitoAutentia(t){return 0===parseInt(valueOrDefault(function(){return t.ParamsGet.erc}))}function errorFatalAutentia(t){return""!=valueOrDefault(function(){return t.error},"")}var PublicCERT="-----BEGIN CERTIFICATE----- MIIDtDCCApwCCQDyBCwa1s/2nzANBgkqhkiG9w0BAQsFADCBmzELMAkGA1UEBhMC Q0wxFDASBgNVBAgMC1Byb3ZpZGVuY2lhMREwDwYDVQQHDAhTYW50aWFnbzERMA8G A1UECgwIQXV0ZW50aWExEzARBgNVBAsMCklubm92YWNpb24xGDAWBgNVBAMMD011 bHRpYnJvd3NlciBKUzEhMB8GCSqGSIb3DQEJARYSc29wb3J0ZUBhY2VwdGEuY29t MB4XDTE1MDczMDIxMjYzOVoXDTE2MDcyOTIxMjYzOVowgZsxCzAJBgNVBAYTAkNM MRQwEgYDVQQIDAtQcm92aWRlbmNpYTERMA8GA1UEBwwIU2FudGlhZ28xETAPBgNV BAoMCEF1dGVudGlhMRMwEQYDVQQLDApJbm5vdmFjaW9uMRgwFgYDVQQDDA9NdWx0 aWJyb3dzZXIgSlMxITAfBgkqhkiG9w0BCQEWEnNvcG9ydGVAYWNlcHRhLmNvbTCC ASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAK02PVvUOkj5gSANZbsaCsq2 5PjSHPTzRbhLsnh4ILJhjsK+22mYSdI9eUD03kxakkYgRXbaaI5Vb/bLLnE92eVB ej9D6zOR8H53SXwrIEWtef7mCnQv2Y5l3GQjjk/+yNHs249AQaB3CdHCCuU1FUBo pBWm3dLiayBZD/J46KRkwMbA6/qifh2D9PC32fA93AsDC9kHYAoNv0Yeo/0D29PL N8M8Qvt1UeI7Zf/l9RhVvxVyIu7pUnYZIykm+TCtLuAdw01UkCUavFDJ96zsIztD W0wOpM+lGlWKqMd2LqfWl2iMrB3uHQEV/oFnFM47Ltv3eNabACUcRAInGhCyfXMC AwEAATANBgkqhkiG9w0BAQsFAAOCAQEAK2DnMXoPwt+9Ta24oIuUkcSgjUZ/fKiA CQ9B/tYS/Di6c5P8w3FW1j5JqWbp9HVxizxqqAKBkEovb9aYT35iSUwKN7ZBxPqC VPeNZJGR4tCMhYe4Tdvs007/Ag+YX3DrEbb9e2/DhYUU9eZVfUdyt11mHqspRRAS PQ4GK52u8tJ3fNXdm89Vli9J5RvI/Z6W+XfdYyVwSBSTrBjRpJtLcrrXt/nO1jMh RPBlKhHD0xmmh3ne+F1GCmcIJXwb8S1TaJer59hR+tpgxOSY6NwKmTPmGoMBLG4J oZmeq9HECQEuV3Kg0iq0e1wQAJH7fIZ7y9QXeopudP6eNz/uFwXE5Q== -----END CERTIFICATE----- ";Function.prototype.bind||(Function.prototype.bind=function(t){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var e=Array.prototype.slice.call(arguments,1),o=this,r=function(){},n=function(){return o.apply(this instanceof r&&t?this:t,e.concat(Array.prototype.slice.call(arguments)))};return r.prototype=this.prototype,n.prototype=new r,n}),void 0===window.console&&(window.console={log:function(){},error:function(){},debug:function(){}}),void 0===console.log&&(console.log=function(){}),void 0===console.error&&(console.error=function(){}),void 0===console.debug&&(console.debug=function(){}),window.readyState?window.onreadystatechange=function(){("complete"==this.readyState||"loaded"==this.readyState)&&load()}:load();var transaccion={},objPaquete=[],prmSet=[],token="",ProcesoFirmaPDF2=function(t,e,o){this.codDocumento=t,this.selectorCertificado=e,this.certificadoSeleccionado=null,this.ctxtId="",this.resultados=[],this.notificarFinProceso=o,this.documentoPorFirmar=0,this.lastToken=""};ProcesoFirmaPDF2.prototype.getToken=function(){return this.lastToken=""+Math.random(),this.lastToken},ProcesoFirmaPDF2.prototype.procesarListadoCertificados=function(t){exitoAutentia(t)?this.selectorCertificado(JSON.parse(t.ParamsGet.certificates),this.procesarSeleccionCertificado.bind(this)):(jQuery.unblockUI(),this.notificarFinProceso(!1,t))},ProcesoFirmaPDF2.prototype.procesarSeleccionCertificado=function(t){exitoAutentia(t)?(this.certificadoSeleccionado=t.ParamsGet,this.solicitarFirmaDocumento()):(jQuery.unblockUI(),this.notificarFinProceso(!1,t))},ProcesoFirmaPDF2.prototype.solicitarFirmaDocumento=function(){if(null===this.certificadoSeleccionado){jQuery.blockUI(mensajeBloqueo("Seleccionando el certificado del firmante...",!0));var t={paquete:[{comando:"CryptoAPI.ListCerts"}],token:this.getToken()};procesarJSON(t,"CryptoAPI",this.procesarListadoCertificados.bind(this))}else{var e=this.codDocumento.length;if(this.documentoPorFirmar<e){var t={paquete:[{comando:"CryptoAPI.SignDocument",urlDoc:this.codDocumento[this.documentoPorFirmar],idCert:this.certificadoSeleccionado.idCert,rut:this.certificadoSeleccionado.rut,ctxtId:this.ctxtId}],token:this.getToken()};procesarJSON(t,"CryptoAPI",this.procesarResultadoFirma.bind(this,(new Date).getTime()))}else jQuery.unblockUI(),this.notificarFinProceso(!0)}},ProcesoFirmaPDF2.prototype.procesarResultadoFirma=function(t,e){this.resultados.push(e),this.documentoPorFirmar+=1;var o=(new Date).getTime();console.log("CryptoAPI.SignDocument: ",o-t+" ms"),exitoAutentia(e)?(""==this.ctxtId&&(this.ctxtId=e.ParamsGet.ctxtId),this.solicitarFirmaDocumento()):(jQuery.unblockUI(),this.notificarFinProceso(!1,e))};var ProcesoFirmaPDF=function(t,e,o,r,n,i){this.codDocumento=_filter(t.split("|"),function(t){return""!=_trim(t)}),this.rutFirmante=e,this.nombreFirmante=o,this.apellidosFirmante=r,this.institucion=n,this.ctxtId="",this.resultados=[],this.notificarFinProceso=i,this.documentoPorFirmar=0,this.lastToken=""};ProcesoFirmaPDF.prototype.getToken=function(){return this.lastToken=""+Math.random(),this.lastToken},ProcesoFirmaPDF.prototype.solicitarFirmaDocumento=function(){var t=this.codDocumento.length;if(this.documentoPorFirmar<t){jQuery.blockUI(mensajeBloqueo("Procesando documento "+(this.documentoPorFirmar+1)+" de "+this.codDocumento.length,!0));var e={paquete:[{comando:"pdfXSign",doc:this.codDocumento[this.documentoPorFirmar],rutFirma:this.rutFirmante+"|"+this.ctxtId,nomFirma:this.nombreFirmante,apellidosFirma:this.apellidosFirmante,inst:this.institucion}],token:this.getToken()};procesarJSON(e,"pdfXSign",this.procesarResultadoFirma.bind(this,(new Date).getTime()))}else jQuery.unblockUI(),this.notificarFinProceso(!0)},ProcesoFirmaPDF.prototype.procesarResultadoFirma=function(t,e){this.resultados.push(e),this.documentoPorFirmar+=1;var o=(new Date).getTime();console.log("pdfXSign: ",o-t+" ms"),exitoAutentia(e)?(""==this.ctxtId&&(this.ctxtId=e.ParamsGet.ctxtId),this.solicitarFirmaDocumento()):(jQuery.unblockUI(),this.notificarFinProceso(!1,e))},plgAutentiaJS.prototype.firmarDocumentos=function(t,e,o){var r=new ProcesoFirmaPDF2(t,e,o);r.solicitarFirmaDocumento()},plgAutentiaJS.prototype.pdfXSign=function(t,e,o,r,n,i,a){var c=new ProcesoFirmaPDF(t,e,o,r,n,a);c.solicitarFirmaDocumento()},plgAutentiaJS.prototype.IniciarSesion=function(t,e,o){objPaquete.push({comando:"IniciarSesion",param:t});var r;transaccion.paquete=objPaquete,transaccion.token=e,r=procesarJSON(transaccion,"initSesion",function(t){return transaccion={},objPaquete=[],prmSet=[],o(t)})},plgAutentiaJS.prototype.IniciarSesionLogin=function(t,e,o){objPaquete.push({comando:"IniciarSesionLogin",param:t});var r;transaccion.paquete=objPaquete,transaccion.token=e,r=procesarJSON(transaccion,"initSesion",function(t){return transaccion={},objPaquete=[],prmSet=[],o(t)})},plgAutentiaJS.prototype.Transaccion2=function(t,e,o,r,n,i){jQuery.blockUI(mensajeBloqueo("Ejecutando transaccion autentia."));var a=[],c=[],s=0;for(var u in e)c.push(u),s+=1,a.push({idx:s,valor:e[u]});for(var u in o)_indexOf(c,o[u])<0&&c.push(o[u]);objPaquete.push({comando:"ParamsInit",param:c.join(",")}),a.length&&objPaquete.push({comando:"ParamsSet",param:a}),objPaquete.push({comando:"Transaccion",param:t});for(var u in o)objPaquete.push({comando:"ParamsGet",param:_indexOf(c,o[u])+1,paramName:o[u]});var l,d={};d.paquete=objPaquete,d.hookAutentia=r,d.token=n,l=procesarJSON(d,"json-handler",function(t){return d={},objPaquete=[],a=[],jQuery.unblockUI(),i(t)})},plgAutentiaJS.prototype.CerrarSesion=function(t){objPaquete.push({comando:"CerrarSesion",param:""});var e;transaccion.paquete=objPaquete,transaccion.token=t,e=procesarJSON(transaccion,"closeSesion",function(t){return transaccion={},objPaquete=[],prmSet=[],t})};
