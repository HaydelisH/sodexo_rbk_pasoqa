<div class="row">
    <div class="col-md-12">
        <div class="box">
            <!-- /.box-header -->
            <div class="box-body">
                <!--Mensajes-->
                <div id="mensajeOK"><php:texto id="mensajeOK" /></div>
                <div id="mensajeError"><php:texto id="mensajeError" /></div>
                <div id="mensajeAd"><php:texto id="mensajeAd" /></div>
                <!--Formulario de los datos propios de Categoria-->   
                <form role="form" name="formulario" id="formulario" action="Generar_Documentos_Masivo.php" method="POST" autocomplete="off" enctype="multipart/form-data">
                    <php:repeticion id="formulario">
                    <!--div class="form-row">
                        <div class="col-md-12">
                            <label style="float:right;"> (*) Campos obligatorios </label>
                        </div>
                    </div-->
                    <!--Subir documento-->
                    <!--div class="form-row">
                        <div class="col-md-6 xs-6">
                            <label for="contenedorid" >Empresa (*)</label>
                            <select class= "form-control" name="RutEmpresa" id="RutEmpresa">
                                <option value="0">(Seleccione)</option>
                                <php:repeticion id="Empresas">
                                <option value="<php:item id="RutEmpresa" />" <php:funcion id="ContenedorUtilidades::evaluarSeleccion"><php:argumento id="RutEmpresa" /><php:argumento idvalor="RutEmpresa" /></php:funcion>><php:item id="RazonSocial" /></option>
                                </php:repeticion>
                            </select>
                        </div>
                        <div class="col-md-6 xs-6">
                            <label>Cargo (*)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
                            <div class="col-md-10 xs-12 " style="padding-left: 0px;padding-top: 0px;">
                                <input class="form-control" type="text" name="nombrecargoempleado" id="nombrecargoempleado" placeholder="(Seleccione)" value="<php:item id="nombrecargoempleado"/>" readonly="readonly" />
                                <input type="hidden" name="idCargoEmpleado" id="idCargoEmpleado" placeholder="(Seleccione)" value="<php:item id="idCargoEmpleado"/>" />
                            </div>
                            <div class="col-md-1 xs-12" style="padding-left: 5px; padding-right: 0px;">
                                <button class="btn btn-md btn-primary btn-block" type="button" id="btn_cargoEmpleado" data-toggle="modal" data-target="#modal_cargoEmpleado"><i class="fa fa-search"></i></button>  
                            </div>
                        </div>
                    </div-->
                    <div class="form-row">
                        <div class="col-md-12">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="soloUno" checked>
                                <label class="form-check-label" for="soloUno">Utilizar planilla electronica</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="col-md-6 xs-12">
                            <label for="contenedorid" >Formulario (*)</label>
                            <select class= "form-control" name="idFormulario" id="idFormulario">
                                <option value="0">(Seleccione)</option>
                                <php:repeticion id="Formularios">
                                <option value="<php:item id="idFormulario" />" <php:funcion id="ContenedorUtilidades::evaluarSeleccion"><php:argumento id="idFormulario" /><php:argumento idvalor="idFormulario" /></php:funcion>><php:item id="nombreFormulario" /></option>
                                </php:repeticion>
                            </select>
                        </div>
                    </div>
                    <div class="form-row" id="con_planilla">
                        <div class="col-md-12" id="doc">
                            <label for="Subir" id="doc_label">Seleccione archivo de carga (*)</label>
                            <div class="form-group" id="doc_hijo"> 
                                <div class="col-md-11 xs-12" style="padding-left: 0px; padding-right: 0px;">
                                    <input type="text" class="form-control" placeholder="Seleccione archivo de carga" name="Documento" id="Documento" readonly>
                                </div>
                                <div class="col-md-1 xs-12" style="padding-left: 5px; padding-right: 0px;">
                                    <span class="btn btn-primary btn-file">
                                        <i class="fa fa-upload" aria-hidden="true"></i>
                                        <input type="file" name="archivo" id="archivo"  accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel"  />
                                    </span>
                                </div>
                                <span class="fileinput-filename"></span>
                                <span class="fileinput-new"></span>
                            </div>
                        </div>
                    </div>
                    <div class="form-row" id="sin_planilla" style="display:none">
                        <div class="col-md-12">
                            <label for="newusuarioid">Rut (*)</label>
                            <div class="input-group col-xs-12">
                                <input type="text" class="form-control" id="newusuarioid"  name="newusuarioid" placeholder="Rut v&aacute;lido" maxlength="10" value="<php:item id="newusuarioid" />" autofocus >
                            </div>
                        </div>
                    </div>
                    <div class="form-row">  
                        <div class="col-md-2 xs-12 pull-left">  
                            <button class="btn btn-md btn-success btn-block" type="button" name="accion" id="VER" value="VER" onclick="ver()" style="margin-top: 10px">Ver &uacute;ltima generaci&oacute;n</button>  
                        </div>
                        <div class="col-md-4 xs-12">  
                            <div id="estado" style="display:none;">
                                <div>
                                    <label id="estadodetalle">Estado proceso</label>
                                </div>
                                <progress value="0" id="progreso" max="<php:item id="highestRow" />">	</progress>
                            </div>
                        </div>
                        <div class="col-md-2 xs-12 pull-right">  
                            <!--input type="hidden" id="idWF" name="idWF"/>
                            <input type="hidden" id="input_empleado" name="input_empleado" value="<php:item id="input_empleado"/>"/>
                            <input type="hidden" id="ACTIVAR" name="ACTIVAR"/-->
                            <button class="btn btn-md btn-success btn-block" type="button" name="accion" id="GENERAR" value="GENERAR" style="margin-top: 10px" onclick="subirArchivo()" disabled>Enviar</button>  
                        </div>
                    </div>
                    <!--Fin del repeticion de formulario-->
                    </php:repeticion>  
                </form>
                <form name="resultado" id="resultado" action="Respuesta_asignacioFormulario.php" method="POST" >
                    <input type="hidden" id="IdArchivo" name="IdArchivo" value="2" />
                </form>
                <!--Modal de Centros de Costo-->
                <div class="modal fade" id="modal_cargoEmpleado" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
                    <div class="modal-dialog" >
                        <div class="modal-content">
                            <div class="modal-header" align="center">
                                <h4 class="modal-title" id="ejemplo-titulo"> Cargos </h4>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div id="mensajeError_modal"></div>
                                <table id="tabla_cargoEmpleado" class="table table-bordered table-hover" style="text-align: center">
                                    <thead >
                                        <tr>
                                            <th  style="text-align: center" >C&oacute;digo</th>
                                            <th  style="text-align: center" >Nombre</th>
                                            <th  style="text-align: center" >Selecci&oacute;n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                            <div class="modal-footer" style="margin-top:10px;">
                                <button type="button" class="btn btn-secondary btn-md" id="cerrar_cargoEmpleado" data-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</section>
<script>

//$('#idFormulario').val(1);
$('#soloUno').click(function()
{
    $('#GENERAR').attr('disabled', true);
    if ($("#soloUno").is(':checked'))
    {
        $('#sin_planilla').hide();
        $('#con_planilla').show();
        $('#newusuarioid').val('');
        //$("#idFormulario").prop("selectedIndex", 0).val(); 
    }
    else
    {
        $('#con_planilla').hide();
        $('#sin_planilla').show();
        $("#Documento").val('');
        $("#archivo").val('');
    }
});

/*
$("#RutEmpresa").change(function(){
    $("#nombrecargoempleado").val('');
    $("#idCargoEmpleado").val('');
});

//Modal de Cargos empleado
$("#btn_cargoEmpleado").click(function()
{
    var RutEmpresa = $("#RutEmpresa").val();
    $(".fila_ce").remove();
    if( RutEmpresa == 0 )
    {
        $("#mensajeError").addClass("callout callout-warning");
        $("#mensajeError").html("Debe seleccionar la Empresa");
        return false;
    }
    $("#mensajeError").html("");
    $("#mensajeError").removeClass("callout callout-warning");
    var url  = "postulacion_ajax3.php?RutEmpresa=" + RutEmpresa;
    // Creamos el control XMLHttpRequest segun el navegador en el que estemos 
    if( window.XMLHttpRequest )
        ajax = new XMLHttpRequest(); // No Internet Explorer
    else
        ajax = new ActiveXObject("Microsoft.XMLHTTP"); // Internet Explorer
    // Almacenamos en el control al funcion que se invocara cuando la peticion
    // cambie de estado 
    ajax.onreadystatechange = funcionCallback_cargoEmpleado;
    // Enviamos la peticion
    ajax.open( "GET", url, true );
    ajax.send( "" );
});

function funcionCallback_cargoEmpleado()
{
    // Comprobamos si la peticion se ha completado (estado 4)
    if( ajax.readyState == 4 )
    {
        // Comprobamos si la respuesta ha sido correcta (resultado HTTP 200)
        if( ajax.status == 200 )
        {
            // Escribimos el resultado en la pagina HTML mediante DHTML
            salida = ajax.responseText;
            listado = JSON.parse(salida); 
            num = listado.length;
            if( num > 0 ){
                //[{"0":"cc1","centrocostoid":"cc1","1":"cc1","nombrecentrocosto":"cc1","2":"'cc1'","lp":"'cc1'"},{"0":"cc2","centrocostoid":"cc2","1":"c2","nombrecentrocosto":"c2","2":"'cc2'","lp":"'cc2'"}]
                $.each(listado, function( index, value ) {
                    $('#tabla_cargoEmpleado tr:last').after('<tr class="fila_ce"><td>' + listado[index].idCargoEmpleado + '</td><td><div id="' + listado[index].idCargoEmpleado + '">' + listado[index].nombrecargoempleado + ' </div></td><td ><button type="button" style="background-color: transparent;" class="btn" name="btn_agregar_ce" id="btn_agregar_ce" onclick="agregarCE(\'' + listado[index].idCargoEmpleado + '\');"><i class="fa fa-plus" aria-hidden="true"></i></button></td></tr>');
                });
            }else{
                $('#tabla_cargoEmpleado tr:last').after('<tr class="fila_ce"><td colspan=3 >No existen Relaciones laborales para la Empresa y el cargo seleccionado</td></tr>');
            }
        }
    }
}

function agregarCE(i){
    $("#idCargoEmpleado").val(i);
    $("#nombrecargoempleado").val($("#"+i).html());
    habilitaBoton();
    $("#cerrar_cargoEmpleado").click();
}

$("#RutEmpresa").change(function()
{
    habilitaBoton();
});
*/

$(document).ready(function(){
    if ($('#progreso').attr('max') != '')
    {
        estadoGeneracionMasiva();
    }
});

function ver()
{
    document.getElementById("resultado").submit();
}

var consulta;
function estadoGeneracionMasiva()
{
    $('#estado').show();
    consultaEstado();
    consulta = setInterval(function(){ consultaEstado() }, 10000);
}

function consultaEstado()
{
    conexion=crearXMLHttpRequest();
    conexion.open('POST', 'loadUserFormularioProcessEstado.php?accion=ESTADO&IdArchivo=2',false);
    conexion.send(null);
    try
    {
        respuesta = JSON.parse(conexion.responseText);
    }
    catch (e)
    {
        respuesta.actual = 0;
    }
    respuesta.actual = respuesta.actual == null ? 0 : respuesta.actual;
    $('#progreso').val(respuesta.actual);
    $('#estadodetalle').html(respuesta.actual + " filas procesadas de un total de " +  ($('#progreso').attr('max')) + " filas.");
    if (controlMemory(respuesta.actual))
    {
        if (respuesta.actual == $('#progreso').attr('max'))
        {
            clearInterval(consulta);
            $('#estado').hide();
            alert('El proceso de generacion masiva de documentos ha finalizado.');
        }
    }
    else
    {
        matarProceso();
        clearInterval(consulta);
        $('#estado').hide();
        alert('Ha ocurrio un error, revise detalle y ejecute nuevamene las filas no procesadas.');
    }
}

function matarProceso()
{
    conexion=crearXMLHttpRequest();
    conexion.open('POST', 'loadUserFormularioProcess.php?accion=KILL',false);
    conexion.send(null);
    memoryCount = 0;
}

var memory = '';
var memoryTop = 10;
var memoryCount = 0;
function controlMemory(dato)
{
    var respuesta = true;
    if (memory == dato)
    {
     memoryCount++;
    }
    else
    {
        memoryCount = 0;
    }
    if (memoryCount >= memoryTop)
    {
        respuesta = false;
    }
    memory = dato;
    console.log(dato, memory, memoryCount, memoryTop, respuesta);
    return respuesta;
}

$("#newusuarioid").change(function(){
    $("#Documento").val('');
    $("#archivo").val('');
    var respuesta = validaRut2(document.formulario.newusuarioid);
    habilitaBoton();
});

$("#idFormulario").change(function(){
    $("#Documento").val('');
    $("#archivo").val('');
    habilitaBoton();
});

function habilitaBoton()
{
    //if( ($("#Documento").val() != '' || ($('#newusuarioid').val() != '' && $('#idFormulario').val() != 0 )) && ($("#RutEmpresa").val() != 0 && $("#idCargoEmpleado").val() != 0) )
    //if( ($("#Documento").val() != '' || ($('#newusuarioid').val() != '' && $('#idFormulario').val() != 0 )) )
    if( ($("#Documento").val() != '' || $('#newusuarioid').val() != '') && $('#idFormulario').val() != 0  )
    {
        $("#GENERAR").attr('disabled', false);
    }
    else
    {
        $("#GENERAR").attr('disabled', true);
    }
}

$("#archivo").change(function()
{
    $("#Documento").val($("#archivo").val());
    $('#newusuarioid').val('');
    //$("#idFormulario").prop("selectedIndex", 0).val(); 
    habilitaBoton();
});

function subirArchivo()
{
    if( $("#Documento").val() != '')
    {
        //revisa si hay algun cambio en el archivo
        $("#mensajeError").removeClass("callout callout-warning");
        $("#mensajeError").html("");
        MostrarCargando();
        if (validar() == true)
        {
            upload_input = document.querySelectorAll('#archivo')[0];
            uploadFile( upload_input.files[0] );
        }
    }
    else if ($('#newusuarioid').val() != '')
    {
        procesarUno();
    }
}

function validar()
{
    /*if ( $("#RutEmpresa").val() == 0 ){
        $("#RutEmpresa").focus();
        return false;
    }
    if ( $("#idTipoDoc").val() == 0 ){
        $("#mensajeError").addClass("callout callout-warning");
        $("#mensajeError").html("Seleccione el tipo de documento");
        $("#idTipoDoc").focus();
        return false;
    }
    if( $("#idProceso").val() == 0 ){
        $("#mensajeError").addClass("callout callout-warning");
        $("#mensajeError").html("Seleccione un Proceso");
        $("#idProceso").focus();
        return false;
    }
    if( $("#idPlantilla").val() == 0 ){
        $("#mensajeError").addClass("callout callout-warning");
        $("#mensajeError").html("Seleccione la plantilla");
        $("#idPlantilla").focus();
        return false;
    }
    if( $("#idFirma").val() == 0 ){
        $("#mensajeError").addClass("callout callout-warning");
        $("#mensajeError").html("Seleccione el tipo de firma del documento");
        $("#idFirma").focus();
        return false;
    }
    if( $("#Documento").val().length == 0 ){
        $("#mensajeError").addClass("callout callout-warning");
        $("#mensajeError").html("Seleccione el archivo de carga que necesita");
        $("#Documento").focus();
        return false;
    }*/
    return true;
}

function uploadFile(file)
{
    $("#GENERAR").attr('disabled', true);
    importar(file,2); //IdArchivo
}

function importar(file,IdArchivo)
{
    var xhr =  createXMLHttp();
    xhr.upload.addEventListener('loadstart',function(e)
    {
        document.getElementById('mensaje').innerHTML = 'Cargando archivo...';
    }, false);
    xhr.upload.addEventListener('load',function(e)
    {
        document.getElementById('mensaje').innerHTML = '';
    }, false);
    xhr.upload.addEventListener('error',function(e)
    {
        alert('Ha habido un error :/');
    }, false);
    var datos = $('#formulario').serialize();
    var url  = 'loadUserFormularioProcess.php?accion=LOAD&datos=' + datos + '&IdArchivo='+ IdArchivo;
    //var url  = 'loadResultadoPostulacion.php?accion=LOAD&IdArchivo='+ IdArchivo + '&RutEmpresa=' + rutempresa + '&datos=' + datos;
    xhr.open('POST',url,false);//se le agrego false para que sea sincrono, para que espere antes de comenzar a cargar el otro archivo.
    xhr.setRequestHeader("Cache-Control", "no-cache");
    xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
    xhr.setRequestHeader("X-File-Name", file.name);
    xhr.addEventListener('readystatechange', function(e) 
    {
        if( this.readyState == 4 ) 
        {
            try
            {
                respuesta = JSON.parse(xhr.responseText);
                if(IdArchivo == 2 )
                {
                    $('#progreso').attr('max', respuesta.highestRow);
                    procesar(IdArchivo);
                    estadoGeneracionMasiva();
                }
            }
            catch (e)
            {
                respuesta = xhr.responseText;
                var elementoError   = document.getElementById("mensajeError");
                elementoError.innerHTML = respuesta;
                elementoError.className += "callout callout-danger";
            }
        }
        if( IdArchivo == 2 )
        {
            document.getElementById("Documento").value = "";
            document.getElementById("archivo").value = "";
            OcultarCargando();
        } 
    });
    xhr.send(file);
}

function createXMLHttp()
{
    var xmlHttp = null; 
    if(window.XMLHttpRequest)
    {
        xmlHttp = new XMLHttpRequest();
    }
    else if(window.ActiveXObject)
    {   
        xmlHttp = new ActiveXObject("Microsoft.XMLHTTP");
    }
    return xmlHttp;
}

var ajax;
function procesarUno()
{
    //parametros = '?accion=UNO' + '&IdArchivo=2&rut=' + $('#newusuarioid').val() + '&idFormulario=' + $('#idFormulario').val() + '&RutEmpresa=' + $('#RutEmpresa').val() + '&idCargoEmpleado=' + $('#idCargoEmpleado').val();
    parametros = '?accion=UNO' + '&IdArchivo=2&rut=' + $('#newusuarioid').val() + '&idFormulario=' + $('#idFormulario').val();
    var url  = "loadUserFormularioProcess.php" + parametros;
    // Creamos el control XMLHttpRequest segun el navegador en el que estemos 
    if( window.XMLHttpRequest )
        ajax = new XMLHttpRequest(); // No Internet Explorer
    else
        ajax = new ActiveXObject("Microsoft.XMLHTTP"); // Internet Explorer
    // Almacenamos en el control al funcion que se invocara cuando la peticion
    // cambie de estado 
    ajax.onreadystatechange = funcionCallback_soloUNO;
    // Enviamos la peticion
    ajax.open( "GET", url, true );
    ajax.send( "" );
}

function funcionCallback_soloUNO()
{
    // Comprobamos si la peticion se ha completado (estado 4)
    if( ajax.readyState == 4 )
    {
        // Comprobamos si la respuesta ha sido correcta (resultado HTTP 200)
        if( ajax.status == 200 )
        {
            var salida = ajax.responseText;
            respuesta = JSON.parse(salida);
            $('#mensajeOK').removeClass();
            if (respuesta.exito)
            {
                alert(respuesta.mensaje);
            }
        }
    }
}

function procesar(IdArchivo)
{
    conexion=crearXMLHttpRequest();
    var datos = $('#formulario').serialize();
    //parametros = '?accion=LOOP0' + '&IdArchivo='+ IdArchivo + '&RutEmpresa=' + $('#RutEmpresa').val() + '&idCargoEmpleado=' + $('#idCargoEmpleado').val();
    parametros = '?accion=LOOP0' + '&IdArchivo='+ IdArchivo + '&idFormulario=' + $('#idFormulario').val();
    conexion.open('POST', 'loadUserFormularioProcess.php' + parametros);
    conexion.send(null);
    respuesta =  conexion.responseText;	
}

function crearXMLHttpRequest() 
{
    var xmlHttp=null;
    if (window.ActiveXObject) 
        xmlHttp = new ActiveXObject("Microsoft.XMLHTTP");
    else 
        if (window.XMLHttpRequest) 
            xmlHttp = new XMLHttpRequest();
    return xmlHttp;
}		
</script>