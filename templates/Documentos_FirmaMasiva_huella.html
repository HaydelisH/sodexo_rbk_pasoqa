<script type="text/javascript" src="js/libMB/json2.js"></script>     
<script type="text/javascript" src="js/libMB/jquery-2.1.4.min.js"></script>
<script type="text/javascript" src="js/libMB/blockui.js"></script>	
<script type="text/javascript" src="js/libMB/jsrasign/ext/jsbn.js"></script>
<script type="text/javascript" src="js/libMB/jsrasign/ext/jsbn2.js"></script>
<script type="text/javascript" src="js/libMB/jsrasign/ext/rsa.js"></script>
<script type="text/javascript" src="js/libMB/jsrasign/ext/rsa2.js"></script>
<script type="text/javascript" src="js/libMB/jsrasign/ext/base64.js"></script>
<script type="text/javascript" src="js/libMB/crypto/yahoo-min.js"></script>
<script type="text/javascript" src="js/libMB/crypto/core.js"></script>
<script type="text/javascript" src="js/libMB/crypto/md5.js"></script>
<script type="text/javascript" src="js/libMB/crypto/sha1.js"></script>
<script type="text/javascript" src="js/libMB/crypto/sha256.js"></script>
<script type="text/javascript" src="js/libMB/crypto/ripemd160.js"></script>
<script type="text/javascript" src="js/libMB/crypto/x64-core.js"></script>
<script type="text/javascript" src="js/libMB/crypto/sha512.js"></script>
<script type="text/javascript" src="js/libMB/jsrasign/rsapem-1.1.min.js"></script>
<script type="text/javascript" src="js/libMB/jsrasign/rsasign-1.2.min.js"></script>
<script type="text/javascript" src="js/libMB/jsrasign/asn1hex-1.1.min.js"></script>
<script type="text/javascript" src="js/libMB/jsrasign/x509-1.1.min.js"></script>
<script type="text/javascript" src="js/libMB/jsrasign/crypto-1.1.min.js"></script>
<script type="text/javascript" src="js/libMB/pluginautentiav3.js"></script>
<script type="text/javascript" src="js/libMB/multibrowser.js?=1.1"></script>   
<script type="text/javascript" src="js/libMB/bootstrap.min.js"></script>
<style type="text/css">
.responsiveContent {
  position: relative;
  height: 0;
  overflow: hidden;
 padding-bottom: 50.2%;
  margin-bottom: 20px;
}
.responsiveContent iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}
</style>
<div class="row">
  <div class="col-md-12">
    <div class="box">
      <div class="box-body pad table-responsive">
        <!--Botones de cabecera-->
		    <php:repeticion id="formulario">
    		<form role="form" name="formulario" id="formulario" action="Documentos_FirmaMasiva.php" method="POST" autocomplete="off">
          <button type="submit" class="btn btn-default"><a><i class="fa fa-arrow-left" aria-hidden="true"></i> Volver</a></button>
        </form>
          <!-- /.box-header -->
          <div class="box-body">
            <!--Mensajes-->
            <div id="mensajeOK"><php:texto id="mensajeOK" /></div>
            <div id="mensajeError"><php:texto id="mensajeError" /></div>

              <!--Formulario para procesamiento-->
              <div class="form-row">
                <form role="form" name="formulario2" id="formulario2" action="documentosdet.php" method="POST">
                  
                  <input type="hidden" name="usuarioid" id="usuarioid" value="<php:item id='usuarioid'/>" />

                  <table id="example" class="table table-bordered table-hover " name="tbltabla">
                    <thead>
                      <tr>
                        <th style="text-align: center;" data-campo="Nro Contrato">Nro Contrato</th>
                        <th style="text-align: center;" data-campo="idDocumento">idDocumento</th>
                        <th style="text-align: center;" data-campo="Tipo Documento">Tipo Documento </th>
                        <th style="text-align: center;" data-campo="Estado Contrato">Estado Contrato</th> 
                        <th style="text-align: center;" data-campo="Opciones">Opciones</th>
                      </tr>
                    </thead>
                    <tbody>
                    <!--Contenido de Tabla-->
                      <php:repeticion id="listado">
                        <tr id="fila_<php:filamenos />">
                          <td style="text-align: center;" data-campo="Nro Contrato"><input type="text" name="doc_<php:filamenos />" id="doc_<php:filamenos />" style="border:0; text-align: center;" value='<php:item id="idDocumento" />' /></td>
                          <td style="text-align: center;" data-campo="Documento"><php:item id="idDocumento_Gama" /></td>
                          <td style="text-align: center;"  data-campo="Tipo Documento"><php:item id="NombreTipoDoc" /></td>
                          <td style="text-align: center;" data-campo="Estado Contrato"><php:item id="Nombre" /></td>
                          <td style="text-align: center;" data-campo="Estado">
                              <button style="background-color: transparent;" class="btn btn-md" type="button" class="borrar" id="borrar_<php:filamenos />" onclick="eliminarDoc('<php:filamenos />');" ><i id="icon_<php:filamenos />"  class="fa fa-minus" aria-hidden="true"  title="Quitar de esta lista"></i></button>
                          </td>
                        </tr>
                      </php:repeticion>
                    </tbody>
                     <tfoot>
                      <th colspan=5 class="tabla_abajo"><div class="col-md-12" style="font-weight: normal;">
                       <span id="cant_docs"><php:item id="total_registros" /></span> Documentos a firmar 
                      </div></td>
                      </th>
                    </tfoot>
                  </table>
                </form>
              </div>
            
              <form role="form" name="actionForm" id="actionForm" action="documentosdet.php" method="POST">

                <div class="row">  
                  <php:repeticion id="botonfirma">					
                    <div class="col-lg-2 col-md-2 pull-right">
                      <button class="btn btn-md btn-primary btn-block" type="button" name="accion" id="FIRMAR_HUELLA" onclick="firmar();"/>Firmar</button>
                    </div>
                  </php:repeticion>  
                </div>
                <!--Datos necesarios para firmar con la huella-->
                <div class="row">			   
                  <input type="hidden" name="rut" 			id="rut" 			value="<php:item id="rut" />" />
                  <input type="hidden" name="auditoria" 		id="auditoria" 		value="<php:item id="auditoria" />" />
              	</div>
            </form>
        </php:repeticion>

      </div>
    </div>
  </div>
</div>

<script>

  var ajax;
  var salida;
  var fila = 0;
  var proceso;
  var cant = 0;
  var i = 0;
  var documento = 0;
  var indices = [];

  window.onload = function() {

    var cant_docs  = document.getElementById('cant_docs');
    var cant_filas = document.getElementById('example').rows.length;

    if ( cant_docs.innerHTML === '' ){
      cant_docs.innerHTML = cant_filas - 2;
    }
  };

  //Eliminar documentos de la lista 
  function eliminarDoc(i){

    var cant_filas = document.getElementById('example').rows.length;
    var form = document.getElementById('formulario');
    var cant_docs = document.getElementById('cant_docs');
    
    if( cant_filas == 3 ){
      form.submit();
    }else if( cant_filas > 3){
      document.getElementById('fila_' + i).remove();
      var fil = 0;
      fil = document.getElementById('example').rows.length;
      cant_docs.innerHTML = fil - 2;
    }        
  }

  function mostrarMensaje(mensaje){
    var error  = document.getElementById('mensajeError');
    error.classList.add("callout callout-warning");
    error.innerHTML = mensaje;
  }

  function limpiarMensajesError(){
    var error  = document.getElementById('mensajeError');
    var clase = 'callout callout-warning';
    var clase_error = document.getElementsByClassName('mensajeError');

    if( clase_error === clase ){
      error.classList.remove("callout");
      error.classList.remove("callout-warning");
      error.innerHTML = '';
    }   
  }

  function firmar(){

    MostrarCargando();

    var btn_firmar = document.getElementById('FIRMAR_HUELLA');
    var cant_filas = document.getElementById('example').rows.length;
    var tabla      = document.getElementById('example');

    cant = cant_filas - 2; 

    limpiarMensajesError();
    btn_firmar.disabled = true;

    //LLenar el arreglo de los indices de los documentos
    var n;
    for( n = 0; n < cant_filas; n++ ){     
      var indice = tabla.rows[n].id;
      var res = indice.split("_");
      if ( isInteger(res[1]) ){
         indices.push(res[1]);
      }
    }

    //Se verifica si desea firmar
    var respuesta = confirm('Esta seguro(a) que desea firmar estos documentos?');

    if ( respuesta ){
      documento = document.getElementById('doc_' + indices[i]).value;
      //Buscar el numero de auditoria
      verificarh_fm(documento,indices[i]);
    }else{
      btn_firmar.disabled = false;
      return false;
    }
  }

  //Firma huella, va al ajax
  function firma_huella(idDocumento,i){

    clearInterval(proceso);// poner esto cuando llega respuesta

    var usuarioid = document.getElementById('rut').value;
    var auditoria = document.getElementById('auditoria').value;

    var url = "Documentos_firmaMasiva6_ajax.php?idDocumento=" + idDocumento + "&usuarioid=" + usuarioid + "&auditoria=" + auditoria;

    fila = i;

     // Creamos el control XMLHttpRequest segun el navegador en el que estemos 
    if( window.XMLHttpRequest )
       ajax = new XMLHttpRequest(); // No Internet Explorer
    else
       ajax = new ActiveXObject("Microsoft.XMLHTTP"); // Internet Explorer

    // Almacenamos en el control al funcion que se invocara cuando la peticion
    ajax.onreadystatechange = funcionCallback_firma_huella;
    ajax.addEventListener("load", transferComplete);

    // Enviamos la peticion
    ajax.open( "GET", url, false);
    ajax.send( "" );

    function transferComplete(evt) {
      mostrarEstadoFirma(salida,fila);
    }
  }

  function funcionCallback_firma_huella(){

    // Comprobamos si la peticion se ha completado (estado 4)
    if( ajax.readyState == 4 )
    {
      // Comprobamos si la respuesta ha sido correcta (resultado HTTP 200)
      if( ajax.status == 200 )
      {
        // Escribimos el resultado en la pagina HTML mediante DHTML
        salida = '';
        salida = ajax.responseText;
      }
    }
  }

  //Mostrar estado de Firma en el modal
  function mostrarEstadoFirma(salida, fila){

    var icono = 'icon_' + fila; 
    var clase_minus = "fa fa-minus";
    var clase_error = 'fa fa-exclamation-triangle text-warning';
    var clase_ok    = 'fa fa-check-circle text-success';
    var resultado = document.getElementById(icono);
 
    //Error de login
    var error = salida.substring(0, 33);

    //Incrementar la fila de la tabla a recorrer
    i++;

    //Actualizamos iconos segun la respuesta 
    //Si es otro error 
    if( salida != 0 ){
    
      resultado.classList.remove("fa-minus");
      resultado.classList.add("fa-exclamation-triangle");
      resultado.classList.add("text-warning");
      resultado.title = salida;
      resultado.onclick = '';

      //Si termino de recorrer las filas 
      if( !(i < cant) ){

          //Ocultar el gif de cargando
          OcultarCargando();
          document.getElementById('auditoria').value = '';


      }//Si no, que continue con los siguientes documentos 

    }else if (salida){

      resultado.classList.remove("fa-minus");
      resultado.classList.add("fa-check-circle"); 
      resultado.classList.add("text-success");
      resultado.title = 'Firmado correctamente';
      resultado.onclick = '';

      //Si termino de recorrer las filas 
      if( !(i < cant) ){
        //Ocultar el gif de cargando
        OcultarCargando();
        document.getElementById('auditoria').value = '';
      }
      //Continua con los siguientes documentos 
    }

    //Si quedan filas que recorrer 
    if( i < cant ){
      //Pasar al siguiente
      documento = document.getElementById('doc_' + indices[i]).value;
      proceso = setInterval(function(){ firma_huella(documento,indices[i],auditoria) }, 1000);
    }
  }

</script>