<style type="text/css">
.responsiveContent {
  position: relative;
  height: 0;
  overflow: hidden;
 padding-bottom: 50.2%;
  margin-bottom: 20px;
}
.responsiveContent iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}
</style>
<div class="row">
  <div class="col-md-12">
    <div class="box">
      <div class="box-body pad table-responsive">
        <!--Botones de cabecera-->
		  <php:repeticion id="formulario">
      <div class="box-header">
  			<form role="form" name="formulario2" id="formulario2" action="Documentos_FirmaTercero.php" method="POST">
  				<input type="hidden" name="idDocumento" value="<php:item id="idDocumento" />" />
  				<button type="button" class="btn btn-default" onclick="history.back(-1)"><a><i class="fa fa-arrow-left" aria-hidden="true"></i> Volver</a></button>
  			</form>
      </div>
      <!-- /.box-header -->
      <div class="box-body">
        <!--Mensajes-->
        <div id="mensajeOK"><php:texto id="mensajeOK" /></div>
        <div id="mensajeError"><php:texto id="mensajeError" /></div>
        <!--Datos referenciales-->
        <div class="form-row">     
    
         <!--Formulario de datos propios de Clausulas-->
        <form role="form" name="formulario" id="formulario" action="Documentos_FirmaTercero.php" method="POST" autocomplete="off">

  			<div class="row">  
          <div class="col-md-2 col-md-offset-8">  
           <input type="hidden" class="form-control"  placeholder="Ingrese Rut del firmante"  name="inVerifyDocPersonalNumber" id="inVerifyDocPersonalNumber" value="<php:item id="personaid" />" >
          </div>

            <input type="hidden" name="idDocumento" value="<php:item id="idDocumento" />" />
            <input type="hidden" name="id"            id="id"           />   
            <input type="hidden" name="type"          id="type"         /> 
            <input type="hidden" name="subtype"       id="subtype"      /> 
            <input type="hidden" name="authenticated" id="authenticated"/> 
            <input type="hidden" name="sign"          id="sign"         /> 
            <input type="hidden" name="sessionid"        id="sessionid"         /> 

            
            <input type="hidden"   name="inVerifyType" id="inVerifyType" value="<php:item id="TipoFirma" />">
            <input type="hidden" name="accion" value="FIRMAR" />

          <div class="col-md-2 pull-right"> 
            <button class="btn btn-md btn-primary btn-block" onclick="verificar()" type="button" name="accion" id="btn-verify" value="FIRMAR" />Firmar</button>
          </div>
        </div>
    
  			<div class="row">  
  				<div class="col-xs-4 col-sm-offset-0 col-xs-offset-0 col-md-2 col-lg-2">												
  					<!--<label  	for="Descripcion">Ingrese PIN</label>-->					
  						<span >Nro Documento : <php:item id="idDocumento" /></span>							
  				</div>					
  		  </div>
		  
		  <div class="row">			   
			   <input type="hidden" name="idDocumento" id="idDocumento" value="<php:item id="idDocumento" />" />
				<div class="col-md-12">
					<div class="responsiveContent">
						<iframe id="ifrmArch" name="ifrmArch"  width="100%" height="600px" src="<php:item id="ruta" />" ></iframe>
					</div>
				</div>
			  </php:repeticion>  
         </div>
        </form> 

      </div>
    <!-- /.box -->
    </div>
  </div>
  <!-- /.col -->
  </div>
  <!--Tomar datos con ajax y reasigna datos de un selec a un input hidden-->

 <script type="text/javascript">
  
	var swpopup = 0;
   
   let general = {
        baseUrl: "",
        apiKey: "",
        digitalSignature: 0,
        session: {
          id: "",
          companyId: "",
          username: ""
        },
        currentAction: "VERIFY",
        operator: {
          sessionId: null
        }
      };
   
    
    let popupPage;
      let openCheckId = function(action) 
    {
		MostrarCargando();
        general.currentAction = action;
        // Create popup window
        var w = 850;
        var h = 580;

        // Fixes dual-screen position                         Most browsers      Firefox
        var dualScreenLeft = window.screenLeft != undefined ? window.screenLeft : screen.left;
        var dualScreenTop = window.screenTop != undefined ? window.screenTop : screen.top;

        var width = window.innerWidth ? window.innerWidth : document.documentElement.clientWidth ? document.documentElement.clientWidth : screen.width;
        var height = window.innerHeight ? window.innerHeight : document.documentElement.clientHeight ? document.documentElement.clientHeight : screen.height;

        var left = ((width / 2) - (w / 2)) + dualScreenLeft;
        var top = ((height / 2) - (h / 2)) + dualScreenTop;

        var opciones = "toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=yes, resizable=no, width=" + w + ", height=" + h + ", top=" + top + ", left=" + left;
        popupPage = window.open("checkid/index.html?v12", "libPage", opciones);

        var timer = setInterval(function() { 
          if(popupPage.closed) {
            clearInterval(timer);
			if( swpopup == 0 )
			{
				document.getElementById('cargando').style.display='none';
			}
          }
        }, 1000);

        // Puts focus on the popupPage
        if (window.focus) {
          popupPage.focus();
        }
      };

   
      let getParamsVerify = function() {
        return {
          action: "VERIFY",
          method: general.method,
          apiKey: general.apiKey,
          sessionId: general.session.id,
          companyId: general.session.companyId,
          operationId: 1,
          baseUrl: general.baseUrl,
		useFingerprint: true,//si pide huella al que esta verificando
		usePin: true,//si pide pin al que esta verificando
		pinRestore: true,//cambio de pin
		pinRestoreMethod:'ACEP',
          operator: {
			useFingerprint:true,
			usePin:true,
			pinRestore: true,//cambio de pin
			pinRestoreMethod:'ACEP',
            sessionId: general.operator.sessionId,
            identityDocument: {
                countryCode: general.countryCode,
                type: general.type,
                personalNumber: general.rutoperador
            }
          },
          digitalIdentity: {
            identityDocuments: [{
              countryCode: general.countryCode,
              type: general.type,
              personalNumber: general.rutaverificar
            }]
          }
          };
      };
    
    
  window.getParams = function()
  {
    return getParamsVerify();
  }
    
  //respuesta del formulario checkid
  window.callback = function(result) 
  {
	swpopup = 1;
    popupPage.close();
    console.log("callback", result);
    //document.getElementById('cargando').style.display='none';

    if (result.numError == 0) 
    {
      if (result.action == "VERIFY") 
      {
		
		try{
		
			let resultMessage = "Validación Errónea";
			if (result.data.authenticated)
			{
			  resultMessage = "Validación Exitosa!";
		  
			  general.lastVerify = result.data;
	  
			  document.getElementById('id').value       = general.lastVerify.id;
			  document.getElementById('type').value       = general.lastVerify.type;
			  document.getElementById('subtype').value      = general.lastVerify.subtype;
			  document.getElementById('authenticated').value  = general.lastVerify.authenticated;
			  document.getElementById('sign').value       = general.lastVerify.sign;      
			  document.getElementById("formulario").submit();
			
			}
			else
			{	
				document.getElementById('cargando').style.display='none';
			}
		}catch(err){
			//alert(err);
			document.getElementById('cargando').style.display='none';
		}
		
		
      }
    }
	
	if (result.numError == 0) 
	{
		//alert ("OK");
	}
	else
	{	
		document.getElementById('cargando').style.display='none';
		alert (result.numError +  " " + result.msError);
	}

    return false;
  }
    
  function verificar()
  { 
   
    buscar_tipofirma();

    var error = document.getElementById("mensajeError").innerHTML.length;
    
    if ( error == 0){
      consulta_sesion();
    }
  }
    
    
  var conexion;
      
  function crearXMLHttpRequest() 
  {
    var xmlHttp=null;
    if (window.ActiveXObject) 
      xmlHttp = new ActiveXObject("Microsoft.XMLHTTP");
    else 
    if (window.XMLHttpRequest) 
      xmlHttp = new XMLHttpRequest();
    return xmlHttp;
  }


  function consulta_sesion()
  {
    conexion=crearXMLHttpRequest();
  
    conexion.open('POST', 'consulta_sesion.php', false);
  
    conexion.send(null);
   
    // Devolvemos el resultado
    respuesta =  conexion.responseText;   
    arr_resp  = respuesta.split('|'); 
    if (arr_resp[0] == 'ok')
    {
      general.baseUrl       = arr_resp[1];
      general.session.companyId   = arr_resp[2];
      general.username      = arr_resp[4];
      general.session.id      = arr_resp[6];
      general.countryCode     = arr_resp[7];
      general.type        = arr_resp[8];
      general.apiKey        = arr_resp[9];
      general.rutoperador        = arr_resp[10];

      document.getElementById('sessionid').value =   general.session.id; //token de la sesion

      var rut           = document.getElementById('inVerifyDocPersonalNumber').value;
      general.rutaverificar   = rut.replace ("-","");
      
      general.method        = document.getElementById('inVerifyType').value;

      openCheckId("VERIFY");
    }
    else
    {
      alert (respuesta);
    }
  }


    function buscar_tipofirma(){

        var rut = document.getElementById('inVerifyDocPersonalNumber').value;
        var id = document.getElementById('idDocumento').value;
        conexion = crearXMLHttpRequest();
        conexion.onreadystatechange = funcionCallback_btf;
        conexion.open('POST', 'Documentos_FirmaTercero_ajax.php?usuarioid=' + rut + '&idDocumento=' + id, false);
        conexion.send(null);
        
    }

    function funcionCallback_btf(){

      if( conexion.readyState == 4 )
      {

        if( conexion.status == 200 )
        {

          respuesta =  conexion.responseText; 
          if ( respuesta.length < 13 )
            document.getElementById("inVerifyType").value = respuesta;
          else{
            mensajeValidacion(respuesta);
          }
        }
      }
    }
 
  
  </script>
   