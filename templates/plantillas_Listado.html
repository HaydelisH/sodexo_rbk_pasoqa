  <div class="row">
    <div class="col-md-12">
      <div class="box">
        <div class="box-body pad table-responsive">
          <div class="box-header">
            <!--Opciones del encabezado-->
            <div class="form-inline ">
              <div class="form-group">
                <form name="formulario" id="formulario_usuarios" action="Plantillas.php" method="POST" >
                  <button type="submit" class="btn btn-default" name="accion" value="AGREGAR"><a><i class="fa fa-plus" aria-hidden="true"></i> Nuevo</a></button> 
                  <input type="hidden" name="pagina"  value="<php:texto id="pagina" />" />    
                  <input type="hidden" name="nombrex" value="<php:texto id="nombrex" />" /> 
                </form>
              </div>
            </div> 
          </div>
        <div class="box-body">
          <!--Mensaje de error-->
          <div id="mensajeError"><php:texto id="mensajeError"/></div>
          <div id="mensajeOK"><php:texto id="mensajeOK" /></div>
          <!--Empresas-->
         
             <php:repeticion id="formulario">
           
      
          <!--Listado-->
         
            <div id="divtabla" class="tabla-responsiva" >
              <!--Tabla-->
              <table id="example2" class="table table-bordered table-hover" name="tbltabla">
                <thead>
                  <tr>
                    <th data-campo="IDPLANTILLA" style="text-align: center;">C&oacute;digo Plantilla </th>
                    <th data-campo="DECRIPCION_PL" style="text-align: center;">Descripci&oacute;n </th>
                    <th data-campo="TIPODOCUMENTO" style="text-align: center;">Tipo de Documento </th>
                    <th data-campo="FLUJODEFIRMA" style="text-align: center;">Flujo </th>
                    <th data-campo="CATEGORIA" style="text-align: center;">Categoria </th>
                    <th data-campo="APROBADO" style="text-align: center;"><div style="text-align: center;">Aprobado </div></th>
                    <th data-campo="ACCIONES" style="text-align: center;">Opciones </th>
                  </tr>
                </thead>
                <tbody>
                <!--Contenido de Tabla-->
                <php:repeticion id="listado">
                  <tr>
                    <td data-campo="IDPLANTILLA" style="text-align: center;"><php:item id="idPlantilla"/></td>
                    <td data-campo="DESCRIPCION_PL"><php:item id="Descripcion_Pl"/></td>
                    <td data-campo="TIPODOCUMENTO" style="text-align: center;"><php:item id="NombreTipoDoc"/></td>
					<td data-campo="FLUJODEFIRMA"><php:item id="NombreWF"/></td>
                    <td data-campo="CATEGORIA" style="text-align: center;"><php:item id="Titulo"/></td>
                    <td data-campo="APROBADO"><div style="text-align: center;" id="Aprobado_<php:filamenos />"><php:item id="Aprobado"/></div></td>
                    <td data-campo="ACCIONES">
                      <form name="formulario" id="formulario_tipo" action="Plantillas.php" method="POST">
                        <input type="hidden" name="holdingid" value="<php:item id="holdingid" />">
                        <input type="hidden" name="idPlantilla" id="idPlantilla_<php:filamenos />" value="<php:item id="idPlantilla" />">  
                     
                         <input type="hidden" id="Aprob_<php:filamenos />" value='<php:item id="Aprob"/>' />        
                         <button class="btn btn-info btn-sm openBtn2" type="button" name="accion" onclick="vistaprevia('<php:filamenos />');" id="VistaPrevia_<php:filamenos />" value="VISTAPREVIA">Detalle</button>
                        <button class="btn btn-success btn-sm" type="submit" name="accion" value="CLONAR">Clonar</button>
                        <button class="btn btn-info btn-sm" type="submit" name="accion" id="APROBAR_<php:filamenos />" value="APROBAR">Aprobar</button>
                        <button class="btn btn-primary btn-sm" type="submit" name="accion" value="MODIFICAR">Modificar</button>
                        <button class="btn btn-default btn-sm" type="button" name="accion" id="ELIMINAR" value="ELIMINAR" onclick="javascript:return consultar(<php:filamenos />);">Eliminar</button>
                       <button class="btn btn-default btn-sm" type="submit" name="accion" id="ELIMINAR_<php:filamenos />" value="ELIMINAR" style="display:none;" >Eliminar</button>
                      </form>
                    </td>
                  </tr>
                 </php:repeticion>
                 </tbody>
                </table>
              </div>
            </php:repeticion>
          </div> 
        </div>
        <!-- /.box -->
      </div>
      <!--.col-->
      </div>
    <!-- /.roe -->
    </div>
  </section> 


<!-- Modal para Vista Previa-->
 <div class="modal fade" id="ejemplo" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header" align="center">
        <h4 class="modal-title" id="ejemplo-titulo"> <!--Contenido del Titulo del Modal--></h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="ejemplo-cuerpo" align="justify" style="padding-right: 30px; padding-left: 30px;">
        <!--Contenido del Modal-->
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-secondary btn-md" data-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>


<!--Script para generar datos de Vista Previa-->
<script>
var ajax;
var salida;
 
function funcionCallback()
{
  // Comprobamos si la peticion se ha completado (estado 4)
  if( ajax.readyState == 4 )
  {
    // Comprobamos si la respuesta ha sido correcta (resultado HTTP 200)
    if( ajax.status == 200 )
    {
      // Escribimos el resultado en la pagina HTML mediante DHTML
      //document.all.salida.innerHTML = "<b>"+ajax.responseText+"</b>"; 
      salida = ajax.responseText;
      respuesta = salida.split("|");
      document.getElementById("ejemplo-titulo").innerHTML = respuesta[0];
      document.getElementById("ejemplo-cuerpo").innerHTML = respuesta[1];
      $("#ejemplo").modal({show:true});
    }
  }
}

function vistaprevia(fila)
{
  var vistaprevia = "idPlantilla_" + fila; 
  var valor = document.getElementById(vistaprevia).value; 
  var url = "Plantillas_ajax.php?idPlantilla=" + valor;

  // Creamos el control XMLHttpRequest segun el navegador en el que estemos 
  if( window.XMLHttpRequest )
    ajax = new XMLHttpRequest(); // No Internet Explorer
  else
    ajax = new ActiveXObject("Microsoft.XMLHTTP"); // Internet Explorer
 
  // Almacenamos en el control al funcion que se invocara cuando la peticion
  // cambie de estado 
  ajax.onreadystatechange = funcionCallback;

  // Enviamos la peticion
  ajax.open( "GET", url, true );
  ajax.send( "" );
}

//Bloquear boton de aprobar si ya esta aprobado
$(document).ready(function(){

  var num = $("#example2 tr").length;
  var i = 0;
  
  for( i = 0; i < num ; i++ ){

     if($("#Aprob_" + i ).val() == 1 ){
        $("#APROBAR_" + i ).attr("disabled",true);
      }
  }
});

  var i;

 function consultar(fila){

    i = fila;
 
    //Consultar si esta Plantilla existe para mas de una empresa 
    var idPlantilla = $("#idPlantilla_" + fila).val(); 

    var url = "Plantillas_ajax3.php?idPlantilla=" + idPlantilla;

    // Creamos el control XMLHttpRequest segun el navegador en el que estemos 
    if( window.XMLHttpRequest )
      ajax = new XMLHttpRequest(); // No Internet Explorer
    else
      ajax = new ActiveXObject("Microsoft.XMLHTTP"); // Internet Explorer
   
    // Almacenamos en el control al funcion que se invocara cuando la peticion
    // cambie de estado 
    ajax.onreadystatechange = funcionCallback_consultar;

    // Enviamos la peticion
    ajax.open( "GET", url, true );
    ajax.send( "" );
  }
  
  function funcionCallback_consultar()
  {
    // Comprobamos si la peticion se ha completado (estado 4)
    if( ajax.readyState == 4 )
    {
      // Comprobamos si la respuesta ha sido correcta (resultado HTTP 200)
      if( ajax.status == 200 )
      {
        // Escribimos el resultado en la pagina HTML mediante DHTML
        salida = ajax.responseText;

        var respuesta;

        if( salida == '1' ){
          respuesta = confirm("Esta Plantilla esta asociada a mas de una Empresa, desea continuar ?");          
        }else{
          respuesta = confirm("Esta seguro que desea eliminar esta Plantilla ?");
        }

        if( respuesta ) $("#ELIMINAR_" + i ).click();
        else return respuesta;
      }
    }
  }

 </script>



